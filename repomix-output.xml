This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.agents/
  skills/
    neon-postgres/
      references/
        neon-auth/
          auth-methods.md
          common-mistakes.md
          setup-nextjs.md
          setup-react-spa.md
          ui-components.md
        neon-js/
          common-mistakes.md
          data-api.md
        neon-rest-api/
          branches.md
          endpoints.md
          guidelines.md
          keys.md
          operations.md
          organizations.md
          projects.md
        connection-methods.md
        devtools.md
        features.md
        getting-started.md
        neon-auth.md
        neon-cli.md
        neon-drizzle.md
        neon-js.md
        neon-platform-api.md
        neon-python-sdk.md
        neon-serverless.md
        neon-typescript-sdk.md
        referencing-docs.md
        what-is-neon.md
      SKILL.md
prisma/
  migrations/
    20260202125952_init/
      migration.sql
    migration_lock.toml
  schema.prisma
public/
  file.svg
  globe.svg
  next.svg
  vercel.svg
  window.svg
src/
  app/
    admin/
      consultas/
        page.jsx
      dashboard/
        page.jsx
      login/
        page.jsx
      vehiculos/
        [id]/
          editar/
            page.jsx
          imagenes/
            page.jsx
        nuevo/
          page.jsx
        page.jsx
    api/
      auth/
        login/
          route.js
        logout/
          route.js
        a
      consultas/
        [id]/
          route.js
        route.js
      test/
        route.js
      upload/
        route.js
      vehiculos/
        [id]/
          imagenes/
            [imagenId]/
              route.js
            route.js
          route.js
        route.js
    catalogo/
      page.jsx
    favicon.ico
    globals.css
    layout.js
    page.js
  lib/
    auth.js
    cloudinary.js
    prisma.js
  proxy.js
.gitignore
eslint.config.mjs
jsconfig.json
next.config.mjs
package.json
postcss.config.mjs
README.md
tsconfig.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".agents/skills/neon-postgres/references/neon-auth/auth-methods.md">
# Neon Auth - Auth Methods Reference

Complete reference for authentication methods, session management, and error handling.

## Auth Methods

### Sign Up

```typescript
await auth.signUp.email({
  email: "user@example.com",
  password: "securepassword",
  name: "John Doe", // Optional
});
```

### Sign In

```typescript
// Email/password
await auth.signIn.email({
  email: "user@example.com",
  password: "securepassword",
});

// Social (Google, GitHub)
await auth.signIn.social({
  provider: "google", // or "github"
  callbackURL: "/dashboard",
});
```

### Sign Out

```typescript
await auth.signOut();
```

### Get Session

```typescript
// Async (Node.js, server components)
const session = await auth.getSession();

// React hook (client components)
const session = auth.useSession();
// Returns: { data: Session | null, isPending: boolean }
```

## Session Data Structure

```typescript
interface Session {
  user: {
    id: string;
    name: string | null;
    email: string;
    image: string | null;
    emailVerified: boolean;
    createdAt: Date;
    updatedAt: Date;
  };
  session: {
    id: string;
    expiresAt: Date;
    token: string;
    createdAt: Date;
    updatedAt: Date;
    userId: string;
  };
}
```

## Error Handling

```typescript
const { error } = await auth.signIn.email({ email, password });

if (error) {
  switch (error.code) {
    case "INVALID_EMAIL_OR_PASSWORD":
      showError("Invalid email or password");
      break;
    case "EMAIL_NOT_VERIFIED":
      showError("Please verify your email");
      break;
    case "USER_NOT_FOUND":
      showError("User not found");
      break;
    case "TOO_MANY_REQUESTS":
      showError("Too many attempts. Please wait.");
      break;
    default:
      showError("Authentication failed");
  }
}
```

## Building Auth Pages

### Use AuthView (Recommended for React Apps)

For authentication pages, use the pre-built `AuthView` component instead of building custom forms.

**What AuthView provides:**

- Sign-in, sign-up, password reset, magic link pages
- Social providers (Google, GitHub) - requires TWO configurations: enable in Neon Console AND add `social` prop to NeonAuthUIProvider
- Form validation, error handling, loading states
- Consistent styling via CSS variables

**Setup (Next.js App Router):**

1. **Import CSS** (in `app/layout.tsx` or `app/globals.css`):

```tsx
import "@neondatabase/auth/ui/css";
```

2. **Wrap app with provider** (create `app/auth-provider.tsx`):

```tsx
"use client";
import { NeonAuthUIProvider } from "@neondatabase/auth/react/ui";
import { authClient } from "@/lib/auth/client";
import { useRouter } from "next/navigation";
import Link from "next/link";

export function AuthProvider({ children }: { children: React.ReactNode }) {
  const router = useRouter();
  return (
    <NeonAuthUIProvider
      authClient={authClient}
      navigate={router.push}
      replace={router.replace}
      onSessionChange={() => router.refresh()}
      Link={Link}
    >
      {children}
    </NeonAuthUIProvider>
  );
}
```

3. **Create auth page** (`app/auth/[path]/page.tsx`):

```tsx
import { AuthView } from "@neondatabase/auth/react/ui";
import { authViewPaths } from "@neondatabase/auth/react/ui/server";

export function generateStaticParams() {
  return Object.values(authViewPaths).map((path) => ({ path }));
}

export default async function AuthPage({
  params,
}: {
  params: Promise<{ path: string }>;
}) {
  const { path } = await params;
  return <AuthView pathname={path} />;
}
```

**Result:** You now have `/auth/sign-in`, `/auth/sign-up`, `/auth/forgot-password`, etc.

**Available paths:** `"sign-in"`, `"sign-up"`, `"forgot-password"`, `"reset-password"`, `"magic-link"`, `"two-factor"`, `"callback"`, `"sign-out"`

### When to Use Low-Level Methods Instead

Use `authClient.signIn.email()`, `authClient.signUp.email()` directly if:

- **Node.js backend** - No React, server-side auth only
- **Custom design system** - Your design team provides form components
- **Mobile/CLI apps** - Non-web frontends
- **Headless auth** - Testing or non-standard flows

For standard React web apps, **use AuthView**.

### Common Anti-Pattern

```tsx
// ❌ Don't build custom forms unless you have specific requirements
function CustomSignInPage() {
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [error, setError] = useState("");
  const [loading, setLoading] = useState(false);

  const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);
    const { error } = await authClient.signIn.email({ email, password });
    if (error) setError(error.message);
    setLoading(false);
  };

  // ... 50+ more lines of form JSX, validation, error display
}

// ✅ Use AuthView instead - one component handles everything
<AuthView pathname="sign-in" />;
```

## Styling

Neon Auth UI **automatically inherits your app's existing theme**. If you have CSS variables like `--primary`, `--background`, etc. defined (from Tailwind, shadcn/ui, or custom CSS), auth components use them with no configuration.

**Key features:**

- **Automatic inheritance**: Uses your existing `--primary`, `--background`, etc.
- **No conflicts**: Auth styles are in `@layer neon-auth`, so your styles always win
- **Import order doesn't matter**: CSS layers handle priority automatically

### Integration with shadcn/ui

If you use shadcn/ui or similar libraries that define `--primary`, `--background`, etc., Neon Auth will automatically inherit those colors. No additional configuration needed.

### Use Existing CSS Variables

When creating custom components, use CSS variables for consistency:

| Variable                            | Purpose                 |
| ----------------------------------- | ----------------------- |
| `--background`, `--foreground`      | Page background/text    |
| `--card`, `--card-foreground`       | Card surfaces           |
| `--primary`, `--primary-foreground` | Primary buttons/actions |
| `--muted`, `--muted-foreground`     | Muted/subtle elements   |
| `--border`, `--ring`                | Borders and focus rings |
| `--radius`                          | Border radius           |

### Auth-Specific Customization

To customize auth components differently from your main app, use `--neon-*` prefix:

```css
:root {
  --primary: oklch(0.55 0.25 250); /* Your app's blue */
  --neon-primary: oklch(0.55 0.18 145); /* Auth uses green */
}
```
</file>

<file path=".agents/skills/neon-postgres/references/neon-auth/common-mistakes.md">
# Neon Auth - Common Mistakes

Reference guide for common mistakes when using `@neondatabase/auth` or `@neondatabase/neon-js`.

## Import Mistakes

### BetterAuthReactAdapter Subpath Requirement

`BetterAuthReactAdapter` is **NOT** exported from the main package entry. You must import it from the subpath.

**Wrong:**

```typescript
// These will NOT work
import { BetterAuthReactAdapter } from "@neondatabase/neon-js";
import { BetterAuthReactAdapter } from "@neondatabase/auth";
```

**Correct:**

```typescript
// For @neondatabase/neon-js
import { BetterAuthReactAdapter } from "@neondatabase/neon-js/auth/react/adapters";

// For @neondatabase/auth
import { BetterAuthReactAdapter } from "@neondatabase/auth/react/adapters";
```

**Why:** The React adapter has React-specific dependencies and is tree-shaken out of the main bundle. Using subpath exports keeps the main bundle smaller for non-React environments.

### Adapter Factory Functions

All adapters are **factory functions** that must be called with `()`.

**Wrong:**

```typescript
const client = createClient({
  auth: {
    adapter: BetterAuthReactAdapter, // Missing ()
    url: process.env.NEON_AUTH_URL!,
  },
  dataApi: { url: process.env.NEON_DATA_API_URL! },
});
```

**Correct:**

```typescript
const client = createClient({
  auth: {
    adapter: BetterAuthReactAdapter(), // Called as function
    url: process.env.NEON_AUTH_URL!,
  },
  dataApi: { url: process.env.NEON_DATA_API_URL! },
});
```

This applies to all adapters:

- `BetterAuthReactAdapter()`
- `BetterAuthVanillaAdapter()`
- `SupabaseAuthAdapter()`

---

## CSS Import Mistakes

Auth UI components require CSS. Choose **ONE** method based on your project.

### With Tailwind v4

```css
/* In app/globals.css */
@import "tailwindcss";
@import "@neondatabase/neon-js/ui/tailwind";
/* Or: @import '@neondatabase/auth/ui/tailwind'; */
```

### Without Tailwind

```typescript
// In app/layout.tsx
import "@neondatabase/neon-js/ui/css";
// Or: import "@neondatabase/auth/ui/css";
```

### Never Import Both

**Wrong:**

```css
/* Causes ~94KB of duplicate styles */
@import "@neondatabase/neon-js/ui/css";
@import "@neondatabase/neon-js/ui/tailwind";
```

**Why:** The `ui/css` import includes pre-built CSS (~47KB). The `ui/tailwind` import provides Tailwind tokens (~2KB) that generate similar styles. Using both doubles your CSS bundle.

---

## Configuration Mistakes

### Wrong createAuthClient Signature

The `createAuthClient` function takes the URL as the first argument, not as a property in an options object.

**Wrong:**

```typescript
// This will NOT work
createAuthClient({ baseURL: url });
createAuthClient({ url: myUrl });
```

**Correct:**

```typescript
// Vanilla client - URL as first arg
createAuthClient(url);

// With adapter - URL as first arg, options as second
createAuthClient(url, { adapter: BetterAuthReactAdapter() });

// Next.js client - no arguments (uses env vars automatically)
import { createAuthClient } from "@neondatabase/auth/next";
const authClient = createAuthClient();
```

### Missing Environment Variables

**Required for Next.js:**

```bash
# .env.local
NEON_AUTH_BASE_URL=https://ep-xxx.neonauth.c-2.us-east-2.aws.neon.build/dbname/auth
NEXT_PUBLIC_NEON_AUTH_URL=https://ep-xxx.neonauth.c-2.us-east-2.aws.neon.build/dbname/auth

# For neon-js (auth + data)
NEON_DATA_API_URL=https://ep-xxx.apirest.c-2.us-east-2.aws.neon.build/dbname/rest/v1
```

**Required for Vite/React SPA:**

```bash
# .env
VITE_NEON_AUTH_URL=https://ep-xxx.neonauth.c-2.us-east-2.aws.neon.build/dbname/auth
VITE_NEON_DATA_API_URL=https://ep-xxx.apirest.c-2.us-east-2.aws.neon.build/dbname/rest/v1
```

**Important:**

- `NEON_AUTH_BASE_URL` - Server-side auth
- `NEXT_PUBLIC_*` prefix - Required for client-side access in Next.js
- `VITE_*` prefix - Required for client-side access in Vite
- Restart dev server after adding env vars

---

## Usage Mistakes

### Missing "use client" Directive

Client components using `useSession()` need the `"use client"` directive.

**Wrong:**

```typescript
// Missing directive - will cause hydration errors
import { authClient } from "@/lib/auth/client";

function AuthStatus() {
  const session = authClient.useSession();
  // ...
}
```

**Correct:**

```typescript
"use client";

import { authClient } from "@/lib/auth/client";

function AuthStatus() {
  const session = authClient.useSession();
  // ...
}
```

### Wrong API for Adapter

Each adapter has its own API style. Don't mix them.

**Wrong - BetterAuth API with SupabaseAuthAdapter:**

```typescript
const client = createClient({
  auth: { adapter: SupabaseAuthAdapter(), url },
  dataApi: { url },
});

// This won't work with SupabaseAuthAdapter
await client.auth.signIn.email({ email, password });
```

**Correct - Supabase API with SupabaseAuthAdapter:**

```typescript
const client = createClient({
  auth: { adapter: SupabaseAuthAdapter(), url },
  dataApi: { url },
});

// Use Supabase-style methods
await client.auth.signInWithPassword({ email, password });
```

**API Reference by Adapter:**

| Adapter                  | Sign In                                   | Sign Up                             | Get Session                     |
| ------------------------ | ----------------------------------------- | ----------------------------------- | ------------------------------- |
| BetterAuthVanillaAdapter | `signIn.email({ email, password })`       | `signUp.email({ email, password })` | `getSession()`                  |
| BetterAuthReactAdapter   | `signIn.email({ email, password })`       | `signUp.email({ email, password })` | `useSession()` / `getSession()` |
| SupabaseAuthAdapter      | `signInWithPassword({ email, password })` | `signUp({ email, password })`       | `getSession()`                  |
</file>

<file path=".agents/skills/neon-postgres/references/neon-auth/setup-nextjs.md">
# Neon Auth Setup - Next.js App Router

Complete setup instructions for Neon Auth in Next.js App Router applications.

---

## 1. Install Package

```bash
npm install @neondatabase/auth
# Or: npm install @neondatabase/neon-js
```

## 2. Environment Variables

Create or update `.env.local`:

```bash
NEON_AUTH_BASE_URL=https://ep-xxx.neonauth.c-2.us-east-2.aws.neon.build/dbname/auth
NEXT_PUBLIC_NEON_AUTH_URL=https://ep-xxx.neonauth.c-2.us-east-2.aws.neon.build/dbname/auth
```

**Important:** Both variables are needed:

- `NEON_AUTH_BASE_URL` - Used by server-side API routes
- `NEXT_PUBLIC_NEON_AUTH_URL` - Used by client-side components (prefixed with NEXT*PUBLIC*)

**Where to find your Auth URL:**

1. Go to your Neon project dashboard
2. Navigate to the "Auth" tab
3. Copy the Auth URL

## 3. API Route Handler

Create `app/api/auth/[...path]/route.ts`:

```typescript
import { authApiHandler } from "@neondatabase/auth/next";
// Or: import { authApiHandler } from "@neondatabase/neon-js/auth/next";

export const { GET, POST } = authApiHandler();
```

This creates endpoints for:

- `/api/auth/sign-in` - Sign in
- `/api/auth/sign-up` - Sign up
- `/api/auth/sign-out` - Sign out
- `/api/auth/session` - Get session
- And other auth-related endpoints

## 4. Auth Client Configuration

Create `lib/auth/client.ts`:

```typescript
import { createAuthClient } from "@neondatabase/auth/next";
// Or: import { createAuthClient } from "@neondatabase/neon-js/auth/next";

export const authClient = createAuthClient();
```

## 5. Use in Components

```typescript
"use client";

import { authClient } from "@/lib/auth/client";

function AuthStatus() {
  const session = authClient.useSession();

  if (session.isPending) return <div>Loading...</div>;
  if (!session.data) return <SignInButton />;

  return (
    <div>
      <p>Hello, {session.data.user.name}</p>
      <button onClick={() => authClient.signOut()}>Sign Out</button>
    </div>
  );
}

function SignInButton() {
  return (
    <button onClick={() => authClient.signIn.email({
      email: "user@example.com",
      password: "password"
    })}>
      Sign In
    </button>
  );
}
```

## 6. UI Provider Setup (Optional)

For pre-built UI components (AuthView, UserButton, etc.), see `ui-components.md`.

---

## Package Selection

| Need                    | Package                 | Bundle Size     |
| ----------------------- | ----------------------- | --------------- |
| Auth only               | `@neondatabase/auth`    | Smaller (~50KB) |
| Auth + Database queries | `@neondatabase/neon-js` | Full (~150KB)   |

**Recommendation:** Use `@neondatabase/auth` if you only need authentication. Use `@neondatabase/neon-js` if you also need PostgREST-style database queries.
</file>

<file path=".agents/skills/neon-postgres/references/neon-auth/setup-react-spa.md">
# Neon Auth Setup - React SPA (Vite)

Complete setup instructions for Neon Auth in React Single Page Applications (Vite, Create React App, etc.).

---

## 1. Install Package

```bash
npm install @neondatabase/auth
# Or: npm install @neondatabase/neon-js
npm install react-router-dom  # Required for UI components
```

## 2. Environment Variables

Create or update `.env`:

**For Vite:**

```bash
VITE_NEON_AUTH_URL=https://ep-xxx.neonauth.c-2.us-east-2.aws.neon.build/dbname/auth
```

**For Create React App:**

```bash
REACT_APP_NEON_AUTH_URL=https://ep-xxx.neonauth.c-2.us-east-2.aws.neon.build/dbname/auth
```

**Where to find your Auth URL:**

1. Go to your Neon project dashboard
2. Navigate to the "Auth" tab
3. Copy the Auth URL

## 3. Auth Client Configuration

Create `src/lib/auth-client.ts`:

**For `@neondatabase/auth`:**

```typescript
import { createAuthClient } from "@neondatabase/auth";
import { BetterAuthReactAdapter } from "@neondatabase/auth/react/adapters";

export const authClient = createAuthClient(import.meta.env.VITE_NEON_AUTH_URL, {
  adapter: BetterAuthReactAdapter(),
});
```

**For `@neondatabase/neon-js`:**

```typescript
import { createClient } from "@neondatabase/neon-js";
import { BetterAuthReactAdapter } from "@neondatabase/neon-js/auth/react/adapters";

export const client = createClient({
  auth: {
    adapter: BetterAuthReactAdapter(),
    url: import.meta.env.VITE_NEON_AUTH_URL,
  },
  dataApi: {
    url: import.meta.env.VITE_NEON_DATA_API_URL,
  },
});

export const authClient = client.auth;
```

**Critical:**

- `BetterAuthReactAdapter` must be imported from the `/react/adapters` subpath
- The adapter must be called as a function: `BetterAuthReactAdapter()`

## 4. Use in Components

```typescript
import { authClient } from "./lib/auth-client";

function App() {
  const session = authClient.useSession();

  if (session.isPending) return <div>Loading...</div>;
  if (!session.data) return <LoginForm />;

  return <Dashboard user={session.data.user} />;
}
```

---

## 5. UI Provider Setup (Optional)

Skip this section if you're building custom auth forms. Use this if you want pre-built UI components.

### 5a. Import CSS

**CRITICAL:** Choose ONE import method. Never import both - it causes duplicate styles.

**Check if the project uses Tailwind CSS** by looking for:

- `tailwind.config.js` or `tailwind.config.ts` in the project root
- `@import 'tailwindcss'` or `@tailwind` directives in CSS files
- `tailwindcss` in package.json dependencies

**If NOT using Tailwind** - Add to `src/main.tsx` or entry point:

```typescript
import "@neondatabase/auth/ui/css";
```

**If using Tailwind CSS v4** - Add to main CSS file (e.g., index.css):

```css
@import "tailwindcss";
@import "@neondatabase/auth/ui/tailwind";
```

### 5b. Update main.tsx with BrowserRouter

```tsx
import { createRoot } from "react-dom/client";
import { BrowserRouter } from "react-router-dom";
import "@neondatabase/auth/ui/css"; // if not using Tailwind
import App from "./App";
import { Providers } from "./providers";

createRoot(document.getElementById("root")!).render(
  <BrowserRouter>
    <Providers>
      <App />
    </Providers>
  </BrowserRouter>,
);
```

### 5c. Create Auth Provider

Create `src/providers.tsx`:

```tsx
import { NeonAuthUIProvider } from "@neondatabase/auth/react/ui";
import { useNavigate, Link as RouterLink } from "react-router-dom";
import { authClient } from "./lib/auth-client";
import type { ReactNode } from "react";

// Adapter for react-router-dom Link
function Link({
  href,
  ...props
}: { href: string } & React.AnchorHTMLAttributes<HTMLAnchorElement>) {
  return <RouterLink to={href} {...props} />;
}

export function Providers({ children }: { children: ReactNode }) {
  const navigate = useNavigate();

  return (
    <NeonAuthUIProvider
      authClient={authClient}
      navigate={(path) => navigate(path)}
      replace={(path) => navigate(path, { replace: true })}
      onSessionChange={() => {
        // Optional: refresh data or invalidate cache
      }}
      Link={Link}
      social={{
        providers: ["google", "github"],
      }}
    >
      {children}
    </NeonAuthUIProvider>
  );
}
```

**Provider props explained:**

- `navigate`: Function to navigate to a new route
- `replace`: Function to replace current route (for redirects)
- `onSessionChange`: Callback when auth state changes (useful for cache invalidation)
- `Link`: Adapter component for react-router-dom's Link
- `social`: Show Google and GitHub sign-in buttons (both enabled by default in Neon)

### 5d. Add Routes to App.tsx

```tsx
import { Routes, Route, useParams } from "react-router-dom";
import {
  AuthView,
  UserButton,
  SignedIn,
  SignedOut,
} from "@neondatabase/auth/react/ui";

// Auth page - handles /auth/sign-in, /auth/sign-up, etc.
function AuthPage() {
  const { pathname } = useParams();
  return (
    <div className="flex min-h-screen items-center justify-center">
      <AuthView pathname={pathname} />
    </div>
  );
}

// Simple navbar example
function Navbar() {
  return (
    <nav className="flex items-center justify-between p-4 border-b">
      <a href="/">My App</a>
      <div className="flex items-center gap-4">
        <SignedOut>
          <a href="/auth/sign-in">Sign In</a>
        </SignedOut>
        <SignedIn>
          <UserButton />
        </SignedIn>
      </div>
    </nav>
  );
}

function HomePage() {
  return <div>Welcome to My App!</div>;
}

export default function App() {
  return (
    <>
      <Navbar />
      <Routes>
        <Route path="/" element={<HomePage />} />
        <Route path="/auth/:pathname" element={<AuthPage />} />
      </Routes>
    </>
  );
}
```

**Auth routes created:**

- `/auth/sign-in` - Sign in page
- `/auth/sign-up` - Sign up page
- `/auth/forgot-password` - Password reset request
- `/auth/reset-password` - Set new password
- `/auth/sign-out` - Sign out
- `/auth/callback` - OAuth callback (internal)
</file>

<file path=".agents/skills/neon-postgres/references/neon-auth/ui-components.md">
# Neon Auth - UI Components Reference

Pre-built UI components for authentication flows.

## Available Components

- `AuthView` - Complete auth pages (sign-in, sign-up, forgot-password, etc.) - **use this first**
- `SignedIn` / `SignedOut` - Conditional rendering based on auth state
- `UserButton` - User avatar with dropdown menu
- `NeonAuthUIProvider` - Required wrapper for UI components

## CSS Import

**CRITICAL:** Choose ONE import method. Never import both.

**Without Tailwind:**

```typescript
// In app/layout.tsx or entry point
import "@neondatabase/auth/ui/css";
```

**With Tailwind v4:**

```css
/* In app/globals.css */
@import "tailwindcss";
@import "@neondatabase/auth/ui/tailwind";
```

## NeonAuthUIProvider Setup

### Next.js App Router

```tsx
"use client";
import { NeonAuthUIProvider } from "@neondatabase/auth/react/ui";
import { authClient } from "@/lib/auth/client";
import { useRouter } from "next/navigation";
import Link from "next/link";

export function AuthProvider({ children }: { children: React.ReactNode }) {
  const router = useRouter();
  return (
    <NeonAuthUIProvider
      authClient={authClient}
      navigate={router.push}
      replace={router.replace}
      onSessionChange={() => router.refresh()}
      Link={Link}
      social={{
        providers: ["google", "github"],
      }}
    >
      {children}
    </NeonAuthUIProvider>
  );
}
```

### React SPA with react-router-dom

```tsx
import { NeonAuthUIProvider } from "@neondatabase/auth/react/ui";
import { useNavigate, Link as RouterLink } from "react-router-dom";
import { authClient } from "./lib/auth-client";

function Link({
  href,
  ...props
}: { href: string } & React.AnchorHTMLAttributes<HTMLAnchorElement>) {
  return <RouterLink to={href} {...props} />;
}

export function Providers({ children }: { children: React.ReactNode }) {
  const navigate = useNavigate();

  return (
    <NeonAuthUIProvider
      authClient={authClient}
      navigate={(path) => navigate(path)}
      replace={(path) => navigate(path, { replace: true })}
      onSessionChange={() => {}}
      Link={Link}
      social={{
        providers: ["google", "github"],
      }}
    >
      {children}
    </NeonAuthUIProvider>
  );
}
```

## AuthView Component

Renders complete authentication pages.

### Next.js App Router

Create `app/auth/[path]/page.tsx`:

```tsx
import { AuthView } from "@neondatabase/auth/react/ui";
import { authViewPaths } from "@neondatabase/auth/react/ui/server";

export function generateStaticParams() {
  return Object.values(authViewPaths).map((path) => ({ path }));
}

export default async function AuthPage({
  params,
}: {
  params: Promise<{ path: string }>;
}) {
  const { path } = await params;
  return <AuthView pathname={path} />;
}
```

### React SPA

```tsx
import { Routes, Route, useParams } from "react-router-dom";
import { AuthView } from "@neondatabase/auth/react/ui";

function AuthPage() {
  const { pathname } = useParams();
  return (
    <div className="flex min-h-screen items-center justify-center">
      <AuthView pathname={pathname} />
    </div>
  );
}

export default function App() {
  return (
    <Routes>
      <Route path="/" element={<HomePage />} />
      <Route path="/auth/:pathname" element={<AuthPage />} />
    </Routes>
  );
}
```

### Available Auth Paths

| Path              | Purpose                   |
| ----------------- | ------------------------- |
| `sign-in`         | Sign in page              |
| `sign-up`         | Sign up page              |
| `forgot-password` | Password reset request    |
| `reset-password`  | Set new password          |
| `magic-link`      | Magic link sign in        |
| `two-factor`      | Two-factor authentication |
| `callback`        | OAuth callback (internal) |
| `sign-out`        | Sign out                  |

## SignedIn / SignedOut Components

Conditional rendering based on authentication state.

```tsx
import { SignedIn, SignedOut, UserButton } from "@neondatabase/auth/react/ui";

function Navbar() {
  return (
    <nav>
      <SignedOut>
        <a href="/auth/sign-in">Sign In</a>
        <a href="/auth/sign-up">Sign Up</a>
      </SignedOut>
      <SignedIn>
        <UserButton />
      </SignedIn>
    </nav>
  );
}
```

## UserButton Component

Displays user avatar with dropdown menu for account management.

```tsx
import { UserButton } from "@neondatabase/auth/react/ui";

function Header() {
  return (
    <header>
      <h1>My App</h1>
      <UserButton />
    </header>
  );
}
```

## Social Login Configuration

**Important:** Social providers require TWO configurations:

1. **Enable in Neon Console** - Go to your project's Auth settings
2. **Add to NeonAuthUIProvider** - Pass `social` prop

```tsx
<NeonAuthUIProvider
  authClient={authClient}
  // ... other props
  social={{
    providers: ['google', 'github']
  }}
>
```

Without both configurations, social login buttons won't appear.
</file>

<file path=".agents/skills/neon-postgres/references/neon-js/common-mistakes.md">
# Neon JS - Common Mistakes

Reference guide for common mistakes when using `@neondatabase/neon-js`.

## Import Mistakes

### BetterAuthReactAdapter Subpath Requirement

`BetterAuthReactAdapter` is **NOT** exported from the main package entry.

**Wrong:**

```typescript
import { BetterAuthReactAdapter } from "@neondatabase/neon-js";
```

**Correct:**

```typescript
import { BetterAuthReactAdapter } from "@neondatabase/neon-js/auth/react/adapters";
```

### Adapter Factory Functions

All adapters must be called with `()`.

**Wrong:**

```typescript
const client = createClient({
  auth: {
    adapter: BetterAuthReactAdapter, // Missing ()
    url: process.env.NEON_AUTH_URL!,
  },
  dataApi: { url: process.env.NEON_DATA_API_URL! },
});
```

**Correct:**

```typescript
const client = createClient({
  auth: {
    adapter: BetterAuthReactAdapter(), // Called as function
    url: process.env.NEON_AUTH_URL!,
  },
  dataApi: { url: process.env.NEON_DATA_API_URL! },
});
```

---

## CSS Import Mistakes

Choose **ONE** CSS import method:

**With Tailwind v4:**

```css
@import "tailwindcss";
@import "@neondatabase/neon-js/ui/tailwind";
```

**Without Tailwind:**

```typescript
import "@neondatabase/neon-js/ui/css";
```

**Never import both** - causes duplicate styles.

---

## Environment Variables

**Required for Next.js:**

```bash
# .env.local
NEON_AUTH_BASE_URL=https://ep-xxx.neonauth.c-2.us-east-2.aws.neon.build/dbname/auth
NEXT_PUBLIC_NEON_AUTH_URL=https://ep-xxx.neonauth.c-2.us-east-2.aws.neon.build/dbname/auth
NEON_DATA_API_URL=https://ep-xxx.apirest.c-2.us-east-2.aws.neon.build/dbname/rest/v1
```

**Required for Vite/React SPA:**

```bash
# .env
VITE_NEON_AUTH_URL=https://ep-xxx.neonauth.c-2.us-east-2.aws.neon.build/dbname/auth
VITE_NEON_DATA_API_URL=https://ep-xxx.apirest.c-2.us-east-2.aws.neon.build/dbname/rest/v1
```

---

## Usage Mistakes

### Missing "use client" Directive

```typescript
"use client"; // Required!

import { authClient } from "@/lib/auth/client";

function AuthStatus() {
  const session = authClient.useSession();
  // ...
}
```

### Wrong API for Adapter

| Adapter                | Sign In                                   | Sign Up                             |
| ---------------------- | ----------------------------------------- | ----------------------------------- |
| BetterAuthReactAdapter | `signIn.email({ email, password })`       | `signUp.email({ email, password })` |
| SupabaseAuthAdapter    | `signInWithPassword({ email, password })` | `signUp({ email, password })`       |

### Using neon-js for Auth Only

If you only need auth (no database queries), use `@neondatabase/auth` for smaller bundle size:

```bash
# Auth only - smaller bundle
npm install @neondatabase/auth

# Auth + Data API - full SDK
npm install @neondatabase/neon-js
```
</file>

<file path=".agents/skills/neon-postgres/references/neon-js/data-api.md">
# Neon JS Data API Reference

Complete reference for PostgREST-style database queries using `@neondatabase/neon-js`.

## Client Setup

### Next.js

```typescript
// lib/db/client.ts
import { createClient } from "@neondatabase/neon-js";
import type { Database } from "./database.types";

export const dbClient = createClient<Database>({
  auth: { url: process.env.NEXT_PUBLIC_NEON_AUTH_URL! },
  dataApi: { url: process.env.NEON_DATA_API_URL! },
});
```

### React SPA

```typescript
import { createClient } from "@neondatabase/neon-js";
import { BetterAuthReactAdapter } from "@neondatabase/neon-js/auth/react/adapters";

const client = createClient<Database>({
  auth: {
    adapter: BetterAuthReactAdapter(),
    url: import.meta.env.VITE_NEON_AUTH_URL,
  },
  dataApi: { url: import.meta.env.VITE_NEON_DATA_API_URL },
});
```

### Node.js Backend

```typescript
import { createClient } from "@neondatabase/neon-js";

const client = createClient<Database>({
  auth: { url: process.env.NEON_AUTH_URL! },
  dataApi: { url: process.env.NEON_DATA_API_URL! },
});
```

---

## Query Patterns

All query methods follow PostgREST syntax (same as Supabase).

### Select Queries

**Basic select:**

```typescript
const { data, error } = await client.from("items").select();
```

**Select specific columns:**

```typescript
const { data } = await client.from("items").select("id, name, status");
```

**Select with filters:**

```typescript
const { data } = await client
  .from("items")
  .select("id, name, status")
  .eq("status", "active")
  .order("created_at", { ascending: false })
  .limit(10);
```

**Select single row:**

```typescript
const { data, error } = await client
  .from("items")
  .select("*")
  .eq("id", 1)
  .single();
```

### Insert

**Insert single row:**

```typescript
const { data, error } = await client
  .from("items")
  .insert({ name: "New Item", status: "pending" })
  .select()
  .single();
```

**Insert multiple rows:**

```typescript
const { data, error } = await client
  .from("items")
  .insert([
    { name: "Item 1", status: "pending" },
    { name: "Item 2", status: "pending" },
  ])
  .select();
```

### Update

**Update with filter:**

```typescript
await client.from("items").update({ status: "completed" }).eq("id", 1);
```

**Update and return data:**

```typescript
const { data, error } = await client
  .from("items")
  .update({ status: "completed" })
  .eq("id", 1)
  .select()
  .single();
```

### Delete

**Delete single row:**

```typescript
await client.from("items").delete().eq("id", 1);
```

**Delete and return data:**

```typescript
const { data, error } = await client
  .from("items")
  .delete()
  .eq("id", 1)
  .select()
  .single();
```

### Upsert

```typescript
await client
  .from("items")
  .upsert({ id: 1, name: "Updated Item", status: "active" });
```

---

## Filtering

### Comparison Operators

```typescript
// Equal
.eq("status", "active")

// Not equal
.neq("status", "archived")

// Greater than
.gt("price", 100)

// Greater than or equal
.gte("price", 100)

// Less than
.lt("price", 100)

// Less than or equal
.lte("price", 100)

// Like (pattern matching)
.like("name", "%item%")

// ILike (case-insensitive)
.ilike("name", "%item%")

// Is null
.is("deleted_at", null)

// Is not null
.not("deleted_at", "is", null)

// In array
.in("status", ["active", "pending"])

// Contains (for arrays/JSONB)
.contains("tags", ["important"])
```

### Logical Operators

```typescript
// AND (chained)
.eq("status", "active")
.gt("price", 100)

// OR
.or("status.eq.active,price.gt.100")

// NOT
.not("status", "eq", "archived")
```

### Ordering

```typescript
// Ascending
.order("created_at", { ascending: true })

// Descending
.order("created_at", { ascending: false })

// Multiple columns
.order("status", { ascending: true })
.order("created_at", { ascending: false })
```

### Pagination

```typescript
// Limit
.limit(10)

// Range (offset + limit)
.range(0, 9)  // First 10 items

// Range for pagination
const page = 1;
const pageSize = 10;
.range((page - 1) * pageSize, page * pageSize - 1)
```

---

## Relationships

### Select with Relationships

**One-to-many:**

```typescript
const { data } = await client
  .from("posts")
  .select("id, title, author:users(name, email)");
```

**Many-to-many:**

```typescript
const { data } = await client
  .from("posts")
  .select("id, title, tags:post_tags(tag:tags(name))");
```

**Nested relationships:**

```typescript
const { data } = await client.from("posts").select(`
    id,
    title,
    author:users(
      id,
      name,
      profile:profiles(bio, avatar)
    )
  `);
```

---

## Type Generation

Generate TypeScript types from your database schema:

```bash
npx neon-js gen-types --db-url "postgresql://user:pass@host/db" --output src/types/database.ts
```

Or using environment variable:

```bash
npx neon-js gen-types --db-url "$DATABASE_URL" --output lib/db/database.types.ts
```

**Use types in client:**

```typescript
import { createClient } from "@neondatabase/neon-js";
import type { Database } from "./database.types";

export const dbClient = createClient<Database>({
  auth: { url: process.env.NEXT_PUBLIC_NEON_AUTH_URL! },
  dataApi: { url: process.env.NEON_DATA_API_URL! },
});
```

**Benefits:**

- Full TypeScript autocomplete for tables and columns
- Type-safe queries
- Compile-time error checking

---

## Error Handling

**Check for errors:**

```typescript
const { data, error } = await client.from("items").select();

if (error) {
  console.error("Database error:", error.message);
  console.error("Error code:", error.code);
  console.error("Error details:", error.details);
  return;
}

// Use data
console.log(data);
```

**Common error codes:**

- `PGRST116` - No rows returned (when using `.single()`)
- `23505` - Unique violation
- `23503` - Foreign key violation
- `42P01` - Table does not exist

---

## Usage Examples

### Server Component (Next.js)

```typescript
// app/posts/page.tsx
import { dbClient } from "@/lib/db/client";

export default async function PostsPage() {
  const { data: posts, error } = await dbClient
    .from("posts")
    .select("id, title, created_at, author:users(name)")
    .order("created_at", { ascending: false })
    .limit(10);

  if (error) return <div>Error loading posts</div>;

  return (
    <ul>
      {posts?.map((post) => (
        <li key={post.id}>
          <h2>{post.title}</h2>
          <p>By {post.author?.name}</p>
        </li>
      ))}
    </ul>
  );
}
```

### API Route (Next.js)

```typescript
// app/api/posts/route.ts
import { dbClient } from "@/lib/db/client";
import { NextResponse } from "next/server";

export async function GET() {
  const { data, error } = await dbClient.from("posts").select();

  if (error) {
    return NextResponse.json({ error: error.message }, { status: 500 });
  }

  return NextResponse.json(data);
}

export async function POST(request: Request) {
  const body = await request.json();

  const { data, error } = await dbClient
    .from("posts")
    .insert(body)
    .select()
    .single();

  if (error) {
    return NextResponse.json({ error: error.message }, { status: 400 });
  }

  return NextResponse.json(data, { status: 201 });
}
```

### Client Component (React)

```typescript
"use client";

import { useEffect, useState } from "react";
import { dbClient } from "@/lib/db/client";

export function ItemsList() {
  const [items, setItems] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    async function fetchItems() {
      const { data, error } = await dbClient
        .from("items")
        .select("id, name, status")
        .eq("status", "active");

      if (error) {
        console.error(error);
        return;
      }

      setItems(data || []);
      setLoading(false);
    }

    fetchItems();
  }, []);

  if (loading) return <div>Loading...</div>;

  return (
    <ul>
      {items.map((item) => (
        <li key={item.id}>{item.name}</li>
      ))}
    </ul>
  );
}
```

---

## Supabase Migration

The Neon JS SDK uses the same PostgREST API as Supabase, making migration straightforward:

**Before (Supabase):**

```typescript
import { createClient } from "@supabase/supabase-js";

const client = createClient(SUPABASE_URL, SUPABASE_KEY);
```

**After (Neon):**

```typescript
import { createClient, SupabaseAuthAdapter } from "@neondatabase/neon-js";

const client = createClient({
  auth: { adapter: SupabaseAuthAdapter(), url: NEON_AUTH_URL },
  dataApi: { url: NEON_DATA_API_URL },
});
```

**Query syntax remains the same:**

```typescript
// Works identically in both
await client.auth.signInWithPassword({ email, password });
const { data } = await client.from("items").select();
```
</file>

<file path=".agents/skills/neon-postgres/references/neon-rest-api/endpoints.md">
## Overview

This section provides rules for managing compute endpoints associated with branches in a project. Compute endpoints are Neon compute instances that allow you to connect to and interact with your databases.

## Manage compute endpoints

### Create compute endpoint

1.  Action: Creates a new compute endpoint (a Neon compute instance) and associates it with a specified branch.
2.  Endpoint: `POST /projects/{project_id}/endpoints`
3.  Path Parameters:
    - `project_id` (string, required): The unique identifier of the project.
4.  Body Parameters:
    `endpoint` (object, required): The container for the new endpoint's properties.
    - `branch_id` (string, required): The ID of the branch to associate the endpoint with.
    - `type` (string, required): The endpoint type. A branch can have only one `read_write` endpoint but multiple `read_only` endpoints. Allowed values: `read_write`, `read_only`.
    - `region_id` (string, optional): The region where the endpoint will be created. Must match the project's region.
    - `autoscaling_limit_min_cu` (number, optional): The minimum number of Compute Units (CU). Minimum `0.25`.
    - `autoscaling_limit_max_cu` (number, optional): The maximum number of Compute Units (CU). Minimum `0.25`.
    - `provisioner` (string, optional): The compute provisioner. Specify `k8s-neonvm` to enable Autoscaling. Allowed values: `k8s-pod`, `k8s-neonvm`.
    - `suspend_timeout_seconds` (integer, optional): Duration of inactivity in seconds before suspending the compute. Ranges from -1 (never suspend) to 604800 (1 week).
    - `disabled` (boolean, optional): If `true`, restricts connections to the endpoint.

Example Request:

```bash
curl 'https://console.neon.tech/api/v2/projects/hidden-river-50598307/endpoints' \
  -H 'Accept: application/json' \
  -H "Authorization: Bearer $NEON_API_KEY" \
  -H 'Content-Type: application/json' \
  -d '{
  "endpoint": {
    "branch_id": "br-your-branch-id",
    "type": "read_only"
  }
}'
```

Example Response:

```json
{
  "endpoint": {
    "host": "ep-proud-mud-adwmnxz4.c-2.us-east-1.aws.neon.tech",
    "id": "ep-proud-mud-adwmnxz4",
    "project_id": "hidden-river-50598307",
    "branch_id": "br-super-wildflower-adniii9u",
    "autoscaling_limit_min_cu": 0.25,
    "autoscaling_limit_max_cu": 2,
    "region_id": "aws-us-east-1",
    "type": "read_only",
    "current_state": "init",
    "pending_state": "active",
    "settings": {},
    "pooler_enabled": false,
    "pooler_mode": "transaction",
    "disabled": false,
    "passwordless_access": true,
    "creation_source": "console",
    "created_at": "2025-09-11T06:25:12Z",
    "updated_at": "2025-09-11T06:25:12Z",
    "proxy_host": "c-2.us-east-1.aws.neon.tech",
    "suspend_timeout_seconds": 0,
    "provisioner": "k8s-neonvm"
  },
  "operations": [
    {
      "id": "4d10642f-5212-4517-ad60-afd28c9096e2",
      "project_id": "hidden-river-50598307",
      "branch_id": "br-super-wildflower-adniii9u",
      "endpoint_id": "ep-proud-mud-adwmnxz4",
      "action": "start_compute",
      "status": "running",
      "failures_count": 0,
      "created_at": "2025-09-11T06:25:12Z",
      "updated_at": "2025-09-11T06:25:12Z",
      "total_duration_ms": 0
    }
  ]
}
```

### List compute endpoints

1.  Action: Retrieves a list of all compute endpoints for the specified project.
2.  Endpoint: `GET /projects/{project_id}/endpoints`
3.  Path Parameters:
    - `project_id` (string, required): The unique identifier of the project.

Example Request:

```bash
curl 'https://console.neon.tech/api/v2/projects/hidden-river-50598307/endpoints' \
  -H 'Accept: application/json' \
  -H "Authorization: Bearer $NEON_API_KEY"
```

### Retrieve compute endpoint details

1.  Action: Retrieves detailed information about a specific compute endpoint, including its configuration (e.g., autoscaling limits), current state (`active` or `idle`), and associated branch ID.
2.  Endpoint: `GET /projects/{project_id}/endpoints/{endpoint_id}`
3.  Path Parameters:
    - `project_id` (string, required): The unique identifier of the project.
    - `endpoint_id` (string, required): The unique identifier of the compute endpoint).

Example Request:

```bash
curl 'https://console.neon.tech/api/v2/projects/hidden-river-50598307/endpoints/ep-proud-mud-adwmnxz4' \
  -H 'Accept: application/json' \
  -H "Authorization: Bearer $NEON_API_KEY"
```

### Update compute endpoint

1.  Action: Updates the configuration of a specified compute endpoint.
2.  Endpoint: `PATCH /projects/{project_id}/endpoints/{endpoint_id}`
3.  Path Parameters:
    - `project_id` (string, required): The unique identifier of the project.
    - `endpoint_id` (string, required): The unique identifier of the compute endpoint.
4.  Body Parameters:
    `endpoint` (object, required): The container for the endpoint attributes to update.
    - `autoscaling_limit_min_cu` (number, optional): A new minimum number of Compute Units (CU).
    - `autoscaling_limit_max_cu` (number, optional): A new maximum number of Compute Units (CU).
    - `suspend_timeout_seconds` (integer, optional): A new inactivity period in seconds before suspension.
    - `disabled` (boolean, optional): Set to `true` to disable connections or `false` to enable them.
    - `provisioner` (string, optional): Change the compute provisioner.

Example: Update autoscaling limits

```bash
curl -X 'PATCH' \
  'https://console.neon.tech/api/v2/projects/hidden-river-50598307/endpoints/ep-proud-mud-adwmnxz4' \
  -H 'Accept: application/json' \
  -H "Authorization: Bearer $NEON_API_KEY" \
  -H 'Content-Type: application/json' \
  -d '{
  "endpoint": {
    "autoscaling_limit_min_cu": 0.5,
    "autoscaling_limit_max_cu": 1
  }
}'
```

### Delete compute endpoint

1.  Action: Deletes the specified compute endpoint. This action drops any existing network connections to the endpoint.
2.  Endpoint: `DELETE /projects/{project_id}/endpoints/{endpoint_id}`
3.  Path Parameters:
    - `project_id` (string, required): The unique identifier of the project.
    - `endpoint_id` (string, required): The unique identifier of the compute endpoint to delete.

Example Request:

```bash
curl -X 'DELETE' \
  'https://console.neon.tech/api/v2/projects/hidden-river-50598307/endpoints/ep-proud-mud-adwmnxz4' \
  -H 'Accept: application/json' \
  -H "Authorization: Bearer $NEON_API_KEY"
```

### Start compute endpoint

1.  Action: Manually starts a compute endpoint that is currently in an `idle` state. The endpoint is ready for connections once the start operation completes successfully.
2.  Endpoint: `POST /projects/{project_id}/endpoints/{endpoint_id}/start`
3.  Path Parameters:
    - `project_id` (string, required): The unique identifier of the project.
    - `endpoint_id` (string, required): The unique identifier of the compute endpoint.

Example Request:

```bash
curl -X 'POST' \
  'https://console.neon.tech/api/v2/projects/hidden-river-50598307/endpoints/ep-ancient-brook-ad5ea04d/start' \
  -H 'Accept: application/json' \
  -H "Authorization: Bearer $NEON_API_KEY"
```

### Suspend compute endpoint

1.  Action: Manually suspends an `active` compute endpoint, forcing it into an `idle` state. This will immediately drop any active connections to the endpoint.
2.  Endpoint: `POST /projects/{project_id}/endpoints/{endpoint_id}/suspend`
3.  Path Parameters:
    - `project_id` (string, required): The unique identifier of the project.
    - `endpoint_id` (string, required): The unique identifier of the compute endpoint.

Example Request:

```bash
curl -X 'POST' \
  'https://console.neon.tech/api/v2/projects/hidden-river-50598307/endpoints/ep-ancient-brook-ad5ea04d/suspend' \
  -H 'Accept: application/json' \
  -H "Authorization: Bearer $NEON_API_KEY"
```

### Restart compute endpoint

1.  Action: Restarts the specified compute endpoint. This involves an immediate suspend operation followed by a start operation. This is useful for applying configuration changes or refreshing the compute instance. All active connections will be dropped.
2.  Endpoint: `POST /projects/{project_id}/endpoints/{endpoint_id}/restart`
3.  Path Parameters:
    - `project_id` (string, required): The unique identifier of the project.
    - `endpoint_id` (string, required): The unique identifier of the compute endpoint.

Example Request:

```bash
curl -X 'POST' \
  'https://console.neon.tech/api/v2/projects/hidden-river-50598307/endpoints/ep-ancient-brook-ad5ea04d/restart' \
  -H 'Accept: application/json' \
  -H "Authorization: Bearer $NEON_API_KEY"
```
</file>

<file path=".agents/skills/neon-postgres/references/neon-rest-api/guidelines.md">
## Overview

This document provides a comprehensive set of rules and guidelines for an AI agent to interact with the Neon API. The Neon API is a RESTful service that allows for programmatic management of all Neon resources. Adherence to these rules ensures correct, efficient, and safe API usage.

### General API guidelines

All Neon API requests must be made to the following base URL:

```
https://console.neon.tech/api/v2/
```

To construct a full request URL, append the specific endpoint path to this base URL.

### Authentication

- All API requests must be authenticated using a Neon API key.
- The API key must be included in the `Authorization` header using the `Bearer` authentication scheme.
- The header should be formatted as: `Authorization: Bearer $NEON_API_KEY`, where `$NEON_API_KEY` is a valid Neon API key.
- A request without a valid `Authorization` header will fail with a `401 Unauthorized` status code.

### API rate limiting

- Neon limits API requests to 700 requests per minute (approximately 11 per second).
- Bursts of up to 40 requests per second per route are permitted.
- If the rate limit is exceeded, the API will respond with an `HTTP 429 Too Many Requests` error.
- Your application logic must handle `429` errors and implement a retry strategy with appropriate backoff.

### Neon Core Concepts

To effectively use the Neon Python SDK, it's essential to understand the hierarchy and purpose of its core resources. The following table provides a high-level overview of each concept.

| Concept          | Description                                                                                                                        | Analogy/Purpose                                                                                                 | Key Relationship                                                                                      |
| ---------------- | ---------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------- |
| Organization     | The highest-level container, managing billing, users, and multiple projects.                                                       | A GitHub Organization or a company's cloud account.                                                             | Contains one or more Projects.                                                                        |
| Project          | The primary container that contains all related database resources for a single application or service.                            | A Git repository or a top-level folder for an application.                                                      | Lives within an Organization (or a personal account). Contains Branches.                              |
| Branch           | A lightweight, copy-on-write clone of a database's state at a specific point in time.                                              | A `git branch`. Used for isolated development, testing, staging, or previews without duplicating storage costs. | Belongs to a Project. Contains its own set of Databases and Roles, cloned from its parent.            |
| Compute Endpoint | The actual running PostgreSQL instance that you connect to. It provides the CPU and RAM for processing queries.                    | The "server" or "engine" for your database. It can be started, suspended (scaled to zero), and resized.         | Is attached to a single Branch. Your connection string points to a Compute Endpoint's hostname.       |
| Database         | A logical container for your data (tables, schemas, views) within a branch. It follows standard PostgreSQL conventions.            | A single database within a PostgreSQL server instance.                                                          | Exists within a Branch. A branch can have multiple databases.                                         |
| Role             | A PostgreSQL role used for authentication (logging in) and authorization (permissions to access data).                             | A database user account with a username and password.                                                           | Belongs to a Branch. Roles from a parent branch are copied to child branches upon creation.           |
| API Key          | A secret token used to authenticate requests to the Neon API. Keys have different scopes (Personal, Organization, Project-scoped). | A password for programmatic access, allowing you to manage all other Neon resources.                            | Authenticates actions on Organizations, Projects, Branches, etc.                                      |
| Operation        | An asynchronous action performed by the Neon control plane, such as creating a branch or starting a compute.                       | A background job or task. Its status can be polled to know when an action is complete.                          | Associated with a Project and often a specific Branch or Endpoint. Essential for scripting API calls. |

### Understanding API key types

When performing actions via the API, you must select the correct type of API key based on the required scope and permissions. There are three types:

1. Personal API Key

- Scope: Accesses all projects that the user who created the key is a member of.
- Permissions: The key has the same permissions as its owner. If the user's access is revoked from an organization, the key loses access too.
- Best For: Individual use, scripting, and tasks tied to a specific user's permissions.
- Created By: Any user.

2. Organization API Key

- Scope: Accesses all projects and resources within an entire organization.
- Permissions: Has admin-level access across the organization, independent of any single user. It remains valid even if the creator leaves the organization.
- Best For: CI/CD pipelines, organization-wide automation, and service accounts that need broad access.
- Created By: Organization administrators only.

3. Project-scoped API Key

- Scope: Access is strictly limited to a single, specified project.
- Permissions: Cannot perform organization-level actions (like creating new projects) or delete the project it is scoped to. This is the most secure and limited key type.
- Best For: Project-specific integrations, third-party services, or automation that should be isolated to one project.
- Created By: Any organization member.
</file>

<file path=".agents/skills/neon-postgres/references/neon-rest-api/keys.md">
## Overview

This document outlines the rules for managing Neon API keys programmatically. It covers listing existing keys, creating new keys, and revoking keys.

### Important note on creating API keys

To create new API keys using the API, you must already possess a valid Personal API Key. The first key must be created from the Neon Console. You can ask the user to create one for you if you do not have one.

### List API keys

- Endpoint: `GET /api_keys`
- Authorization: Use a Personal API Key.

Example request:

```bash
curl "https://console.neon.tech/api/v2/api_keys" \
  -H "Authorization: Bearer $PERSONAL_API_KEY"
```

Example response:

```json
[
  {
    "id": 2291506,
    "name": "my-personal-key",
    "created_at": "2025-09-10T09:44:04Z",
    "created_by": {
      "id": "487de658-08ba-4363-b387-86d18b9ad1c8",
      "name": "<USER_NAME>",
      "image": "<USER_IMAGE_URL>"
    },
    "last_used_at": "2025-09-10T09:44:09Z",
    "last_used_from_addr": "49.43.218.132,34.211.200.85"
  }
]
```

### Create an API key

- Endpoint: `POST /api_keys`
- Authorization: Use a Personal API Key.
- Body: Must include a `key_name`.

Example request:

```bash
curl https://console.neon.tech/api/v2/api_keys \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $PERSONAL_API_KEY" \
  -d '{"key_name": "my-new-key"}'
```

Example response:

```json
{
  "id": 2291515,
  "key": "napi_9tlr13774gizljemrr133j5koy3bmsphj8iu38mh0yjl9q4r1b0jy2wuhhuxouzr",
  "name": "my-new-key",
  "created_at": "2025-09-10T09:47:59Z",
  "created_by": "487de658-08ba-4363-b387-86d18b9ad1c8"
}
```

### Revoke an API key

- Endpoint: `DELETE /api_keys/{key_id}`
- Authorization: Use a Personal API Key.

Example request:

```bash
curl -X DELETE \
  'https://console.neon.tech/api/v2/api_keys/2291515' \
  -H "Authorization: Bearer $PERSONAL_API_KEY"
```

Example response:

```json
{
  "id": 2291515,
  "name": "mynewkey",
  "created_at": "2025-09-10T09:47:59Z",
  "created_by": "487de658-08ba-4363-b387-86d18b9ad1c8",
  "last_used_at": "2025-09-10T09:53:01Z",
  "last_used_from_addr": "2405:201:c01f:7013:d962:2b4f:2740:9750",
  "revoked": true
}
```
</file>

<file path=".agents/skills/neon-postgres/references/neon-rest-api/operations.md">
## Overview

This document outlines the rules for managing and monitoring long-running operations in Neon, including branch creation and compute management.

## Operations

An operation is an action performed by the Neon Control Plane (e.g., `create_branch`, `start_compute`). When using the API programmatically, it is crucial to monitor the status of long-running operations to ensure one has completed before starting another that depends on it. Operations older than 6 months may be deleted from Neon's systems.

### List operations

1.  Action: Retrieves a list of operations for the specified Neon project. The number of operations can be large, so pagination is recommended.
2.  Endpoint: `GET /projects/{project_id}/operations`
3.  Path Parameters:
    - `project_id` (string, required): The unique identifier of the project whose operations you want to list.
4.  Query Parameters:
    - `limit` (integer, optional): The number of operations to return in the response. Must be between 1 and 1000.
    - `cursor` (string, optional): The cursor value from a previous response to fetch the next page of operations.
5.  Procedure:
    - Make an initial request with a `limit` to get the first page of results.
    - The response will contain a `pagination.cursor` value.
    - To get the next page, make a subsequent request including both the `limit` and the `cursor` from the previous response.

Example request

```bash
curl 'https://console.neon.tech/api/v2/projects/hidden-river-50598307/operations' \
  -H 'Accept: application/json' \
  -H "Authorization: Bearer $NEON_API_KEY"
```

Example response

```json
{
  "operations": [
    {
      "id": "639f7f73-0b76-4749-a767-2d3c627ca5a6",
      "project_id": "hidden-river-50598307",
      "branch_id": "br-long-feather-adpbgzlx",
      "endpoint_id": "ep-round-morning-adtpn2oc",
      "action": "apply_config",
      "status": "finished",
      "failures_count": 0,
      "created_at": "2025-09-10T12:15:23Z",
      "updated_at": "2025-09-10T12:15:23Z",
      "total_duration_ms": 87
    },
    {
      "id": "b5a7882b-a5b3-4292-ad27-bffe733feae4",
      "project_id": "hidden-river-50598307",
      "branch_id": "br-super-wildflower-adniii9u",
      "endpoint_id": "ep-ancient-brook-ad5ea04d",
      "action": "apply_config",
      "status": "finished",
      "failures_count": 0,
      "created_at": "2025-09-10T12:15:23Z",
      "updated_at": "2025-09-10T12:15:23Z",
      "total_duration_ms": 49
    },
    {
      "id": "36a1cba0-97f1-476d-af53-d9e0d3a3606d",
      "project_id": "hidden-river-50598307",
      "branch_id": "br-super-wildflower-adniii9u",
      "endpoint_id": "ep-ancient-brook-ad5ea04d",
      "action": "start_compute",
      "status": "finished",
      "failures_count": 0,
      "created_at": "2025-09-10T12:15:04Z",
      "updated_at": "2025-09-10T12:15:05Z",
      "total_duration_ms": 913
    },
    {
      "id": "409c35ef-cbc3-4f1b-a4ca-f2de319f5360",
      "project_id": "hidden-river-50598307",
      "branch_id": "br-super-wildflower-adniii9u",
      "action": "create_branch",
      "status": "finished",
      "failures_count": 0,
      "created_at": "2025-09-10T12:15:04Z",
      "updated_at": "2025-09-10T12:15:04Z",
      "total_duration_ms": 136
    },
    {
      "id": "274e240f-e2fb-4719-b796-c1ab7c4ae91c",
      "project_id": "hidden-river-50598307",
      "branch_id": "br-long-feather-adpbgzlx",
      "endpoint_id": "ep-round-morning-adtpn2oc",
      "action": "start_compute",
      "status": "finished",
      "failures_count": 0,
      "created_at": "2025-09-10T12:14:58Z",
      "updated_at": "2025-09-10T12:15:03Z",
      "total_duration_ms": 4843
    },
    {
      "id": "22ef6fbd-21c5-4cdb-9825-b0f9afddbb0d",
      "project_id": "hidden-river-50598307",
      "branch_id": "br-long-feather-adpbgzlx",
      "action": "create_timeline",
      "status": "finished",
      "failures_count": 0,
      "created_at": "2025-09-10T12:14:58Z",
      "updated_at": "2025-09-10T12:15:01Z",
      "total_duration_ms": 3096
    }
  ],
  "pagination": {
    "cursor": "2025-09-10T12:14:58.848485Z"
  }
}
```

### Retrieve operation details

1.  Action: Retrieves the details and status of a single, specified operation. The `operation_id` is found in the response body of the initial API call that initiated it, or by listing operations.
2.  Endpoint: `GET /projects/{project_id}/operations/{operation_id}`
3.  Path Parameters:
    - `project_id` (string, required): The unique identifier of the project where the operation occurred.
    - `operation_id` (UUID, required): The unique identifier of the operation. This ID is returned in the response body of the API call that initiated the operation.

Example request:

```bash
curl 'https://console.neon.tech/api/v2/projects/hidden-river-50598307/operations/274e240f-e2fb-4719-b796-c1ab7c4ae91c' \
  -H 'Accept: application/json' \
  -H "Authorization: Bearer $NEON_API_KEY"
```

Example response:

```json
{
  "operation": {
    "id": "274e240f-e2fb-4719-b796-c1ab7c4ae91c",
    "project_id": "hidden-river-50598307",
    "branch_id": "br-long-feather-adpbgzlx",
    "endpoint_id": "ep-round-morning-adtpn2oc",
    "action": "start_compute",
    "status": "finished",
    "failures_count": 0,
    "created_at": "2025-09-10T12:14:58Z",
    "updated_at": "2025-09-10T12:15:03Z",
    "total_duration_ms": 4843
  }
}
```
</file>

<file path=".agents/skills/neon-postgres/references/neon-rest-api/organizations.md">
## Overview

This section provides rules for managing organizations, their members, invitations, and organization API keys. Organizations allow multiple users to collaborate on projects and share resources within Neon.

## Manage organizations

### Retrieve organization details

1.  Action: Retrieves detailed information about a specific organization.
2.  Endpoint: `GET /organizations/{org_id}`
3.  Path Parameters:
    - `org_id` (string, required): The unique identifier of the organization.

Example Request:

```bash
curl 'https://console.neon.tech/api/v2/organizations/{org_id}' \
  -H 'Accept: application/json' \
  -H "Authorization: Bearer $NEON_API_KEY"
```

### List organization members

1.  Action: Retrieves a list of all members belonging to the specified organization.
2.  Endpoint: `GET /organizations/{org_id}/members`
3.  Path Parameters:
    - `org_id` (string, required): The unique identifier of the organization.

Example Request:

```bash
curl 'https://console.neon.tech/api/v2/organizations/{org_id}/members' \
  -H 'Accept: application/json' \
  -H "Authorization: Bearer $NEON_API_KEY"
```

### Retrieve organization member details

1.  Action: Retrieves information about a specific member of an organization.
2.  Endpoint: `GET /organizations/{org_id}/members/{member_id}`
3.  Path Parameters:
    - `org_id` (string, required): The unique identifier of the organization.
    - `member_id` (UUID, required): The unique identifier of the organization member.

Example Request:

```bash
curl 'https://console.neon.tech/api/v2/organizations/{org_id}/members/{member_id}' \
  -H 'Accept: application/json' \
  -H "Authorization: Bearer $NEON_API_KEY"
```

### Update role for organization member

1.  Action: Updates the role of a specified member within an organization.
2.  Prerequisite: This action can only be performed by an organization `admin`.
3.  Endpoint: `PATCH /organizations/{org_id}/members/{member_id}`
4.  Path Parameters:
    - `org_id` (string, required): The unique identifier of the organization.
    - `member_id` (UUID, required): The unique identifier of the organization member.
5.  Body Parameters:
    - `role` (string, required): The new role for the member. Allowed values: `admin`, `member`.

Example: Change a member's role to admin

```bash
curl -X 'PATCH' \
  'https://console.neon.tech/api/v2/organizations/{org_id}/members/{member_id}' \
  -H 'Accept: application/json' \
  -H "Authorization: Bearer $NEON_API_KEY" \
  -H 'Content-Type: application/json' \
  -d '{"role": "admin"}'
```

### Remove member from organization

1.  Action: Removes a specified member from an organization.
2.  Prerequisites:
    - This action can only be performed by an organization `admin`.
    - An admin cannot be removed if they are the only admin left in the organization.
3.  Endpoint: `DELETE /organizations/{org_id}/members/{member_id}`
4.  Path Parameters:
    - `org_id` (string, required): The unique identifier of the organization.
    - `member_id` (UUID, required): The unique identifier of the organization member to remove.

Example Request:

```bash
curl -X 'DELETE' \
  'https://console.neon.tech/api/v2/organizations/{org_id}/members/{member_id}' \
  -H 'Accept: application/json' \
  -H "Authorization: Bearer $NEON_API_KEY"
```

### Create organization invitations

1.  Action: Creates and sends one or more email invitations for users to join a specific organization.
2.  Endpoint: `POST /organizations/{org_id}/invitations`
3.  Path Parameters:
    - `org_id` (string, required): The unique identifier of the organization.
4.  Body Parameters:
    `invitations` (array of objects, required): A list of invitations to create.
    - `email` (string, required): The email address of the user to invite.
    - `role` (string, required): The role the invited user will have. Allowed values: `admin`, `member`.

Example: Invite two users with different roles

```bash
curl -X 'POST' \
  'https://console.neon.tech/api/v2/organizations/{org_id}/invitations' \
  -H 'Accept: application/json' \
  -H "Authorization: Bearer $NEON_API_KEY" \
  -H 'Content-Type: application/json' \
  -d '{
  "invitations": [
    {
      "email": "developer@example.com",
      "role": "member"
    },
    {
      "email": "manager@example.com",
      "role": "admin"
    }
  ]
}'
```

### List organization invitations

1.  Action: Retrieves information about outstanding invitations for the specified organization.
2.  Endpoint: `GET /organizations/{org_id}/invitations`
3.  Path Parameters:
    - `org_id` (string, required): The unique identifier of the organization.

Example Request:

```bash
curl 'https://console.neon.tech/api/v2/organizations/{org_id}/invitations' \
  -H 'Accept: application/json' \
  -H "Authorization: Bearer $NEON_API_KEY"
```

### Create organization API key

1.  Action: Creates a new API key for the specified organization. The key can be scoped to the entire organization or limited to a single project within it.
2.  Endpoint: `POST /organizations/{org_id}/api_keys`
3.  Path Parameters:
    - `org_id` (string, required): The unique identifier of the organization.
4.  Body Parameters:
    - `key_name` (string, required): A user-specified name for the API key (max 64 characters).
    - `project_id` (string, optional): If provided, the API key's access will be restricted to only this project.
5.  Authorization: Use a Personal API Key of an organization `admin` to create organization API keys.

Example: Create a project-scoped API key

```bash
curl -X 'POST' \
  'https://console.neon.tech/api/v2/organizations/{org_id}/api_keys' \
  -H 'Accept: application/json' \
  -H "Authorization: Bearer $PERSONAL_API_KEY_OF_ADMIN" \
  -H 'Content-Type: application/json' \
  -d '{
  "key_name": "ci-pipeline-key-for-project-x",
  "project_id": "project-id-123"
}'
```

### List organization API keys

1.  Action: Retrieves a list of all API keys created for the specified organization.
2.  Endpoint: `GET /organizations/{org_id}/api_keys`
3.  Note: The response includes metadata about the keys (like `id` and `name`) but does not include the secret key tokens themselves. Tokens are only visible upon creation.
4.  Path Parameters:
    - `org_id` (string, required): The unique identifier of the organization.

Example Request:

```bash
curl 'https://console.neon.tech/api/v2/organizations/{org_id}/api_keys' \
  -H 'Accept: application/json' \
  -H "Authorization: Bearer $NEON_API_KEY"
```

### Revoke organization API key

1.  Action: Permanently revokes the specified organization API key.
2.  Endpoint: `DELETE /organizations/{org_id}/api_keys/{key_id}`
3.  Path Parameters:
    - `org_id` (string, required): The unique identifier of the organization.
    - `key_id` (integer, required): The unique identifier of the API key to revoke. You can obtain this ID by listing the organization's API keys.

Example Request:

```bash
curl -X 'DELETE' \
  'https://console.neon.tech/api/v2/organizations/{org_id}/api_keys/{key_id}' \
  -H 'Accept: application/json' \
  -H "Authorization: Bearer $NEON_API_KEY"
```
</file>

<file path=".agents/skills/neon-postgres/references/connection-methods.md">
# Connection Methods

Guide to selecting the optimal connection method for your Neon Postgres database based on deployment platform and runtime environment.

For official documentation:

```bash
curl -H "Accept: text/markdown" https://neon.com/docs/connect/choose-connection
```

## Decision Tree

Follow this flow to determine the right connection approach:

### 1. What Language Are You Using?

**Not TypeScript/JavaScript** → Use **TCP with connection pooling** from a secure server.

For non-TypeScript languages, connect from a secure backend server using your language's native Postgres driver with connection pooling enabled.

| Language/Framework  | Documentation                               |
| ------------------- | ------------------------------------------- |
| Django (Python)     | https://neon.com/docs/guides/django        |
| SQLAlchemy (Python) | https://neon.com/docs/guides/sqlalchemy    |
| Elixir Ecto         | https://neon.com/docs/guides/elixir-ecto   |
| Laravel (PHP)       | https://neon.com/docs/guides/laravel       |
| Ruby on Rails       | https://neon.com/docs/guides/ruby-on-rails |
| Go                  | https://neon.com/docs/guides/go            |
| Rust                | https://neon.com/docs/guides/rust          |
| Java                | https://neon.com/docs/guides/java          |

**TypeScript/JavaScript** → Continue to step 2.

---

### 2. Client-Side App Without Backend?

**Yes** → Use **Neon Data API** via `@neondatabase/neon-js`

This is the only option for client-side apps since browsers cannot make direct TCP connections to Postgres. See `neon-js.md` for setup.

```bash
curl -H "Accept: text/markdown" https://neon.com/docs/reference/javascript-sdk
```

**No** → Continue to step 3.

---

### 3. Long-Running Server? (Railway, Render, traditional VPS)

**Yes** → Use **TCP with connection pooling** via `node-postgres`, `postgres.js`, or `bun:pg`

Long-running servers maintain persistent connections, so standard TCP drivers with pooling are optimal.

**No** → Continue to step 4.

---

### 4. Edge Environment Without TCP Support?

Some edge runtimes don't support TCP connections. Rarely the case anymore.

**Yes** → Continue to step 5 to check transaction requirements.

**No** → Continue to step 6 to check pooling support.

---

### 5. Does Your App Use SQL Transactions?

**Yes** → Use **WebSocket transport** via `@neondatabase/serverless` with `Pool`

WebSocket maintains connection state needed for transactions. See `neon-serverless.md` for setup.

**No** → Use **HTTP transport** via `@neondatabase/serverless`

HTTP is faster for single queries (~3 roundtrips vs ~8 for TCP). See `neon-serverless.md` for setup.

```bash
curl -H "Accept: text/markdown" https://neon.com/docs/serverless/serverless-driver
```

---

### 6. Serverless Environment With Connection Pooling Support?

**Vercel (Fluid Compute)** → Use **TCP with `@vercel/functions`**

Vercel's Fluid compute supports connection pooling. Use `attachDatabasePool` for optimal connection management.

```bash
curl -H "Accept: text/markdown" https://neon.com/docs/guides/vercel-connection-methods
```

**Cloudflare (with Hyperdrive)** → Use **TCP via Hyperdrive**

Cloudflare Hyperdrive provides connection pooling for Workers. Use `node-postgres` or any native TCP driver.

See https://neon.com/docs/guides/cloudflare-hyperdrive for more on connecting with Cloudflare Workers and Hyperdrive.

**No pooling support (Netlify, Deno Deploy)** → Use `@neondatabase/serverless`

Fall back to the decision in step 5 based on transaction requirements.

---

## Quick Reference Table

| Platform                | TCP Support | Pooling             | Recommended Driver         |
| ----------------------- | ----------- | ------------------- | -------------------------- |
| Vercel (Fluid)          | Yes         | `@vercel/functions` | `pg` (node-postgres)       |
| Cloudflare (Hyperdrive) | Yes         | Hyperdrive          | `pg` (node-postgres)       |
| Cloudflare Workers      | No          | No                  | `@neondatabase/serverless` |
| Netlify Functions       | No          | No                  | `@neondatabase/serverless` |
| Deno Deploy             | No          | No                  | `@neondatabase/serverless` |
| Railway / Render        | Yes         | Built-in            | `pg` (node-postgres)       |
| Client-side (browser)   | No          | N/A                 | `@neondatabase/neon-js`    |

---

## ORM Support

Popular TypeScript/JavaScript ORMs all work with Neon:

| ORM     | Drivers Supported                               | Documentation                         |
| ------- | ----------------------------------------------- | ------------------------------------- |
| Drizzle | `pg`, `postgres.js`, `@neondatabase/serverless` | https://neon.com/docs/guides/drizzle |
| Kysely  | `pg`, `postgres.js`, `@neondatabase/serverless` | https://neon.com/docs/guides/kysely  |
| Prisma  | `pg`, `@neondatabase/serverless`                | https://neon.com/docs/guides/prisma  |
| TypeORM | `pg`                                            | https://neon.com/docs/guides/typeorm |

All ORMs support both TCP drivers and Neon's serverless driver depending on your platform.

For Drizzle ORM integration with Neon, see `neon-drizzle.md`.

---

## Vercel Fluid + Drizzle Example

Complete database client setup for Vercel with Drizzle ORM and connection pooling. See `neon-drizzle.md` for more examples.

```typescript
// src/lib/db/client.ts
import { attachDatabasePool } from "@vercel/functions";
import { drizzle } from "drizzle-orm/node-postgres";
import { Pool } from "pg";

import * as schema from "./schema";

const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
});
attachDatabasePool(pool);

export const db = drizzle({ client: pool, schema });
```

**Why `attachDatabasePool`?**

- First request establishes the TCP connection (~8 roundtrips)
- Subsequent requests reuse the connection instantly
- Ensures idle connections close gracefully before function suspension
- Prevents connection leaks in serverless environments

---

## Gathering Requirements

When helping a user choose their connection method, gather this information:

1. **Deployment platform**: Where will the app run? (Vercel, Cloudflare, Netlify, Railway, browser, etc.)
2. **Runtime type**: Serverless functions, edge functions, or long-running server?
3. **Transaction requirements**: Does the app need SQL transactions?
4. **ORM preference**: Using Drizzle, Kysely, Prisma, or raw SQL?

Then provide:

- The recommended driver/package
- A working code example for their setup
- The correct npm install command

---

## Documentation Resources

| Topic                      | URL                                                     |
| -------------------------- | ------------------------------------------------------- |
| Choosing Connection Method | https://neon.com/docs/connect/choose-connection        |
| Serverless Driver          | https://neon.com/docs/serverless/serverless-driver     |
| JavaScript SDK             | https://neon.com/docs/reference/javascript-sdk         |
| Connection Pooling         | https://neon.com/docs/connect/connection-pooling       |
| Vercel Connection Methods  | https://neon.com/docs/guides/vercel-connection-methods |
</file>

<file path=".agents/skills/neon-postgres/references/devtools.md">
# Neon Developer Tools

Neon provides developer tools to enhance your local development workflow, including a VSCode extension and MCP server for AI-assisted development.

## Quick Setup with neon init

The fastest way to set up all Neon developer tools:

```bash
npx neon init
```

This command:

- Installs the Neon VSCode extension
- Configures the Neon MCP server for AI assistants
- Sets up your local environment for Neon development

For full CLI reference:

```bash
curl -H "Accept: text/markdown" https://neon.com/docs/reference/cli-init
```

## VSCode Extension

The Neon VSCode extension provides:

- **Database Explorer**: Browse projects, branches, tables, and data
- **SQL Editor**: Write and execute queries with IntelliSense
- **Branch Management**: Create, switch, and manage database branches
- **Connection String Access**: Quick copy of connection strings

**Install from VSCode:**

1. Open Extensions (Cmd/Ctrl+Shift+X)
2. Search "Neon"
3. Install "Neon" by Neon

**Or via command line:**

```bash
code --install-extension neon.neon-vscode
```

For detailed documentation:

```bash
curl -H "Accept: text/markdown" https://neon.com/docs/local/vscode-extension
```

## Neon MCP Server

The Neon MCP (Model Context Protocol) server enables AI assistants like Claude, Cursor, and GitHub Copilot to interact with your Neon databases directly.

### Capabilities

The MCP server provides AI assistants with:

- **Project Management**: List, create, describe, and delete projects
- **Branch Operations**: Create branches, compare schemas, reset from parent
- **SQL Execution**: Run queries and transactions
- **Schema Operations**: Describe tables, get database structure
- **Migrations**: Prepare and complete database migrations with safety checks
- **Query Tuning**: Analyze and optimize slow queries
- **Neon Auth**: Provision authentication for your branches

### Setup

**Option 1: Via neon init (Recommended)**

```bash
npx neon init
```

**Option 2: Manual Configuration**

Add to your AI assistant's MCP configuration:

```json
{
  "mcpServers": {
    "neon": {
      "command": "npx",
      "args": ["-y", "@neondatabase/mcp-server-neon"],
      "env": {
        "NEON_API_KEY": "your-api-key"
      }
    }
  }
}
```

Get your API key from: https://console.neon.tech/app/settings/api-keys

### Common MCP Operations

| Operation                    | What It Does                  |
| ---------------------------- | ----------------------------- |
| `list_projects`              | Show all Neon projects        |
| `create_project`             | Create a new project          |
| `run_sql`                    | Execute SQL queries           |
| `get_connection_string`      | Get database connection URL   |
| `create_branch`              | Create a database branch      |
| `prepare_database_migration` | Safely prepare schema changes |
| `provision_neon_auth`        | Set up Neon Auth              |

For full MCP server documentation:

```bash
curl -H "Accept: text/markdown" https://neon.com/docs/ai/neon-mcp-server
```

## Documentation Resources

| Topic              | URL                                           |
| ------------------ | --------------------------------------------- |
| CLI Init Command   | https://neon.com/docs/reference/cli-init     |
| VSCode Extension   | https://neon.com/docs/local/vscode-extension |
| MCP Server         | https://neon.com/docs/ai/neon-mcp-server     |
| Neon CLI Reference | https://neon.com/docs/reference/neon-cli     |
</file>

<file path=".agents/skills/neon-postgres/references/features.md">
# Neon Features

Overview of Neon's key platform features. For detailed information, fetch the official docs.

## Branching

Create instant, copy-on-write clones of your database at any point in time. Branches are isolated environments perfect for development, testing, and preview deployments.

```bash
curl -H "Accept: text/markdown" https://neon.com/docs/introduction/branching
```

**Key Points:**

- Branches are instant (no data copying)
- Copy-on-write means branches only store changes from parent
- Use for: dev environments, staging, testing, preview deployments
- Branches can have their own compute endpoint

**Use Cases:**

| Use Case            | Description                                 |
| ------------------- | ------------------------------------------- |
| Development         | Each developer gets isolated branch         |
| Preview Deployments | Branch per PR/preview URL                   |
| Testing             | Reset test data by recreating branch        |
| Schema Migrations   | Test migrations on branch before production |

If the Neon MCP server is available, you can use it to list and create branches. Otherwise, refer to the Neon CLI or Platform API.

## Autoscaling

Neon automatically scales compute resources based on workload demand.

```bash
curl -H "Accept: text/markdown" https://neon.com/docs/introduction/autoscaling
```

**Key Points:**

- Scales between min and max compute units (CUs)
- Responds to CPU and memory pressure
- No manual intervention required
- Configure limits per project or endpoint

## Scale to Zero

Databases automatically suspend after a period of inactivity, reducing costs to storage-only.

```bash
curl -H "Accept: text/markdown" https://neon.com/docs/introduction/scale-to-zero
```

**Key Points:**

- Default suspend after 5 minutes of inactivity (configurable)
- First query after suspend has ~500ms cold start
- Storage is always maintained
- Perfect for dev/staging environments with intermittent use

## Instant Restore

Restore your database to any point within your retention window without backups.

```bash
curl -H "Accept: text/markdown" https://neon.com/docs/introduction/branch-restore
```

**Key Points:**

- Point-in-time recovery without pre-configured backups
- Restore window depends on plan (7-30 days)
- Create branches from any point in history
- Time Travel queries to view historical data

## Read Replicas

Create read-only compute endpoints to scale read workloads.

```bash
curl -H "Accept: text/markdown" https://neon.com/docs/introduction/read-replicas
```

**Key Points:**

- Read replicas share storage with primary (no data duplication)
- Instant creation
- Independent scaling from primary
- Use for: analytics, reporting, read-heavy workloads

## Connection Pooling

Built-in connection pooling via PgBouncer for efficient connection management.

```bash
curl -H "Accept: text/markdown" https://neon.com/docs/connect/connection-pooling
```

**Key Points:**

- Enabled by adding `-pooler` to endpoint hostname
- Transaction mode by default
- Supports up to 10,000 concurrent connections
- Essential for serverless environments

## IP Allow Lists

Restrict database access to specific IP addresses or ranges.

```bash
curl -H "Accept: text/markdown" https://neon.com/docs/introduction/ip-allow
```

## Logical Replication

Replicate data to/from external Postgres databases.

```bash
curl -H "Accept: text/markdown" https://neon.com/docs/guides/logical-replication-guide
```

## Neon Auth

Managed authentication that branches with your database.

```bash
curl -H "Accept: text/markdown" https://neon.com/docs/auth/overview
```

**Key Points:**

- Sign-in/sign-up with email, social providers (Google, GitHub)
- Session management
- UI components included
- Branches with your database

For setup, see `neon-auth.md`. For auth + data API, see `neon-js.md`.

## Feature Documentation Reference

| Feature             | Documentation                                           | Resource       |
| ------------------- | ------------------------------------------------------- | -------------- |
| Branching           | https://neon.com/docs/introduction/branching           | -              |
| Autoscaling         | https://neon.com/docs/introduction/autoscaling         | -              |
| Scale to Zero       | https://neon.com/docs/introduction/scale-to-zero       | -              |
| Instant Restore     | https://neon.com/docs/introduction/branch-restore      | -              |
| Read Replicas       | https://neon.com/docs/introduction/read-replicas       | -              |
| Connection Pooling  | https://neon.com/docs/connect/connection-pooling       | -              |
| IP Allow            | https://neon.com/docs/introduction/ip-allow            | -              |
| Logical Replication | https://neon.com/docs/guides/logical-replication-guide | -              |
| Neon Auth           | https://neon.com/docs/auth/overview                    | `neon-auth.md` |
| Data API            | https://neon.com/docs/data-api/overview                | `neon-js.md`   |
</file>

<file path=".agents/skills/neon-postgres/references/getting-started.md">
# Getting Started with Neon

Interactive guide to help users get started with Neon in their project. Sets up their Neon project (with a connection string) and connects their database to their code.

For the official getting started guide:

```bash
curl -H "Accept: text/markdown" https://neon.com/docs/get-started/signing-up
```

## Interactive Setup Flow

### Step 1: Check Organizations and Projects

**First, check for organizations:**

- If they have 1 organization: Default to that organization
- If they have multiple organizations: List all and ask which one to use

**Then, check for projects within the selected organization:**

- **No projects**: Ask if they want to create a new project
- **1 project**: Ask "Would you like to use '{project_name}' or create a new one?"
- **Multiple projects (<6)**: List all and let them choose
- **Many projects (6+)**: List recent projects, offer to create new or specify by name/ID

### Step 2: Database Setup

**Get the connection string:**

- Use the MCP server to get the connection string for the selected project

**Configure it for their environment:**

- Most projects use a `.env` file with `DATABASE_URL`
- For other setups, check project structure and ask

**Before modifying .env:**

1. Try to read the .env file first
2. If readable: Use search_replace to update or append
3. If unreadable: Use append command or show the line to add manually:

```
DATABASE_URL=postgresql://user:password@host/database
```

### Step 3: Install Dependencies

Recommend drivers based on deployment platform and runtime. For detailed guidance, see `connection-methods.md`.

**Quick Recommendations:**

| Environment              | Driver                     | Install                                |
| ------------------------ | -------------------------- | -------------------------------------- |
| Vercel (Edge/Serverless) | `@neondatabase/serverless` | `npm install @neondatabase/serverless` |
| Cloudflare Workers       | `@neondatabase/serverless` | `npm install @neondatabase/serverless` |
| AWS Lambda               | `@neondatabase/serverless` | `npm install @neondatabase/serverless` |
| Traditional Node.js      | `pg`                       | `npm install pg`                       |
| Long-running servers     | `pg` with pooling          | `npm install pg`                       |

For detailed serverless driver usage, see `neon-serverless.md`.
For complex scenarios (multiple runtimes, hybrid architectures), reference `connection-methods.md`.

### Step 4: Understand the Project

**If it's an empty/new project:**
Ask briefly (1-2 questions):

- What are they building?
- Any specific technologies?

**If it's an established project:**
Skip questions - infer from codebase. Update relevant code to use the driver.

### Step 5: Authentication (Optional)

**Skip if project doesn't need auth** (CLI tools, scripts, static sites).

**If project could benefit from auth:**
Ask: "Does your app need user authentication? Neon Auth can handle sign-in/sign-up, social login, and session management."

**If they want auth:**

- Use MCP server `provision_neon_auth` tool
- Guide through framework-specific setup
- Configure environment variables
- Set up basic auth code

For detailed auth setup, see `neon-auth.md`. For auth + database queries, see `neon-js.md`.

### Step 6: ORM Setup

**Check for existing ORM** (Prisma, Drizzle, TypeORM).

**If no ORM found:**
Ask: "Want to set up an ORM for type-safe database queries?"

If yes, suggest based on project. If no, proceed with raw SQL.

For Drizzle ORM integration, see `neon-drizzle.md`.

### Step 7: Schema Setup

**Check for existing schema:**

- SQL migration files
- ORM schemas (Prisma, Drizzle)
- Database initialization scripts

**If existing schema found:**
Ask: "Found existing schema definitions. Want to migrate these to your Neon database?"

**If no schema:**
Ask if they want to:

1. Create a simple example schema (users table)
2. Design a custom schema together
3. Skip schema setup for now

**Example schema:**

```sql
CREATE TABLE users (
  id SERIAL PRIMARY KEY,
  email VARCHAR(255) UNIQUE NOT NULL,
  name VARCHAR(255),
  created_at TIMESTAMP DEFAULT NOW()
);
```

### Step 8: What's Next

"You're all set! Here are some things I can help with:

- Neon-specific features (branching, autoscaling, scale-to-zero)
- Connection pooling for production
- Writing queries or building API endpoints
- Database migrations and schema changes
- Performance optimization"

## Security Best Practices

1. Never commit connection strings to version control
2. Use environment variables for all credentials
3. Prefer SSL connections (default in Neon)
4. Use least-privilege database roles
5. Rotate API keys and passwords regularly

## Resume Support

If user says "Continue with Neon setup", check what's already configured:

- MCP server connection
- .env file with DATABASE_URL
- Dependencies installed
- Schema created

Then resume from where they left off.

## Developer Tools

For the best development experience, set up Neon's developer tools:

```bash
npx neon init
```

This installs the VSCode extension and configures the MCP server for AI-assisted development.

For detailed setup instructions, see `devtools.md`.

## Documentation Resources

| Topic              | URL                                                 |
| ------------------ | --------------------------------------------------- |
| Getting Started    | https://neon.com/docs/get-started/signing-up       |
| Connecting to Neon | https://neon.com/docs/connect/connect-intro        |
| Connection String  | https://neon.com/docs/connect/connect-from-any-app |
| Frameworks Guide   | https://neon.com/docs/get-started/frameworks       |
| ORMs Guide         | https://neon.com/docs/get-started/orms             |
| VSCode Extension   | https://neon.com/docs/local/vscode-extension       |
| MCP Server         | https://neon.com/docs/ai/neon-mcp-server           |
</file>

<file path=".agents/skills/neon-postgres/references/neon-auth.md">
# Neon Auth

Neon Auth provides authentication for your application. It's available as:

- `@neondatabase/auth` - Auth only (smaller bundle)
- `@neondatabase/neon-js` - Auth + Data API (full SDK, see `neon-js.md`)

For official documentation:

```bash
curl -H "Accept: text/markdown" https://neon.com/docs/auth/overview
```

## Package Selection

| Need                    | Package                 | Bundle  |
| ----------------------- | ----------------------- | ------- |
| Auth only               | `@neondatabase/auth`    | Smaller |
| Auth + Database queries | `@neondatabase/neon-js` | Full    |

## Installation

```bash
# Auth only
npm install @neondatabase/auth

# Auth + Data API
npm install @neondatabase/neon-js
```

## Quick Setup Patterns

### Next.js App Router

**1. API Route Handler:**

```typescript
// app/api/auth/[...path]/route.ts
import { authApiHandler } from "@neondatabase/auth/next";
export const { GET, POST } = authApiHandler();
```

**2. Auth Client:**

```typescript
// lib/auth/client.ts
import { createAuthClient } from "@neondatabase/auth/next";
export const authClient = createAuthClient();
```

**3. Use in Components:**

```typescript
"use client";
import { authClient } from "@/lib/auth/client";

function AuthStatus() {
  const session = authClient.useSession();
  if (session.isPending) return <div>Loading...</div>;
  if (!session.data) return <SignInButton />;
  return <div>Hello, {session.data.user.name}</div>;
}
```

### React SPA

```typescript
import { createAuthClient } from "@neondatabase/auth";
import { BetterAuthReactAdapter } from "@neondatabase/auth/react/adapters";

const authClient = createAuthClient(import.meta.env.VITE_NEON_AUTH_URL, {
  adapter: BetterAuthReactAdapter(),
});
```

### Node.js Backend

```typescript
import { createAuthClient } from "@neondatabase/auth";

const auth = createAuthClient(process.env.NEON_AUTH_URL!);
await auth.signIn.email({ email, password });
const session = await auth.getSession();
```

## Environment Variables

```bash
# Next.js (.env.local)
NEON_AUTH_BASE_URL=https://ep-xxx.neonauth.c-2.us-east-2.aws.neon.build/dbname/auth
NEXT_PUBLIC_NEON_AUTH_URL=https://ep-xxx.neonauth.c-2.us-east-2.aws.neon.build/dbname/auth

# Vite/React (.env)
VITE_NEON_AUTH_URL=https://ep-xxx.neonauth.c-2.us-east-2.aws.neon.build/dbname/auth
```

## Sub-Resources

For detailed documentation:

| Topic                    | Resource                       |
| ------------------------ | ------------------------------ |
| Next.js App Router setup | `neon-auth/setup-nextjs.md`    |
| React SPA setup          | `neon-auth/setup-react-spa.md` |
| Auth methods reference   | `neon-auth/auth-methods.md`    |
| UI components            | `neon-auth/ui-components.md`   |
| Common mistakes          | `neon-auth/common-mistakes.md` |

## Key Imports

```typescript
// Auth client (Next.js)
import { authApiHandler, createAuthClient } from "@neondatabase/auth/next";

// Auth client (vanilla)
import { createAuthClient } from "@neondatabase/auth";

// React adapter (NOT from main entry)
import { BetterAuthReactAdapter } from "@neondatabase/auth/react/adapters";

// UI components
import {
  NeonAuthUIProvider,
  AuthView,
  SignInForm,
} from "@neondatabase/auth/react/ui";
import { authViewPaths } from "@neondatabase/auth/react/ui/server";

// CSS
import "@neondatabase/auth/ui/css";
```

## Common Mistakes

1. **Wrong adapter import**: Import `BetterAuthReactAdapter` from `auth/react/adapters` subpath
2. **Forgetting to call adapter**: Use `BetterAuthReactAdapter()` with parentheses
3. **Missing CSS**: Import from `ui/css` or `ui/tailwind` (not both)
4. **Missing "use client"**: Required for components using `useSession()`
5. **Wrong createAuthClient signature**: First arg is URL: `createAuthClient(url, { adapter })`

See `neon-auth/common-mistakes.md` for detailed examples.
</file>

<file path=".agents/skills/neon-postgres/references/neon-cli.md">
# Neon CLI

The Neon CLI is a command-line interface for managing Neon Serverless Postgres directly from your terminal. It provides the same capabilities as the Neon Platform API and is ideal for scripting, CI/CD pipelines, and developers who prefer terminal workflows.

## Installation

**macOS (Homebrew):**

```bash
brew install neonctl
```

**npm (cross-platform):**

```bash
npm install -g neonctl
```

## Authentication

Authenticate with your Neon account:

```bash
neonctl auth
```

This opens a browser for OAuth authentication and stores credentials locally.

For CI/CD or non-interactive environments, use an API key:

```bash
export NEON_API_KEY=your-api-key
```

Get your API key from: https://console.neon.tech/app/settings/api-keys

## Common Commands

### Project Management

```bash
# List all projects
neonctl projects list

# Create a new project
neonctl projects create --name my-project

# Get project details
neonctl projects get <project-id>

# Delete a project
neonctl projects delete <project-id>
```

### Branch Operations

```bash
# List branches
neonctl branches list --project-id <project-id>

# Create a branch
neonctl branches create --project-id <project-id> --name dev

# Delete a branch
neonctl branches delete <branch-id> --project-id <project-id>
```

### Connection Strings

```bash
# Get connection string
neonctl connection-string --project-id <project-id>

# Get connection string for specific branch
neonctl connection-string --project-id <project-id> --branch-id <branch-id>

# Get pooled connection string
neonctl connection-string --project-id <project-id> --pooled
```

### SQL Execution

```bash
# Run SQL query
neonctl sql "SELECT * FROM users LIMIT 10" --project-id <project-id>

# Run SQL from file
neonctl sql --file schema.sql --project-id <project-id>
```

### Database Management

```bash
# List databases
neonctl databases list --project-id <project-id> --branch-id <branch-id>

# Create database
neonctl databases create --project-id <project-id> --name mydb

# List roles
neonctl roles list --project-id <project-id> --branch-id <branch-id>
```

## Output Formats

The CLI supports multiple output formats:

```bash
# JSON output (default for scripting)
neonctl projects list --output json

# Table output (human-readable)
neonctl projects list --output table

# YAML output
neonctl projects list --output yaml
```

## CI/CD Integration

Example GitHub Actions workflow:

```yaml
- name: Create preview branch
  env:
    NEON_API_KEY: ${{ secrets.NEON_API_KEY }}
  run: |
    neonctl branches create \
      --project-id ${{ vars.NEON_PROJECT_ID }} \
      --name preview-${{ github.event.pull_request.number }}
```

## CLI vs MCP Server vs SDKs

| Tool           | Best For                                          |
| -------------- | ------------------------------------------------- |
| Neon CLI       | Terminal workflows, scripts, CI/CD pipelines      |
| MCP Server     | AI-assisted development with Claude, Cursor, etc. |
| TypeScript SDK | Programmatic access in Node.js/TypeScript apps    |
| Python SDK     | Programmatic access in Python applications        |
| REST API       | Direct HTTP integration in any language           |

## Documentation Resources

| Topic          | URL                                                    |
| -------------- | ------------------------------------------------------ |
| CLI Reference  | https://neon.com/docs/reference/neon-cli              |
| CLI Install    | https://neon.com/docs/reference/cli-install           |
| CLI Auth       | https://neon.com/docs/reference/cli-auth              |
| CLI Projects   | https://neon.com/docs/reference/cli-projects          |
| CLI Branches   | https://neon.com/docs/reference/cli-branches          |
| CLI Connection | https://neon.com/docs/reference/cli-connection-string |

Fetch CLI documentation:

```bash
curl -H "Accept: text/markdown" https://neon.com/docs/reference/neon-cli
```
</file>

<file path=".agents/skills/neon-postgres/references/neon-drizzle.md">
# Neon and Drizzle Integration

Integration patterns, configurations, and optimizations for using **Drizzle ORM** with **Neon** Postgres.

For official documentation:

```bash
curl -H "Accept: text/markdown" https://neon.com/docs/guides/drizzle
```

## Choosing the Right Driver

Drizzle ORM works with multiple Postgres drivers. See `connection-methods.md` for the full decision tree.

| Platform                | TCP Support | Pooling             | Recommended Driver         |
| ----------------------- | ----------- | ------------------- | -------------------------- |
| Vercel (Fluid)          | Yes         | `@vercel/functions` | `pg` (node-postgres)       |
| Cloudflare (Hyperdrive) | Yes         | Hyperdrive          | `pg` (node-postgres)       |
| Cloudflare Workers      | No          | No                  | `@neondatabase/serverless` |
| Netlify Functions       | No          | No                  | `@neondatabase/serverless` |
| Deno Deploy             | No          | No                  | `@neondatabase/serverless` |
| Railway / Render        | Yes         | Built-in            | `pg` (node-postgres)       |

## Connection Setup

### 1. TCP with node-postgres (Long-Running Servers)

Best for Railway, Render, traditional VPS.

```bash
npm install drizzle-orm pg
npm install -D drizzle-kit @types/pg dotenv
```

```typescript
// src/db.ts
import { drizzle } from "drizzle-orm/node-postgres";
import { Pool } from "pg";

const pool = new Pool({ connectionString: process.env.DATABASE_URL });
export const db = drizzle({ client: pool });
```

### 2. Vercel Fluid Compute with Connection Pooling

```bash
npm install drizzle-orm pg @vercel/functions
npm install -D drizzle-kit @types/pg
```

```typescript
// src/db.ts
import { attachDatabasePool } from "@vercel/functions";
import { drizzle } from "drizzle-orm/node-postgres";
import { Pool } from "pg";
import * as schema from "./schema";

const pool = new Pool({ connectionString: process.env.DATABASE_URL });
attachDatabasePool(pool);

export const db = drizzle({ client: pool, schema });
```

### 3. HTTP Adapter (Edge Without TCP)

For Cloudflare Workers, Netlify Edge, Deno Deploy. Does NOT support interactive transactions.

```bash
npm install drizzle-orm @neondatabase/serverless
npm install -D drizzle-kit dotenv
```

```typescript
// src/db.ts
import { drizzle } from "drizzle-orm/neon-http";
import { neon } from "@neondatabase/serverless";

const sql = neon(process.env.DATABASE_URL!);
export const db = drizzle(sql);
```

### 4. WebSocket Adapter (Edge with Transactions)

```bash
npm install drizzle-orm @neondatabase/serverless ws
npm install -D drizzle-kit dotenv @types/ws
```

```typescript
// src/db.ts
import { drizzle } from "drizzle-orm/neon-serverless";
import { Pool, neonConfig } from "@neondatabase/serverless";
import ws from "ws";

neonConfig.webSocketConstructor = ws; // Required for Node.js < v22

const pool = new Pool({ connectionString: process.env.DATABASE_URL });
export const db = drizzle(pool);
```

## Drizzle Config

```typescript
// drizzle.config.ts
import { config } from "dotenv";
import { defineConfig } from "drizzle-kit";

config({ path: ".env.local" });

export default defineConfig({
  schema: "./src/schema.ts",
  out: "./drizzle",
  dialect: "postgresql",
  dbCredentials: {
    url: process.env.DATABASE_URL!,
  },
});
```

## Migrations

```bash
# Generate migrations
npx drizzle-kit generate

# Apply migrations
npx drizzle-kit migrate
```

## Schema Definition

```typescript
// src/schema.ts
import { pgTable, serial, text, integer, timestamp } from "drizzle-orm/pg-core";

export const usersTable = pgTable("users", {
  id: serial("id").primaryKey(),
  name: text("name").notNull(),
  email: text("email").notNull().unique(),
  role: text("role").default("user").notNull(),
  createdAt: timestamp("created_at").defaultNow().notNull(),
});

export type User = typeof usersTable.$inferSelect;
export type NewUser = typeof usersTable.$inferInsert;

export const postsTable = pgTable("posts", {
  id: serial("id").primaryKey(),
  title: text("title").notNull(),
  content: text("content").notNull(),
  userId: integer("user_id")
    .notNull()
    .references(() => usersTable.id, { onDelete: "cascade" }),
  createdAt: timestamp("created_at").defaultNow().notNull(),
});

export type Post = typeof postsTable.$inferSelect;
export type NewPost = typeof postsTable.$inferInsert;
```

## Query Patterns

### Batch Inserts

```typescript
export async function batchInsertUsers(users: NewUser[]) {
  return db.insert(usersTable).values(users).returning();
}
```

### Prepared Statements

```typescript
import { sql } from "drizzle-orm";

export const getUsersByRolePrepared = db
  .select()
  .from(usersTable)
  .where(sql`${usersTable.role} = $1`)
  .prepare("get_users_by_role");

// Usage: getUsersByRolePrepared.execute(['admin'])
```

### Transactions

```typescript
export async function createUserWithPosts(user: NewUser, posts: NewPost[]) {
  return await db.transaction(async (tx) => {
    const [newUser] = await tx.insert(usersTable).values(user).returning();

    if (posts.length > 0) {
      await tx.insert(postsTable).values(
        posts.map((post) => ({
          ...post,
          userId: newUser.id,
        })),
      );
    }

    return newUser;
  });
}
```

## Working with Neon Branches

```typescript
import { drizzle } from "drizzle-orm/neon-http";
import { neon } from "@neondatabase/serverless";

const getBranchUrl = () => {
  const env = process.env.NODE_ENV;
  if (env === "development") return process.env.DEV_DATABASE_URL;
  if (env === "test") return process.env.TEST_DATABASE_URL;
  return process.env.DATABASE_URL;
};

const sql = neon(getBranchUrl()!);
export const db = drizzle({ client: sql });
```

## Error Handling

```typescript
export async function safeNeonOperation<T>(
  operation: () => Promise<T>,
): Promise<T> {
  try {
    return await operation();
  } catch (error: any) {
    if (error.message?.includes("connection pool timeout")) {
      console.error("Neon connection pool timeout");
    }
    throw error;
  }
}
```

## Best Practices

1. **Connection Management** - See `connection-methods.md` for platform-specific guidance
2. **Neon Features** - Utilize branching for development/testing (see `features.md`)
3. **Query Optimization** - Batch operations, use prepared statements
4. **Schema Design** - Leverage Postgres-specific features, use appropriate indexes
</file>

<file path=".agents/skills/neon-postgres/references/neon-js.md">
# Neon JS SDK

The `@neondatabase/neon-js` SDK provides a unified client for Neon Auth and Data API. It combines authentication handling with PostgREST-compatible database queries.

**Auth only?** Use `neon-auth.md` instead for smaller bundle size.

For official documentation:

```bash
curl -H "Accept: text/markdown" https://neon.com/docs/reference/javascript-sdk
```

## Package Selection

| Use Case        | Package                      | Notes               |
| --------------- | ---------------------------- | ------------------- |
| Auth + Data API | `@neondatabase/neon-js`      | Full SDK            |
| Auth only       | `@neondatabase/auth`         | Smaller bundle      |
| Data API only   | `@neondatabase/postgrest-js` | Bring your own auth |

## Installation

```bash
npm install @neondatabase/neon-js
```

## Quick Setup Patterns

### Next.js (Most Common)

**1. API Route Handler:**

```typescript
// app/api/auth/[...path]/route.ts
import { authApiHandler } from "@neondatabase/neon-js/auth/next";
export const { GET, POST } = authApiHandler();
```

**2. Auth Client:**

```typescript
// lib/auth/client.ts
import { createAuthClient } from "@neondatabase/neon-js/auth/next";
export const authClient = createAuthClient();
```

**3. Database Client:**

```typescript
// lib/db/client.ts
import { createClient } from "@neondatabase/neon-js";
import type { Database } from "./database.types";

export const dbClient = createClient<Database>({
  auth: { url: process.env.NEXT_PUBLIC_NEON_AUTH_URL! },
  dataApi: { url: process.env.NEON_DATA_API_URL! },
});
```

### React SPA

```typescript
import { createClient } from "@neondatabase/neon-js";
import { BetterAuthReactAdapter } from "@neondatabase/neon-js/auth/react/adapters";

const client = createClient<Database>({
  auth: {
    adapter: BetterAuthReactAdapter(),
    url: import.meta.env.VITE_NEON_AUTH_URL,
  },
  dataApi: { url: import.meta.env.VITE_NEON_DATA_API_URL },
});
```

### Node.js Backend

```typescript
import { createClient } from "@neondatabase/neon-js";

const client = createClient<Database>({
  auth: { url: process.env.NEON_AUTH_URL! },
  dataApi: { url: process.env.NEON_DATA_API_URL! },
});
```

## Environment Variables

```bash
# Next.js (.env.local)
NEON_AUTH_BASE_URL=https://ep-xxx.neonauth.c-2.us-east-2.aws.neon.build/dbname/auth
NEXT_PUBLIC_NEON_AUTH_URL=https://ep-xxx.neonauth.c-2.us-east-2.aws.neon.build/dbname/auth
NEON_DATA_API_URL=https://ep-xxx.apirest.c-2.us-east-2.aws.neon.build/dbname/rest/v1

# Vite/React (.env)
VITE_NEON_AUTH_URL=https://ep-xxx.neonauth.c-2.us-east-2.aws.neon.build/dbname/auth
VITE_NEON_DATA_API_URL=https://ep-xxx.apirest.c-2.us-east-2.aws.neon.build/dbname/rest/v1
```

## Database Queries

All query methods follow PostgREST syntax (same as Supabase):

```typescript
// Select with filters
const { data } = await client
  .from("items")
  .select("id, name, status")
  .eq("status", "active")
  .order("created_at", { ascending: false })
  .limit(10);

// Insert
const { data, error } = await client
  .from("items")
  .insert({ name: "New Item", status: "pending" })
  .select()
  .single();

// Update
await client.from("items").update({ status: "completed" }).eq("id", 1);

// Delete
await client.from("items").delete().eq("id", 1);
```

For complete Data API query reference, see `neon-js/data-api.md`.

## Auth Methods

### BetterAuth API (Default)

```typescript
// Sign in/up
await client.auth.signIn.email({ email, password });
await client.auth.signUp.email({ email, password, name });
await client.auth.signOut();

// Get session
const session = await client.auth.getSession();

// Social sign-in
await client.auth.signIn.social({
  provider: "google",
  callbackURL: "/dashboard",
});
```

### Supabase-Compatible API

```typescript
import { createClient, SupabaseAuthAdapter } from "@neondatabase/neon-js";

const client = createClient({
  auth: { adapter: SupabaseAuthAdapter(), url },
  dataApi: { url },
});

await client.auth.signInWithPassword({ email, password });
await client.auth.signUp({ email, password });
const {
  data: { session },
} = await client.auth.getSession();
```

## Sub-Resources

| Topic            | Resource                     |
| ---------------- | ---------------------------- |
| Data API queries | `neon-js/data-api.md`        |
| Common mistakes  | `neon-js/common-mistakes.md` |

## Key Imports

```typescript
// Main client
import {
  createClient,
  SupabaseAuthAdapter,
  BetterAuthVanillaAdapter,
} from "@neondatabase/neon-js";

// Next.js integration
import {
  authApiHandler,
  createAuthClient,
} from "@neondatabase/neon-js/auth/next";

// React adapter (NOT from main entry - must use subpath)
import { BetterAuthReactAdapter } from "@neondatabase/neon-js/auth/react/adapters";

// UI components
import {
  NeonAuthUIProvider,
  AuthView,
  SignInForm,
} from "@neondatabase/neon-js/auth/react/ui";
import { authViewPaths } from "@neondatabase/neon-js/auth/react/ui/server";

// CSS (choose one)
import "@neondatabase/neon-js/ui/css"; // Without Tailwind
// @import '@neondatabase/neon-js/ui/tailwind'; // With Tailwind v4 (in CSS file)
```

## Generate Types

```bash
npx neon-js gen-types --db-url "postgresql://..." --output src/types/database.ts
```

## Common Mistakes

1. **Wrong adapter import**: Import `BetterAuthReactAdapter` from `auth/react/adapters` subpath
2. **Forgetting to call adapter**: Use `SupabaseAuthAdapter()` with parentheses
3. **Missing CSS import**: Import from `ui/css` or `ui/tailwind` (not both)
4. **Wrong package for auth-only**: Use `@neondatabase/auth` for smaller bundle
5. **Missing "use client"**: Required for auth client components

See `neon-js/common-mistakes.md` for detailed examples.
</file>

<file path=".agents/skills/neon-postgres/references/neon-platform-api.md">
# Neon Platform API

The Neon Platform API allows you to manage Neon projects, branches, databases, and resources programmatically. You can use the REST API directly or through official SDKs.

## Options

| Method         | Package/URL                         | Best For                        |
| -------------- | ----------------------------------- | ------------------------------- |
| REST API       | `https://console.neon.tech/api/v2/` | Any language, direct HTTP calls |
| TypeScript SDK | `@neondatabase/api-client`          | Node.js, TypeScript projects    |
| Python SDK     | `neon-api`                          | Python scripts and applications |
| CLI            | `neonctl`                           | Terminal-based management       |

## Documentation

```bash
# REST API documentation
curl -H "Accept: text/markdown" https://neon.com/docs/reference/api-reference

# TypeScript SDK
curl -H "Accept: text/markdown" https://neon.com/docs/reference/typescript-sdk

# Python SDK
curl -H "Accept: text/markdown" https://neon.com/docs/reference/python-sdk

# CLI
curl -H "Accept: text/markdown" https://neon.com/docs/reference/neon-cli
```

For the interactive API reference: https://api-docs.neon.tech/reference/getting-started-with-neon-api

## Sub-Resources

For detailed information, reference the appropriate sub-resource:

### REST API Details

| Topic                         | Resource                         |
| ----------------------------- | -------------------------------- |
| Guidelines, Auth, Rate Limits | `neon-rest-api/guidelines.md`    |
| Projects                      | `neon-rest-api/projects.md`      |
| Branches, Databases, Roles    | `neon-rest-api/branches.md`      |
| Compute Endpoints             | `neon-rest-api/endpoints.md`     |
| API Keys                      | `neon-rest-api/keys.md`          |
| Operations                    | `neon-rest-api/operations.md`    |
| Organizations                 | `neon-rest-api/organizations.md` |

### SDKs

| Language   | Resource                 |
| ---------- | ------------------------ |
| TypeScript | `neon-typescript-sdk.md` |
| Python     | `neon-python-sdk.md`     |

## Quick Start

### Authentication

All API requests require a Neon API key:

```bash
Authorization: Bearer $NEON_API_KEY
```

### API Key Types

| Type           | Scope                           | Best For                      |
| -------------- | ------------------------------- | ----------------------------- |
| Personal       | All projects user has access to | Individual use, scripting     |
| Organization   | Entire organization             | CI/CD, org-wide automation    |
| Project-scoped | Single project only             | Project-specific integrations |

### Rate Limits

- 700 requests per minute (~11 per second)
- Bursts up to 40 requests per second per route
- Handle `429 Too Many Requests` with retry/backoff

## Common Operations Quick Reference

| Operation          | REST API                                   | TypeScript SDK              | Python SDK            |
| ------------------ | ------------------------------------------ | --------------------------- | --------------------- |
| List Projects      | `GET /projects`                            | `listProjects({})`          | `projects()`          |
| Create Project     | `POST /projects`                           | `createProject({...})`      | `project_create(...)` |
| Get Connection URI | `GET /projects/{id}/connection_uri`        | `getConnectionUri({...})`   | `connection_uri(...)` |
| Create Branch      | `POST /projects/{id}/branches`             | `createProjectBranch(...)`  | `branch_create(...)`  |
| Start Endpoint     | `POST /projects/{id}/endpoints/{id}/start` | `startProjectEndpoint(...)` | `endpoint_start(...)` |

## Error Handling

| Status | Meaning      | Action                       |
| ------ | ------------ | ---------------------------- |
| 401    | Unauthorized | Check API key                |
| 404    | Not Found    | Verify resource ID           |
| 429    | Rate Limited | Implement retry with backoff |
| 500    | Server Error | Retry or contact support     |
</file>

<file path=".agents/skills/neon-postgres/references/neon-python-sdk.md">
# Neon Python SDK

The `neon-api` Python SDK is a Pythonic wrapper around the Neon REST API. It provides methods for managing all Neon resources, including projects, branches, endpoints, roles, and databases.

For core concepts (Organization, Project, Branch, Endpoint, etc.), see `what-is-neon.md`.

## Documentation

```bash
curl -H "Accept: text/markdown" https://neon.com/docs/reference/python-sdk
```

## Installation

```bash
pip install neon-api
```

## Authentication

```python
import os
from neon_api import NeonAPI

api_key = os.getenv("NEON_API_KEY")
if not api_key:
    raise ValueError("NEON_API_KEY environment variable is not set.")

neon = NeonAPI(api_key=api_key)
```

## Projects

### List Projects

```python
all_projects = neon.projects()
```

### Create Project

```python
new_project = neon.project_create(
    project={
        'name': 'my-new-project',
        'pg_version': 17
    }
)
```

### Get Project Details

```python
project = neon.project(project_id='your-project-id')
```

### Update Project

```python
neon.project_update(
    project_id='your-project-id',
    project={
        'name': 'renamed-project',
        'default_endpoint_settings': {
            'autoscaling_limit_min_cu': 1,
            'autoscaling_limit_max_cu': 2,
        }
    }
)
```

### Delete Project

```python
neon.project_delete(project_id='project-to-delete')
```

### Get Connection URI

```python
uri = neon.connection_uri(
    project_id='your-project-id',
    database_name='neondb',
    role_name='neondb_owner'
)
print(f"Connection URI: {uri.uri}")
```

## Branches

### Create Branch

```python
new_branch = neon.branch_create(
    project_id='your-project-id',
    branch={'name': 'feature-branch'},
    endpoints=[
        {'type': 'read_write', 'autoscaling_limit_max_cu': 1}
    ]
)
```

### List Branches

```python
branches = neon.branches(project_id='your-project-id')
```

### Get Branch Details

```python
branch = neon.branch(project_id='your-project-id', branch_id='br-xxx')
```

### Update Branch

```python
neon.branch_update(
    project_id='your-project-id',
    branch_id='br-xxx',
    branch={'name': 'updated-branch-name'}
)
```

### Delete Branch

```python
neon.branch_delete(project_id='your-project-id', branch_id='br-xxx')
```

## Databases

### Create Database

```python
neon.database_create(
    project_id='your-project-id',
    branch_id='br-xxx',
    database={'name': 'my-app-db', 'owner_name': 'neondb_owner'}
)
```

### List Databases

```python
databases = neon.databases(project_id='your-project-id', branch_id='br-xxx')
```

### Delete Database

```python
neon.database_delete(
    project_id='your-project-id',
    branch_id='br-xxx',
    database_id='my-app-db'
)
```

## Roles

### Create Role

```python
new_role = neon.role_create(
    project_id='your-project-id',
    branch_id='br-xxx',
    role_name='app_user'
)
print(f"Password: {new_role.role.password}")
```

### List Roles

```python
roles = neon.roles(project_id='your-project-id', branch_id='br-xxx')
```

### Delete Role

```python
neon.role_delete(
    project_id='your-project-id',
    branch_id='br-xxx',
    role_name='app_user'
)
```

## Endpoints

### Create Endpoint

```python
neon.endpoint_create(
    project_id='your-project-id',
    endpoint={
        'branch_id': 'br-xxx',
        'type': 'read_only'
    }
)
```

### Start/Suspend Endpoint

```python
# Start
neon.endpoint_start(project_id='your-project-id', endpoint_id='ep-xxx')

# Suspend
neon.endpoint_suspend(project_id='your-project-id', endpoint_id='ep-xxx')
```

### Update Endpoint

```python
neon.endpoint_update(
    project_id='your-project-id',
    endpoint_id='ep-xxx',
    endpoint={'autoscaling_limit_max_cu': 2}
)
```

### Delete Endpoint

```python
neon.endpoint_delete(project_id='your-project-id', endpoint_id='ep-xxx')
```

## API Keys

### List API Keys

```python
api_keys = neon.api_keys()
```

### Create API Key

```python
new_key = neon.api_key_create(key_name='my-script-key')
print(f"Key (store securely!): {new_key.key}")
```

### Revoke API Key

```python
neon.api_key_revoke(1234)  # key ID
```

## Operations

### List Operations

```python
ops = neon.operations(project_id='your-project-id')
```

### Get Operation Details

```python
op = neon.operation(project_id='your-project-id', operation_id='op-xxx')
```
</file>

<file path=".agents/skills/neon-postgres/references/neon-serverless.md">
# Neon Serverless Driver

Patterns and best practices for connecting to Neon databases in serverless environments using the `@neondatabase/serverless` driver. The driver connects over **HTTP** for fast, single queries or **WebSockets** for `node-postgres` compatibility and interactive transactions.

For official documentation:

```bash
curl -H "Accept: text/markdown" https://neon.com/docs/serverless/serverless-driver
```

## Installation

```bash
# Using npm
npm install @neondatabase/serverless

# Using JSR
bunx jsr add @neon/serverless
```

**Note:** Version 1.0.0+ requires **Node.js v19 or later**.

For projects that depend on `pg` but want to use Neon's WebSocket-based connection pool:

```json
"dependencies": {
  "pg": "npm:@neondatabase/serverless@^0.10.4"
},
"overrides": {
  "pg": "npm:@neondatabase/serverless@^0.10.4"
}
```

## Connection String

Always use environment variables:

```typescript
// For HTTP queries
import { neon } from "@neondatabase/serverless";
const sql = neon(process.env.DATABASE_URL!);

// For WebSocket connections
import { Pool } from "@neondatabase/serverless";
const pool = new Pool({ connectionString: process.env.DATABASE_URL! });
```

**Never hardcode credentials:**

```typescript
// AVOID
const sql = neon("postgres://username:password@host.neon.tech/neondb");
```

## HTTP Queries with `neon` function

Ideal for simple, "one-shot" queries in serverless/edge environments. Uses HTTP `fetch` - fastest method for single queries.

### Parameterized Queries

Use tagged template literals for safe parameter interpolation:

```typescript
const [post] = await sql`SELECT * FROM posts WHERE id = ${postId}`;
```

For manually constructed queries:

```typescript
const [post] = await sql.query("SELECT * FROM posts WHERE id = $1", [postId]);
```

**Never concatenate user input:**

```typescript
// AVOID: SQL Injection Risk
const [post] = await sql("SELECT * FROM posts WHERE id = " + postId);
```

### Configuration Options

```typescript
// Return rows as arrays instead of objects
const sqlArrayMode = neon(process.env.DATABASE_URL!, { arrayMode: true });
const rows = await sqlArrayMode`SELECT id, title FROM posts`;
// rows -> [[1, "First Post"], [2, "Second Post"]]

// Get full results including row count and field metadata
const sqlFull = neon(process.env.DATABASE_URL!, { fullResults: true });
const result = await sqlFull`SELECT * FROM posts LIMIT 1`;
// result -> { rows: [...], fields: [...], rowCount: 1, ... }
```

## WebSocket Connections with `Pool` and `Client`

Use for `node-postgres` compatibility, interactive transactions, or session support.

### WebSocket Configuration

For Node.js v21 and earlier:

```typescript
import { Pool, neonConfig } from "@neondatabase/serverless";
import ws from "ws";

// Required for Node.js < v22
neonConfig.webSocketConstructor = ws;

const pool = new Pool({ connectionString: process.env.DATABASE_URL! });
```

### Serverless Lifecycle Management

Create, use, and close the pool within the same invocation:

```typescript
// Vercel Edge Functions example
export default async (req: Request, ctx: ExecutionContext) => {
  const pool = new Pool({ connectionString: process.env.DATABASE_URL! });

  try {
    const { rows } = await pool.query("SELECT * FROM users");
    return new Response(JSON.stringify(rows));
  } catch (err) {
    console.error(err);
    return new Response("Database error", { status: 500 });
  } finally {
    ctx.waitUntil(pool.end());
  }
};
```

**Avoid** creating a global `Pool` instance outside the handler.

## Transactions

### HTTP Transactions

For running multiple queries in a single, non-interactive transaction:

```typescript
const [newUser, newProfile] = await sql.transaction(
  [
    sql`INSERT INTO users(name) VALUES(${name}) RETURNING id`,
    sql`INSERT INTO profiles(user_id, bio) VALUES(${userId}, ${bio})`,
  ],
  {
    isolationLevel: "ReadCommitted",
    readOnly: false,
  },
);
```

### Interactive Transactions

For complex transactions with conditional logic:

```typescript
const pool = new Pool({ connectionString: process.env.DATABASE_URL! });
const client = await pool.connect();
try {
  await client.query("BEGIN");
  const {
    rows: [{ id }],
  } = await client.query("INSERT INTO users(name) VALUES($1) RETURNING id", [
    name,
  ]);
  await client.query("INSERT INTO profiles(user_id, bio) VALUES($1, $2)", [
    id,
    bio,
  ]);
  await client.query("COMMIT");
} catch (err) {
  await client.query("ROLLBACK");
  throw err;
} finally {
  client.release();
  await pool.end();
}
```

## Environment-Specific Optimizations

```javascript
// For Vercel Edge Functions, specify nearest region
export const config = {
  runtime: "edge",
  regions: ["iad1"], // Region nearest to your Neon DB
};

// For Cloudflare Workers, consider using Hyperdrive
// https://neon.com/blog/hyperdrive-neon-faq
```

## ORM Integration

For Drizzle ORM integration with the serverless driver, see `neon-drizzle.md`.

### Prisma

```typescript
import { neonConfig } from "@neondatabase/serverless";
import { PrismaNeon, PrismaNeonHTTP } from "@prisma/adapter-neon";
import { PrismaClient } from "@prisma/client";
import ws from "ws";

const connectionString = process.env.DATABASE_URL;
neonConfig.webSocketConstructor = ws;

// HTTP adapter
const adapterHttp = new PrismaNeonHTTP(connectionString!, {});
export const prismaClientHttp = new PrismaClient({ adapter: adapterHttp });

// WebSocket adapter
const adapterWs = new PrismaNeon({ connectionString });
export const prismaClientWs = new PrismaClient({ adapter: adapterWs });
```

### Kysely

```typescript
import { Pool } from "@neondatabase/serverless";
import { Kysely, PostgresDialect } from "kysely";

const dialect = new PostgresDialect({
  pool: new Pool({ connectionString: process.env.DATABASE_URL }),
});

const db = new Kysely({ dialect });
```

**NOTE:** Do not pass the `neon()` function to ORMs that expect a `node-postgres` compatible `Pool`.

## Error Handling

```javascript
// Pool error handling
const pool = new Pool({ connectionString: process.env.DATABASE_URL });
pool.on("error", (err) => {
  console.error("Unexpected error on idle client", err);
  process.exit(-1);
});

// Query error handling
try {
  const [post] = await sql`SELECT * FROM posts WHERE id = ${postId}`;
  if (!post) {
    return new Response("Not found", { status: 404 });
  }
} catch (err) {
  console.error("Database query failed:", err);
  return new Response("Server error", { status: 500 });
}
```
</file>

<file path=".agents/skills/neon-postgres/references/neon-typescript-sdk.md">
# Neon TypeScript SDK

The `@neondatabase/api-client` TypeScript SDK is a typed wrapper around the Neon REST API. It provides methods for managing all Neon resources, including projects, branches, endpoints, roles, and databases.

For core concepts (Organization, Project, Branch, Endpoint, etc.), see `what-is-neon.md`.

## Documentation

```bash
curl -H "Accept: text/markdown" https://neon.com/docs/reference/typescript-sdk
```

## Installation

```bash
npm install @neondatabase/api-client
```

## Authentication

```typescript
import { createApiClient } from "@neondatabase/api-client";

const apiKey = process.env.NEON_API_KEY;
if (!apiKey) {
  throw new Error("NEON_API_KEY environment variable is not set.");
}

const apiClient = createApiClient({ apiKey });
```

## Projects

### List Projects

```typescript
const response = await apiClient.listProjects({});
console.log("Projects:", response.data.projects);
```

### Create Project

```typescript
const response = await apiClient.createProject({
  project: { name: "my-project", pg_version: 17, region_id: "aws-us-east-2" },
});
console.log(
  "Connection URI:",
  response.data.connection_uris[0]?.connection_uri,
);
```

### Get Project

```typescript
const response = await apiClient.getProject("your-project-id");
```

### Update Project

```typescript
await apiClient.updateProject("your-project-id", {
  project: { name: "new-name" },
});
```

### Delete Project

```typescript
await apiClient.deleteProject("project-id");
```

### Get Connection URI

```typescript
const response = await apiClient.getConnectionUri({
  projectId: "your-project-id",
  database_name: "neondb",
  role_name: "neondb_owner",
  pooled: true,
});
console.log("URI:", response.data.uri);
```

## Branches

### Create Branch

```typescript
import { EndpointType } from "@neondatabase/api-client";

const response = await apiClient.createProjectBranch("your-project-id", {
  branch: { name: "feature-branch" },
  endpoints: [{ type: EndpointType.ReadWrite, autoscaling_limit_max_cu: 1 }],
});
```

### List Branches

```typescript
const response = await apiClient.listProjectBranches({
  projectId: "your-project-id",
});
```

### Get Branch

```typescript
const response = await apiClient.getProjectBranch("your-project-id", "br-xxx");
```

### Update Branch

```typescript
await apiClient.updateProjectBranch("your-project-id", "br-xxx", {
  branch: { name: "updated-name" },
});
```

### Delete Branch

```typescript
await apiClient.deleteProjectBranch("your-project-id", "br-xxx");
```

## Databases

### Create Database

```typescript
await apiClient.createProjectBranchDatabase("your-project-id", "br-xxx", {
  database: { name: "my-app-db", owner_name: "neondb_owner" },
});
```

### List Databases

```typescript
const response = await apiClient.listProjectBranchDatabases(
  "your-project-id",
  "br-xxx",
);
```

### Delete Database

```typescript
await apiClient.deleteProjectBranchDatabase(
  "your-project-id",
  "br-xxx",
  "my-app-db",
);
```

## Roles

### Create Role

```typescript
const response = await apiClient.createProjectBranchRole(
  "your-project-id",
  "br-xxx",
  {
    role: { name: "app_user" },
  },
);
console.log("Password:", response.data.role.password);
```

### List Roles

```typescript
const response = await apiClient.listProjectBranchRoles(
  "your-project-id",
  "br-xxx",
);
```

### Delete Role

```typescript
await apiClient.deleteProjectBranchRole(
  "your-project-id",
  "br-xxx",
  "app_user",
);
```

## Endpoints

### Create Endpoint

```typescript
import { EndpointType } from "@neondatabase/api-client";

const response = await apiClient.createProjectEndpoint("your-project-id", {
  endpoint: { branch_id: "br-xxx", type: EndpointType.ReadOnly },
});
```

### List Endpoints

```typescript
const response = await apiClient.listProjectEndpoints("your-project-id");
```

### Start/Suspend/Restart Endpoint

```typescript
// Start
await apiClient.startProjectEndpoint("your-project-id", "ep-xxx");

// Suspend
await apiClient.suspendProjectEndpoint("your-project-id", "ep-xxx");

// Restart
await apiClient.restartProjectEndpoint("your-project-id", "ep-xxx");
```

### Update Endpoint

```typescript
await apiClient.updateProjectEndpoint("your-project-id", "ep-xxx", {
  endpoint: { autoscaling_limit_max_cu: 2 },
});
```

### Delete Endpoint

```typescript
await apiClient.deleteProjectEndpoint("your-project-id", "ep-xxx");
```

## API Keys

### List API Keys

```typescript
const response = await apiClient.listApiKeys();
```

### Create API Key

```typescript
const response = await apiClient.createApiKey({ key_name: "my-script-key" });
console.log("Key:", response.data.key); // Store securely!
```

### Revoke API Key

```typescript
await apiClient.revokeApiKey(1234);
```

## Operations

### List Operations

```typescript
const response = await apiClient.listProjectOperations({
  projectId: "your-project-id",
});
```

### Get Operation

```typescript
const response = await apiClient.getProjectOperation(
  "your-project-id",
  "op-xxx",
);
```

## Organizations

### Get Organization

```typescript
const response = await apiClient.getOrganization("org-xxx");
```

### List Members

```typescript
const response = await apiClient.getOrganizationMembers("org-xxx");
```

### Create Org API Key

```typescript
const response = await apiClient.createOrgApiKey("org-xxx", {
  key_name: "ci-key",
  project_id: "project-xxx", // Optional: scope to project
});
```

### Invite Member

```typescript
import { MemberRole } from "@neondatabase/api-client";

await apiClient.createOrganizationInvitations("org-xxx", {
  invitations: [{ email: "dev@example.com", role: MemberRole.Member }],
});
```

## Error Handling

```typescript
async function safeApiOperation(projectId: string) {
  try {
    const response = await apiClient.getProject(projectId);
    return response.data;
  } catch (error: any) {
    if (error.isAxiosError) {
      const status = error.response?.status;
      switch (status) {
        case 401:
          console.error("Check your NEON_API_KEY");
          break;
        case 404:
          console.error("Resource not found");
          break;
        case 429:
          console.error("Rate limit exceeded");
          break;
        default:
          console.error("API error:", error.response?.data?.message);
      }
    }
    return null;
  }
}
```
</file>

<file path=".agents/skills/neon-postgres/references/referencing-docs.md">
# Referencing Neon Docs

The Neon documentation is the source of truth for all Neon-related information. Always verify Neon-related claims, configurations, and best practices against the official documentation.

## Getting the Documentation Index

To get a list of all available Neon documentation pages:

```bash
curl https://neon.com/llms.txt
```

This returns an index of all documentation pages with their URLs and descriptions.

## Fetching Individual Documentation Pages

To fetch any documentation page as markdown for review:

```bash
curl -H "Accept: text/markdown" https://neon.com/docs/<path>
```

**Examples:**

```bash
# Fetch the API reference
curl -H "Accept: text/markdown" https://neon.com/docs/reference/api-reference

# Fetch connection pooling docs
curl -H "Accept: text/markdown" https://neon.com/docs/connect/connection-pooling

# Fetch branching documentation
curl -H "Accept: text/markdown" https://neon.com/docs/introduction/branching

# Fetch serverless driver docs
curl -H "Accept: text/markdown" https://neon.com/docs/serverless/serverless-driver
```

## Common Documentation Paths

| Topic              | Path                                 |
| ------------------ | ------------------------------------ |
| Introduction       | `/docs/introduction`                 |
| Branching          | `/docs/introduction/branching`       |
| Autoscaling        | `/docs/introduction/autoscaling`     |
| Scale to Zero      | `/docs/introduction/scale-to-zero`   |
| Connection Pooling | `/docs/connect/connection-pooling`   |
| Serverless Driver  | `/docs/serverless/serverless-driver` |
| JavaScript SDK     | `/docs/reference/javascript-sdk`     |
| API Reference      | `/docs/reference/api-reference`      |
| TypeScript SDK     | `/docs/reference/typescript-sdk`     |
| Python SDK         | `/docs/reference/python-sdk`         |

## Framework and Language Guides

```bash
# Next.js
curl -H "Accept: text/markdown" https://neon.com/docs/guides/nextjs

# Django
curl -H "Accept: text/markdown" https://neon.com/docs/guides/django

# Drizzle ORM
curl -H "Accept: text/markdown" https://neon.com/docs/guides/drizzle

# Prisma
curl -H "Accept: text/markdown" https://neon.com/docs/guides/prisma
```

## Best Practices

1. **Always verify** - When answering questions about Neon features, APIs, or configurations, fetch the relevant documentation to verify your response is accurate.

2. **Check llms.txt first** - If you're unsure which documentation page covers a topic, fetch the llms.txt index to find the relevant URL. Don't make up URLs.

3. **Docs are the source of truth** - If there's any conflict between your training data and the documentation, the documentation is correct. Neon features and APIs evolve, so always defer to the current docs.

4. **Cite your sources** - When providing information from the docs, reference the documentation URL so users can read more if needed.
</file>

<file path=".agents/skills/neon-postgres/references/what-is-neon.md">
# What is Neon

Neon is a serverless Postgres platform designed to help you build reliable and scalable applications faster. It separates compute and storage to offer modern developer features such as autoscaling, branching, instant restore, and scale-to-zero.

For the full introduction, fetch the official docs:

```bash
curl -H "Accept: text/markdown" https://neon.com/docs/introduction
```

## Core Concepts

Understanding Neon's resource hierarchy is essential for working with the platform effectively.

| Concept          | Description                                                           | Key Relationship          |
| ---------------- | --------------------------------------------------------------------- | ------------------------- |
| Organization     | Highest-level container for billing, users, and projects              | Contains Projects         |
| Project          | Primary container for all database resources for an application       | Contains Branches         |
| Branch           | Lightweight, copy-on-write clone of database state                    | Contains Databases, Roles |
| Compute Endpoint | Running PostgreSQL instance (CPU/RAM for queries)                     | Attached to a Branch      |
| Database         | Logical container for data (tables, schemas, views)                   | Exists within a Branch    |
| Role             | PostgreSQL role for authentication and authorization                  | Belongs to a Branch       |
| Operation        | Async action by the control plane (creating branch, starting compute) | Associated with Project   |

## Key Differentiators

1. **Serverless Architecture**: Compute scales automatically and can suspend when idle
2. **Branching**: Create instant database copies without duplicating storage
3. **Separation of Compute and Storage**: Pay for compute only when active
4. **Postgres Compatible**: Works with any Postgres driver, ORM, or tool

## Documentation Resources

| Topic                  | Documentation URL                                         |
| ---------------------- | --------------------------------------------------------- |
| Introduction           | https://neon.com/docs/introduction                       |
| Architecture           | https://neon.com/docs/introduction/architecture-overview |
| Plans & Billing        | https://neon.com/docs/introduction/about-billing         |
| Regions                | https://neon.com/docs/introduction/regions               |
| Postgres Compatibility | https://neon.com/docs/reference/compatibility            |

```bash
# Fetch architecture docs
curl -H "Accept: text/markdown" https://neon.com/docs/introduction/architecture-overview

# Fetch plans and billing
curl -H "Accept: text/markdown" https://neon.com/docs/introduction/about-billing
```

## When to Use Neon

Neon is ideal for:

- **Serverless applications**: Functions that need database access without managing connections
- **Development workflows**: Branch databases like code for isolated testing
- **Variable workloads**: Auto-scale during traffic spikes, scale to zero when idle
- **Cost optimization**: Pay only for active compute time and storage used
</file>

<file path=".agents/skills/neon-postgres/SKILL.md">
---
name: neon-postgres
description: Guides and best practices for working with Neon Serverless Postgres. Covers getting started, local development with Neon, choosing a connection method, Neon features, authentication (@neondatabase/auth), PostgREST-style data API (@neondatabase/neon-js), Neon CLI, and Neon's Platform API/SDKs. Use for any Neon-related questions.
---

# Neon Serverless Postgres

Neon is a serverless Postgres platform that separates compute and storage to offer autoscaling, branching, instant restore, and scale-to-zero. It's fully compatible with Postgres and works with any language, framework, or ORM that supports Postgres.

## Neon Documentation

Always reference the Neon documentation before making Neon-related claims. The documentation is the source of truth for all Neon-related information.

Below you'll find a list of resources organized by area of concern. This is meant to support you find the right documentation pages to fetch and add a bit of additonal context.

You can use the `curl` commands to fetch the documentation page as markdown:

**Documentation:**

```bash
# Get list of all Neon docs
curl https://neon.com/llms.txt

# Fetch any doc page as markdown
curl -H "Accept: text/markdown" https://neon.com/docs/<path>
```

Don't guess docs pages. Use the `llms.txt` index to find the relevant URL or follow the links in the resources below.

## Overview of Resources

Reference the appropriate resource file based on the user's needs:

### Core Guides

| Area               | Resource                           | When to Use                                                    |
| ------------------ | ---------------------------------- | -------------------------------------------------------------- |
| What is Neon       | `references/what-is-neon.md`       | Understanding Neon concepts, architecture, core resources      |
| Referencing Docs   | `references/referencing-docs.md`   | Looking up official documentation, verifying information       |
| Features           | `references/features.md`           | Branching, autoscaling, scale-to-zero, instant restore         |
| Getting Started    | `references/getting-started.md`    | Setting up a project, connection strings, dependencies, schema |
| Connection Methods | `references/connection-methods.md` | Choosing drivers based on platform and runtime                 |
| Developer Tools    | `references/devtools.md`           | VSCode extension, MCP server, Neon CLI (`neon init`)           |

### Database Drivers & ORMs

HTTP/WebSocket queries for serverless/edge functions.

| Area              | Resource                        | When to Use                                         |
| ----------------- | ------------------------------- | --------------------------------------------------- |
| Serverless Driver | `references/neon-serverless.md` | `@neondatabase/serverless` - HTTP/WebSocket queries |
| Drizzle ORM       | `references/neon-drizzle.md`    | Drizzle ORM integration with Neon                   |

### Auth & Data API SDKs

Authentication and PostgREST-style data API for Neon.

| Area        | Resource                  | When to Use                                                         |
| ----------- | ------------------------- | ------------------------------------------------------------------- |
| Neon Auth   | `references/neon-auth.md` | `@neondatabase/auth` - Authentication only                          |
| Neon JS SDK | `references/neon-js.md`   | `@neondatabase/neon-js` - Auth + Data API (PostgREST-style queries) |

### Neon Platform API & CLI

Managing Neon resources programmatically via REST API, SDKs, or CLI.

| Area                  | Resource                            | When to Use                                  |
| --------------------- | ----------------------------------- | -------------------------------------------- |
| Platform API Overview | `references/neon-platform-api.md`   | Managing Neon resources via REST API         |
| Neon CLI              | `references/neon-cli.md`            | Terminal workflows, scripts, CI/CD pipelines |
| TypeScript SDK        | `references/neon-typescript-sdk.md` | `@neondatabase/api-client`                   |
| Python SDK            | `references/neon-python-sdk.md`     | `neon-api` package                           |
</file>

<file path="prisma/migrations/20260202125952_init/migration.sql">
-- CreateEnum
CREATE TYPE "Rol" AS ENUM ('ADMIN', 'VENDEDOR');

-- CreateEnum
CREATE TYPE "TipoCombustible" AS ENUM ('NAFTA', 'DIESEL', 'ELECTRICO', 'HIBRIDO', 'GNC');

-- CreateEnum
CREATE TYPE "TipoTransmision" AS ENUM ('MANUAL', 'AUTOMATICA', 'SECUENCIAL');

-- CreateEnum
CREATE TYPE "EstadoVehiculo" AS ENUM ('DISPONIBLE', 'RESERVADO', 'VENDIDO');

-- CreateEnum
CREATE TYPE "EstadoConsulta" AS ENUM ('PENDIENTE', 'CONTACTADO', 'CERRADO');

-- CreateTable
CREATE TABLE "Usuario" (
    "id" TEXT NOT NULL,
    "email" TEXT NOT NULL,
    "nombre" TEXT NOT NULL,
    "password" TEXT NOT NULL,
    "rol" "Rol" NOT NULL DEFAULT 'VENDEDOR',
    "activo" BOOLEAN NOT NULL DEFAULT true,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,

    CONSTRAINT "Usuario_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "Vehiculo" (
    "id" TEXT NOT NULL,
    "marca" TEXT NOT NULL,
    "modelo" TEXT NOT NULL,
    "anio" INTEGER NOT NULL,
    "precio" DECIMAL(10,2) NOT NULL,
    "kilometraje" INTEGER NOT NULL,
    "combustible" "TipoCombustible" NOT NULL,
    "transmision" "TipoTransmision" NOT NULL,
    "color" TEXT NOT NULL,
    "puertas" INTEGER NOT NULL,
    "motor" TEXT,
    "descripcion" TEXT,
    "estado" "EstadoVehiculo" NOT NULL DEFAULT 'DISPONIBLE',
    "destacado" BOOLEAN NOT NULL DEFAULT false,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,

    CONSTRAINT "Vehiculo_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "Imagen" (
    "id" TEXT NOT NULL,
    "url" TEXT NOT NULL,
    "vehiculoId" TEXT NOT NULL,
    "orden" INTEGER NOT NULL DEFAULT 0,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "Imagen_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "Caracteristica" (
    "id" TEXT NOT NULL,
    "nombre" TEXT NOT NULL,
    "vehiculoId" TEXT NOT NULL,

    CONSTRAINT "Caracteristica_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "Consulta" (
    "id" TEXT NOT NULL,
    "nombre" TEXT NOT NULL,
    "email" TEXT NOT NULL,
    "telefono" TEXT NOT NULL,
    "mensaje" TEXT NOT NULL,
    "vehiculoId" TEXT,
    "estado" "EstadoConsulta" NOT NULL DEFAULT 'PENDIENTE',
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,

    CONSTRAINT "Consulta_pkey" PRIMARY KEY ("id")
);

-- CreateIndex
CREATE UNIQUE INDEX "Usuario_email_key" ON "Usuario"("email");

-- AddForeignKey
ALTER TABLE "Imagen" ADD CONSTRAINT "Imagen_vehiculoId_fkey" FOREIGN KEY ("vehiculoId") REFERENCES "Vehiculo"("id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "Caracteristica" ADD CONSTRAINT "Caracteristica_vehiculoId_fkey" FOREIGN KEY ("vehiculoId") REFERENCES "Vehiculo"("id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "Consulta" ADD CONSTRAINT "Consulta_vehiculoId_fkey" FOREIGN KEY ("vehiculoId") REFERENCES "Vehiculo"("id") ON DELETE SET NULL ON UPDATE CASCADE;
</file>

<file path="prisma/migrations/migration_lock.toml">
# Please do not edit this file manually
# It should be added in your version-control system (e.g., Git)
provider = "postgresql"
</file>

<file path="public/file.svg">
<svg fill="none" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 13.5V5.41a1 1 0 0 0-.3-.7L9.8.29A1 1 0 0 0 9.08 0H1.5v13.5A2.5 2.5 0 0 0 4 16h8a2.5 2.5 0 0 0 2.5-2.5m-1.5 0v-7H8v-5H3v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1M9.5 5V2.12L12.38 5zM5.13 5h-.62v1.25h2.12V5zm-.62 3h7.12v1.25H4.5zm.62 3h-.62v1.25h7.12V11z" clip-rule="evenodd" fill="#666" fill-rule="evenodd"/></svg>
</file>

<file path="public/globe.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><g clip-path="url(#a)"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.27 14.1a6.5 6.5 0 0 0 3.67-3.45q-1.24.21-2.7.34-.31 1.83-.97 3.1M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.48-1.52a7 7 0 0 1-.96 0H7.5a4 4 0 0 1-.84-1.32q-.38-.89-.63-2.08a40 40 0 0 0 3.92 0q-.25 1.2-.63 2.08a4 4 0 0 1-.84 1.31zm2.94-4.76q1.66-.15 2.95-.43a7 7 0 0 0 0-2.58q-1.3-.27-2.95-.43a18 18 0 0 1 0 3.44m-1.27-3.54a17 17 0 0 1 0 3.64 39 39 0 0 1-4.3 0 17 17 0 0 1 0-3.64 39 39 0 0 1 4.3 0m1.1-1.17q1.45.13 2.69.34a6.5 6.5 0 0 0-3.67-3.44q.65 1.26.98 3.1M8.48 1.5l.01.02q.41.37.84 1.31.38.89.63 2.08a40 40 0 0 0-3.92 0q.25-1.2.63-2.08a4 4 0 0 1 .85-1.32 7 7 0 0 1 .96 0m-2.75.4a6.5 6.5 0 0 0-3.67 3.44 29 29 0 0 1 2.7-.34q.31-1.83.97-3.1M4.58 6.28q-1.66.16-2.95.43a7 7 0 0 0 0 2.58q1.3.27 2.95.43a18 18 0 0 1 0-3.44m.17 4.71q-1.45-.12-2.69-.34a6.5 6.5 0 0 0 3.67 3.44q-.65-1.27-.98-3.1" fill="#666"/></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h16v16H0z"/></clipPath></defs></svg>
</file>

<file path="public/next.svg">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 394 80"><path fill="#000" d="M262 0h68.5v12.7h-27.2v66.6h-13.6V12.7H262V0ZM149 0v12.7H94v20.4h44.3v12.6H94v21h55v12.6H80.5V0h68.7zm34.3 0h-17.8l63.8 79.4h17.9l-32-39.7 32-39.6h-17.9l-23 28.6-23-28.6zm18.3 56.7-9-11-27.1 33.7h17.8l18.3-22.7z"/><path fill="#000" d="M81 79.3 17 0H0v79.3h13.6V17l50.2 62.3H81Zm252.6-.4c-1 0-1.8-.4-2.5-1s-1.1-1.6-1.1-2.6.3-1.8 1-2.5 1.6-1 2.6-1 1.8.3 2.5 1a3.4 3.4 0 0 1 .6 4.3 3.7 3.7 0 0 1-3 1.8zm23.2-33.5h6v23.3c0 2.1-.4 4-1.3 5.5a9.1 9.1 0 0 1-3.8 3.5c-1.6.8-3.5 1.3-5.7 1.3-2 0-3.7-.4-5.3-1s-2.8-1.8-3.7-3.2c-.9-1.3-1.4-3-1.4-5h6c.1.8.3 1.6.7 2.2s1 1.2 1.6 1.5c.7.4 1.5.5 2.4.5 1 0 1.8-.2 2.4-.6a4 4 0 0 0 1.6-1.8c.3-.8.5-1.8.5-3V45.5zm30.9 9.1a4.4 4.4 0 0 0-2-3.3 7.5 7.5 0 0 0-4.3-1.1c-1.3 0-2.4.2-3.3.5-.9.4-1.6 1-2 1.6a3.5 3.5 0 0 0-.3 4c.3.5.7.9 1.3 1.2l1.8 1 2 .5 3.2.8c1.3.3 2.5.7 3.7 1.2a13 13 0 0 1 3.2 1.8 8.1 8.1 0 0 1 3 6.5c0 2-.5 3.7-1.5 5.1a10 10 0 0 1-4.4 3.5c-1.8.8-4.1 1.2-6.8 1.2-2.6 0-4.9-.4-6.8-1.2-2-.8-3.4-2-4.5-3.5a10 10 0 0 1-1.7-5.6h6a5 5 0 0 0 3.5 4.6c1 .4 2.2.6 3.4.6 1.3 0 2.5-.2 3.5-.6 1-.4 1.8-1 2.4-1.7a4 4 0 0 0 .8-2.4c0-.9-.2-1.6-.7-2.2a11 11 0 0 0-2.1-1.4l-3.2-1-3.8-1c-2.8-.7-5-1.7-6.6-3.2a7.2 7.2 0 0 1-2.4-5.7 8 8 0 0 1 1.7-5 10 10 0 0 1 4.3-3.5c2-.8 4-1.2 6.4-1.2 2.3 0 4.4.4 6.2 1.2 1.8.8 3.2 2 4.3 3.4 1 1.4 1.5 3 1.5 5h-5.8z"/></svg>
</file>

<file path="public/vercel.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1155 1000"><path d="m577.3 0 577.4 1000H0z" fill="#fff"/></svg>
</file>

<file path="public/window.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.5 2.5h13v10a1 1 0 0 1-1 1h-11a1 1 0 0 1-1-1zM0 1h16v11.5a2.5 2.5 0 0 1-2.5 2.5h-11A2.5 2.5 0 0 1 0 12.5zm3.75 4.5a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5M7 4.75a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0m1.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5" fill="#666"/></svg>
</file>

<file path="src/app/admin/consultas/page.jsx">
'use client'

import { useEffect, useState } from 'react'
import { useRouter } from 'next/navigation'

/**
 * Página de gestión de consultas
 * 
 * Features:
 * - Lista completa de consultas
 * - Filtros por estado
 * - Búsqueda por cliente
 * - Ver vehículo relacionado
 * - Cambiar estado rápido
 * - Responder consulta
 */
export default function ConsultasPage() {
  const router = useRouter()
  
  const [consultas, setConsultas] = useState([])
  const [consultasFiltradas, setConsultasFiltradas] = useState([])
  const [loading, setLoading] = useState(true)
  const [busqueda, setBusqueda] = useState('')
  const [filtroEstado, setFiltroEstado] = useState('TODOS')

  useEffect(() => {
    cargarConsultas()
  }, [])

  useEffect(() => {
    aplicarFiltros()
  }, [consultas, busqueda, filtroEstado])

  const cargarConsultas = async () => {
    try {
      const token = localStorage.getItem('token')
      if (!token) {
        router.push('/admin/login')
        return
      }

      const res = await fetch('/api/consultas', {
        headers: { 'Authorization': `Bearer ${token}` }
      })
      
      const data = await res.json()

      if (data.success) {
        setConsultas(data.consultas || [])
      }
    } catch (error) {
      console.error('Error cargando consultas:', error)
      alert('❌ Error al cargar consultas')
    } finally {
      setLoading(false)
    }
  }

  const aplicarFiltros = () => {
    let resultado = [...consultas]

    // Filtro por búsqueda
    if (busqueda.trim()) {
      const termino = busqueda.toLowerCase()
      resultado = resultado.filter(c =>
        c.nombre.toLowerCase().includes(termino) ||
        c.email.toLowerCase().includes(termino) ||
        c.telefono.includes(termino) ||
        c.mensaje.toLowerCase().includes(termino)
      )
    }

    // Filtro por estado
    if (filtroEstado !== 'TODOS') {
      resultado = resultado.filter(c => c.estado === filtroEstado)
    }

    // Ordenar por fecha (más recientes primero)
    resultado.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))

    setConsultasFiltradas(resultado)
  }

  const handleCambiarEstado = async (id, nuevoEstado) => {
    try {
      const token = localStorage.getItem('token')
      const res = await fetch(`/api/consultas/${id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ estado: nuevoEstado })
      })

      const data = await res.json()

      if (data.success) {
        alert('✅ Estado actualizado')
        cargarConsultas()
      } else {
        alert('❌ Error: ' + data.error)
      }
    } catch (error) {
      alert('❌ Error al actualizar: ' + error.message)
    }
  }

  const getEstadoBadge = (estado) => {
    const badges = {
      PENDIENTE: 'bg-red-100 text-red-800',
      CONTACTADO: 'bg-blue-100 text-blue-800',
      CERRADO: 'bg-gray-100 text-gray-800'
    }
    return badges[estado] || 'bg-gray-100 text-gray-800'
  }

  const formatearFecha = (fecha) => {
    return new Date(fecha).toLocaleString('es-AR', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    })
  }

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-100">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
          <p className="mt-4 text-gray-600">Cargando consultas...</p>
        </div>
      </div>
    )
  }

  return (
    <div className="min-h-screen bg-gray-100">
      {/* Header */}
      <header className="bg-white shadow-sm">
        <div className="max-w-7xl mx-auto px-4 py-4">
          <button
            onClick={() => router.push('/admin/dashboard')}
            className="text-blue-600 hover:text-blue-800 mb-2 flex items-center gap-2"
          >
            <span>←</span> Volver al Dashboard
          </button>
          <h1 className="text-2xl font-bold text-gray-900">
            💬 Consultas de Clientes
          </h1>
        </div>
      </header>

      <main className="max-w-7xl mx-auto px-4 py-8">
        {/* Estadísticas */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
          <div className="bg-white p-4 rounded-lg shadow-sm">
            <p className="text-sm text-gray-600">Pendientes</p>
            <p className="text-2xl font-bold text-red-600">
              {consultas.filter(c => c.estado === 'PENDIENTE').length}
            </p>
          </div>
          <div className="bg-white p-4 rounded-lg shadow-sm">
            <p className="text-sm text-gray-600">Contactadas</p>
            <p className="text-2xl font-bold text-blue-600">
              {consultas.filter(c => c.estado === 'CONTACTADO').length}
            </p>
          </div>
          <div className="bg-white p-4 rounded-lg shadow-sm">
            <p className="text-sm text-gray-600">Cerradas</p>
            <p className="text-2xl font-bold text-gray-600">
              {consultas.filter(c => c.estado === 'CERRADO').length}
            </p>
          </div>
        </div>

        {/* Filtros */}
        <div className="bg-white rounded-lg shadow-sm p-4 mb-6">
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            {/* Búsqueda */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                🔍 Buscar
              </label>
              <input
                type="text"
                value={busqueda}
                onChange={(e) => setBusqueda(e.target.value)}
                placeholder="Nombre, email, teléfono, mensaje..."
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </div>

            {/* Filtro por Estado */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                🏷️ Estado
              </label>
              <select
                value={filtroEstado}
                onChange={(e) => setFiltroEstado(e.target.value)}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              >
                <option value="TODOS">Todas</option>
                <option value="PENDIENTE">Pendientes</option>
                <option value="CONTACTADO">Contactadas</option>
                <option value="CERRADO">Cerradas</option>
              </select>
            </div>
          </div>

          <div className="mt-3 text-sm text-gray-600">
            Mostrando {consultasFiltradas.length} de {consultas.length} consultas
          </div>
        </div>

        {/* Lista de Consultas */}
        <div className="space-y-4">
          {consultasFiltradas.length === 0 ? (
            <div className="bg-white rounded-lg shadow-sm p-12 text-center">
              <div className="text-6xl mb-4">📭</div>
              <p className="text-gray-500 text-lg">No hay consultas</p>
              <p className="text-gray-400 text-sm mt-2">
                Las consultas de los clientes aparecerán aquí
              </p>
            </div>
          ) : (
            consultasFiltradas.map((consulta) => (
              <div
                key={consulta.id}
                className="bg-white rounded-lg shadow-sm p-6 hover:shadow-md transition-shadow"
              >
                <div className="flex items-start justify-between mb-4">
                  {/* Info del cliente */}
                  <div className="flex-1">
                    <div className="flex items-center gap-3 mb-2">
                      <h3 className="text-lg font-bold text-gray-900">
                        {consulta.nombre}
                      </h3>
                      <span className={`px-3 py-1 rounded-full text-xs font-medium ${getEstadoBadge(consulta.estado)}`}>
                        {consulta.estado}
                      </span>
                    </div>
                    
                    <div className="flex flex-wrap gap-4 text-sm text-gray-600 mb-3">
                      <span>📧 {consulta.email}</span>
                      <span>📱 {consulta.telefono}</span>
                      <span>🕐 {formatearFecha(consulta.createdAt)}</span>
                    </div>

                    {/* Vehículo relacionado */}
                    {consulta.vehiculo && (
                      <div className="mb-3 p-3 bg-blue-50 rounded-lg inline-block">
                        <p className="text-xs text-blue-600 font-medium mb-1">
                          Consulta sobre:
                        </p>
                        <p className="text-sm font-semibold text-blue-900">
                          {consulta.vehiculo.marca} {consulta.vehiculo.modelo} {consulta.vehiculo.anio}
                        </p>
                      </div>
                    )}

                    {/* Mensaje */}
                    <div className="bg-gray-50 p-4 rounded-lg">
                      <p className="text-sm text-gray-700 whitespace-pre-wrap">
                        {consulta.mensaje}
                      </p>
                    </div>
                  </div>
                </div>

                {/* Acciones */}
                <div className="flex gap-2 pt-4 border-t">
                  {consulta.estado === 'PENDIENTE' && (
                    <button
                      onClick={() => handleCambiarEstado(consulta.id, 'CONTACTADO')}
                      className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition-colors"
                    >
                      ✓ Marcar como Contactado
                    </button>
                  )}
                  
                  {consulta.estado === 'CONTACTADO' && (
                    <button
                      onClick={() => handleCambiarEstado(consulta.id, 'CERRADO')}
                      className="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium transition-colors"
                    >
                      ✓ Cerrar Consulta
                    </button>
                  )}

                  {consulta.estado === 'CERRADO' && (
                    <button
                      onClick={() => handleCambiarEstado(consulta.id, 'PENDIENTE')}
                      className="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg text-sm font-medium transition-colors"
                    >
                      ↻ Reabrir
                    </button>
                  )}

                  {/* Botón para copiar email */}
                  <button
                    onClick={() => {
                      navigator.clipboard.writeText(consulta.email)
                      alert('✅ Email copiado al portapapeles')
                    }}
                    className="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg text-sm font-medium transition-colors"
                  >
                    📋 Copiar Email
                  </button>

                  {/* Botón para WhatsApp */}
                  <a
                    href={`https://wa.me/${consulta.telefono.replace(/\D/g, '')}?text=Hola ${consulta.nombre}, te contacto desde la automotora...`}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg text-sm font-medium transition-colors"
                  >
                    💬 WhatsApp
                  </a>
                </div>
              </div>
            ))
          )}
        </div>
      </main>
    </div>
  )
}
</file>

<file path="src/app/admin/dashboard/page.jsx">
'use client'

import { useEffect, useState } from 'react'
import { useRouter } from 'next/navigation'

export default function DashboardPage() {
  const [vehiculos, setVehiculos] = useState([])
  const [consultas, setConsultas] = useState([])
  const [loading, setLoading] = useState(true)
  const [user, setUser] = useState(null)
  const router = useRouter()

  useEffect(() => {
    // Verificar autenticación
    const token = localStorage.getItem('token')
    const userData = localStorage.getItem('user')

    if (!token) {
      router.push('/admin/login')
      return
    }

    setUser(JSON.parse(userData))
    cargarDatos(token)
  }, [router])

  const cargarDatos = async (token) => {
    try {
      // Cargar vehículos
      const resVehiculos = await fetch('/api/vehiculos')
      const dataVehiculos = await resVehiculos.json()
      setVehiculos(dataVehiculos.vehiculos || [])

      // Cargar consultas
      const resConsultas = await fetch('/api/consultas', {
        headers: { 'Authorization': `Bearer ${token}` }
      })
      const dataConsultas = await resConsultas.json()
      setConsultas(dataConsultas.consultas || [])
    } catch (error) {
      console.error('Error cargando datos:', error)
    } finally {
      setLoading(false)
    }
  }

  const handleEliminar = async (id, marca, modelo) => {
    if (!confirm(`¿Seguro que querés eliminar ${marca} ${modelo}?`)) {
      return
    }

    try {
      const token = localStorage.getItem('token')
      const res = await fetch(`/api/vehiculos/${id}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
      })

      const data = await res.json()

      if (data.success) {
        alert('✅ Vehículo eliminado')
        cargarDatos(token)
      } else {
        alert('❌ Error: ' + data.error)
      }
    } catch (error) {
      alert('❌ Error al eliminar: ' + error.message)
    }
  }

  const handleLogout = () => {
    localStorage.removeItem('token')
    localStorage.removeItem('user')
    router.push('/admin/login')
  }

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-xl">Cargando...</div>
      </div>
    )
  }

  return (
    <div className="min-h-screen bg-gray-100">
      {/* Header */}
      <header className="bg-white shadow">
        <div className="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
          <h1 className="text-2xl font-bold">🚗 Dashboard Automotora</h1>
          <div className="flex items-center gap-4">
            <span className="text-sm text-gray-600">
              {user?.nombre} ({user?.rol})
            </span>
            <button
              onClick={handleLogout}
              className="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700"
            >
              Cerrar Sesión
            </button>
          </div>
        </div>
      </header>

      <main className="max-w-7xl mx-auto px-4 py-8">
        {/* Estadísticas */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <div className="bg-white p-6 rounded-lg shadow">
            <h3 className="text-gray-500 text-sm font-medium">Total Vehículos</h3>
            <p className="text-3xl font-bold text-blue-600">{vehiculos.length}</p>
          </div>
          <div className="bg-white p-6 rounded-lg shadow">
            <h3 className="text-gray-500 text-sm font-medium">Consultas Pendientes</h3>
            <p className="text-3xl font-bold text-yellow-600">
              {consultas.filter(c => c.estado === 'PENDIENTE').length}
            </p>
          </div>
          <div className="bg-white p-6 rounded-lg shadow">
            <h3 className="text-gray-500 text-sm font-medium">Reservados</h3>
            <p className="text-3xl font-bold text-green-600">
              {vehiculos.filter(v => v.estado === 'RESERVADO').length}
            </p>
          </div>
        </div>

        {/* Vehículos */}
        <div className="bg-white rounded-lg shadow mb-8">
          <div className="p-6 border-b">
            <div className="flex justify-between items-center">
              <h2 className="text-xl font-bold">Vehículos Recientes</h2>
              <button
                onClick={() => router.push('/admin/vehiculos/nuevo')}
                className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
              >
                ➕ Agregar Vehículo
              </button>
            </div>
          </div>
          <div className="p-6">
            {vehiculos.length === 0 ? (
              <p className="text-gray-500">No hay vehículos registrados</p>
            ) : (
              <div className="space-y-4">
                {vehiculos.slice(0, 5).map(vehiculo => (
                  <div key={vehiculo.id} className="flex items-center justify-between border-b pb-4">
                    <div className="flex items-center gap-4">
                      {vehiculo.imagenes[0] ? (
                        <img 
                          src={vehiculo.imagenes[0].url} 
                          alt={vehiculo.marca}
                          className="w-20 h-20 object-cover rounded"
                        />
                      ) : (
                        <div className="w-20 h-20 bg-gray-200 rounded flex items-center justify-center text-gray-400">
                          Sin foto
                        </div>
                      )}
                      <div>
                        <h3 className="font-semibold">
                          {vehiculo.marca} {vehiculo.modelo} {vehiculo.anio}
                        </h3>
                        <p className="text-sm text-gray-600">
                          ${vehiculo.precio.toLocaleString()} • {vehiculo.kilometraje} km
                        </p>
                      </div>
                    </div>
                    <div className="flex items-center gap-2">
                      <span className={`px-3 py-1 rounded-full text-sm ${
                        vehiculo.estado === 'DISPONIBLE' ? 'bg-green-100 text-green-800' :
                        vehiculo.estado === 'RESERVADO' ? 'bg-yellow-100 text-yellow-800' :
                        'bg-gray-100 text-gray-800'
                      }`}>
                        {vehiculo.estado}
                      </span>
                      <button
                        onClick={() => router.push(`/admin/vehiculos/${vehiculo.id}/imagenes`)}
                        className="bg-purple-600 text-white px-3 py-1 rounded text-sm hover:bg-purple-700"
                        title="Agregar imágenes"
                      >
                        📸
                      </button>
                      <button
                        onClick={() => router.push(`/admin/vehiculos/${vehiculo.id}/editar`)}
                        className="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700"
                        title="Editar"
                      >
                        ✏️
                      </button>
                      <button
                        onClick={() => handleEliminar(vehiculo.id, vehiculo.marca, vehiculo.modelo)}
                        className="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700"
                        title="Eliminar"
                      >
                        🗑️
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>

        {/* Consultas */}
        <div className="bg-white rounded-lg shadow">
          <div className="p-6 border-b">
            <h2 className="text-xl font-bold">Consultas Recientes</h2>
          </div>
          <div className="p-6">
            {consultas.length === 0 ? (
              <p className="text-gray-500">No hay consultas</p>
            ) : (
              <div className="space-y-4">
                {consultas.slice(0, 5).map(consulta => (
                  <div key={consulta.id} className="border-b pb-4">
                    <div className="flex justify-between items-start">
                      <div>
                        <h3 className="font-semibold">{consulta.nombre}</h3>
                        <p className="text-sm text-gray-600">{consulta.email}</p>
                        <p className="text-sm mt-2">{consulta.mensaje}</p>
                        {consulta.vehiculo && (
                          <p className="text-xs text-gray-500 mt-1">
                            Sobre: {consulta.vehiculo.marca} {consulta.vehiculo.modelo}
                          </p>
                        )}
                      </div>
                      <span className={`px-3 py-1 rounded-full text-sm ${
                        consulta.estado === 'PENDIENTE' ? 'bg-red-100 text-red-800' :
                        consulta.estado === 'CONTACTADO' ? 'bg-blue-100 text-blue-800' :
                        'bg-gray-100 text-gray-800'
                      }`}>
                        {consulta.estado}
                      </span>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      </main>
    </div>
  )
}
</file>

<file path="src/app/admin/login/page.jsx">
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'

export default function LoginPage() {
  const [email, setEmail] = useState('')
  const [password, setPassword] = useState('')
  const [error, setError] = useState('')
  const [loading, setLoading] = useState(false)
  const router = useRouter()

  const handleSubmit = async (e) => {
    e.preventDefault()
    setError('')
    setLoading(true)

    try {
      const res = await fetch('/api/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password })
      })

      const data = await res.json()

      if (data.success) {
        // Guardar token en localStorage
        localStorage.setItem('token', data.token)
        localStorage.setItem('user', JSON.stringify(data.usuario))
        
        // Redirigir al dashboard
        router.push('/admin/dashboard')
      } else {
        setError(data.error || 'Error al iniciar sesión')
      }
    } catch (err) {
      setError('Error de conexión')
    } finally {
      setLoading(false)
    }
  }

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-100">
      <div className="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
        <h1 className="text-2xl font-bold text-center mb-6">
          🚗 Automotora Admin
        </h1>

        {error && (
          <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
            {error}
          </div>
        )}

        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              Email
            </label>
            <input
              type="email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              required
              className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="admin@automotora.com"
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              Contraseña
            </label>
            <input
              type="password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              required
              className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="••••••••"
            />
          </div>

          <button
            type="submit"
            disabled={loading}
            className="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition"
          >
            {loading ? 'Ingresando...' : 'Iniciar Sesión'}
          </button>
        </form>

        <div className="mt-4 text-sm text-gray-600 text-center">
          <p>Credenciales de prueba:</p>
          <p className="font-mono text-xs mt-1">admin@automotora.com / admin123</p>
        </div>
      </div>
    </div>
  )
}
</file>

<file path="src/app/admin/vehiculos/[id]/editar/page.jsx">
'use client'

import { useEffect, useState } from 'react'
import { useRouter, useParams } from 'next/navigation'

/**
 * Página para editar un vehículo existente
 * 
 * Features:
 * - Carga datos actuales del vehículo
 * - Formulario pre-llenado
 * - Validaciones en tiempo real
 * - Actualización con PUT
 * - Manejo de estados y errores
 */
export default function EditarVehiculoPage() {
  const router = useRouter()
  const params = useParams()
  const vehiculoId = params.id

  const [loading, setLoading] = useState(true)
  const [guardando, setGuardando] = useState(false)
  const [error, setError] = useState(null)

  const [formData, setFormData] = useState({
    marca: '',
    modelo: '',
    anio: new Date().getFullYear(),
    precio: '',
    kilometraje: '',
    combustible: 'NAFTA',
    transmision: 'MANUAL',
    color: '',
    puertas: 4,
    motor: '',
    descripcion: '',
    estado: 'DISPONIBLE',
    destacado: false
  })

  useEffect(() => {
    cargarVehiculo()
  }, [vehiculoId])

  const cargarVehiculo = async () => {
    try {
      const token = localStorage.getItem('token')
      if (!token) {
        router.push('/admin/login')
        return
      }

      const res = await fetch(`/api/vehiculos/${vehiculoId}`)
      const data = await res.json()

      if (data.success) {
        const v = data.vehiculo
        setFormData({
          marca: v.marca,
          modelo: v.modelo,
          anio: v.anio,
          precio: v.precio,
          kilometraje: v.kilometraje,
          combustible: v.combustible,
          transmision: v.transmision,
          color: v.color,
          puertas: v.puertas,
          motor: v.motor || '',
          descripcion: v.descripcion || '',
          estado: v.estado,
          destacado: v.destacado
        })
      } else {
        setError('No se pudo cargar el vehículo')
      }
    } catch (error) {
      console.error('Error cargando vehículo:', error)
      setError('Error al cargar los datos')
    } finally {
      setLoading(false)
    }
  }

  const handleChange = (e) => {
    const { name, value, type, checked } = e.target

    setFormData(prev => ({
      ...prev,
      [name]: type === 'checkbox' ? checked : value
    }))
  }

  const validarFormulario = () => {
    if (!formData.marca.trim()) {
      alert('❌ La marca es obligatoria')
      return false
    }

    if (!formData.modelo.trim()) {
      alert('❌ El modelo es obligatorio')
      return false
    }

    if (formData.anio < 1900 || formData.anio > new Date().getFullYear() + 1) {
      alert('❌ El año no es válido')
      return false
    }

    if (formData.precio <= 0) {
      alert('❌ El precio debe ser mayor a 0')
      return false
    }

    if (formData.kilometraje < 0) {
      alert('❌ El kilometraje no puede ser negativo')
      return false
    }

    if (!formData.color.trim()) {
      alert('❌ El color es obligatorio')
      return false
    }

    return true
  }

  const handleSubmit = async (e) => {
    e.preventDefault()

    if (!validarFormulario()) return

    setGuardando(true)
    setError(null)

    try {
      const token = localStorage.getItem('token')

      // Preparar datos - convertir a números donde corresponde
      const dataToSend = {
        ...formData,
        anio: parseInt(formData.anio),
        precio: parseFloat(formData.precio),
        kilometraje: parseInt(formData.kilometraje),
        puertas: parseInt(formData.puertas)
      }

      const res = await fetch(`/api/vehiculos/${vehiculoId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(dataToSend)
      })

      const data = await res.json()

      if (data.success) {
        alert('✅ Vehículo actualizado exitosamente')
        router.push('/admin/dashboard')
      } else {
        setError(data.error || 'Error al actualizar')
        alert('❌ Error: ' + data.error)
      }
    } catch (error) {
      console.error('Error:', error)
      setError('Error al guardar los cambios')
      alert('❌ Error al guardar los cambios')
    } finally {
      setGuardando(false)
    }
  }

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-100">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
          <p className="mt-4 text-gray-600">Cargando vehículo...</p>
        </div>
      </div>
    )
  }

  return (
    <div className="min-h-screen bg-gray-100">
      {/* Header */}
      <header className="bg-white shadow-sm">
        <div className="max-w-4xl mx-auto px-4 py-4">
          <button
            onClick={() => router.push('/admin/dashboard')}
            className="text-blue-600 hover:text-blue-800 mb-2 flex items-center gap-2"
          >
            <span>←</span> Volver al Dashboard
          </button>
          <h1 className="text-2xl font-bold text-gray-900">
            ✏️ Editar Vehículo
          </h1>
        </div>
      </header>

      <main className="max-w-4xl mx-auto px-4 py-8">
        {error && (
          <div className="mb-6 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded">
            ❌ {error}
          </div>
        )}

        <form onSubmit={handleSubmit} className="bg-white rounded-lg shadow-sm p-6">
          {/* Sección: Datos Básicos */}
          <div className="mb-8">
            <h2 className="text-lg font-bold text-gray-900 mb-4 pb-2 border-b">
              📋 Datos Básicos
            </h2>
            
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Marca *
                </label>
                <input
                  type="text"
                  name="marca"
                  value={formData.marca}
                  onChange={handleChange}
                  required
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  placeholder="Ej: Toyota"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Modelo *
                </label>
                <input
                  type="text"
                  name="modelo"
                  value={formData.modelo}
                  onChange={handleChange}
                  required
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  placeholder="Ej: Corolla"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Año *
                </label>
                <input
                  type="number"
                  name="anio"
                  value={formData.anio}
                  onChange={handleChange}
                  required
                  min="1900"
                  max={new Date().getFullYear() + 1}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Color *
                </label>
                <input
                  type="text"
                  name="color"
                  value={formData.color}
                  onChange={handleChange}
                  required
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  placeholder="Ej: Blanco"
                />
              </div>
            </div>
          </div>

          {/* Sección: Precios y Kilometraje */}
          <div className="mb-8">
            <h2 className="text-lg font-bold text-gray-900 mb-4 pb-2 border-b">
              💰 Precio y Kilometraje
            </h2>
            
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Precio (USD) *
                </label>
                <input
                  type="number"
                  name="precio"
                  value={formData.precio}
                  onChange={handleChange}
                  required
                  min="0"
                  step="0.01"
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  placeholder="Ej: 15000"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Kilometraje *
                </label>
                <input
                  type="number"
                  name="kilometraje"
                  value={formData.kilometraje}
                  onChange={handleChange}
                  required
                  min="0"
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  placeholder="Ej: 50000"
                />
              </div>
            </div>
          </div>

          {/* Sección: Características Técnicas */}
          <div className="mb-8">
            <h2 className="text-lg font-bold text-gray-900 mb-4 pb-2 border-b">
              ⚙️ Características Técnicas
            </h2>
            
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Combustible *
                </label>
                <select
                  name="combustible"
                  value={formData.combustible}
                  onChange={handleChange}
                  required
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
                  <option value="NAFTA">Nafta</option>
                  <option value="DIESEL">Diesel</option>
                  <option value="ELECTRICO">Eléctrico</option>
                  <option value="HIBRIDO">Híbrido</option>
                  <option value="GNC">GNC</option>
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Transmisión *
                </label>
                <select
                  name="transmision"
                  value={formData.transmision}
                  onChange={handleChange}
                  required
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
                  <option value="MANUAL">Manual</option>
                  <option value="AUTOMATICA">Automática</option>
                  <option value="SECUENCIAL">Secuencial</option>
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Puertas *
                </label>
                <select
                  name="puertas"
                  value={formData.puertas}
                  onChange={handleChange}
                  required
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
                  <option value="2">2 puertas</option>
                  <option value="3">3 puertas</option>
                  <option value="4">4 puertas</option>
                  <option value="5">5 puertas</option>
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Motor (opcional)
                </label>
                <input
                  type="text"
                  name="motor"
                  value={formData.motor}
                  onChange={handleChange}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  placeholder="Ej: 2.0 TSI"
                />
              </div>
            </div>
          </div>

          {/* Sección: Estado y Descripción */}
          <div className="mb-8">
            <h2 className="text-lg font-bold text-gray-900 mb-4 pb-2 border-b">
              📝 Estado y Descripción
            </h2>
            
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Estado *
                </label>
                <select
                  name="estado"
                  value={formData.estado}
                  onChange={handleChange}
                  required
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
                  <option value="DISPONIBLE">Disponible</option>
                  <option value="RESERVADO">Reservado</option>
                  <option value="VENDIDO">Vendido</option>
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Descripción (opcional)
                </label>
                <textarea
                  name="descripcion"
                  value={formData.descripcion}
                  onChange={handleChange}
                  rows="4"
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  placeholder="Descripción detallada del vehículo..."
                />
              </div>

              <div className="flex items-center">
                <input
                  type="checkbox"
                  name="destacado"
                  id="destacado"
                  checked={formData.destacado}
                  onChange={handleChange}
                  className="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                />
                <label htmlFor="destacado" className="ml-2 text-sm text-gray-700">
                  ⭐ Marcar como destacado
                </label>
              </div>
            </div>
          </div>

          {/* Botones */}
          <div className="flex gap-3 pt-4 border-t">
            <button
              type="submit"
              disabled={guardando}
              className={`flex-1 py-3 rounded-lg font-medium transition-colors ${
                guardando
                  ? 'bg-gray-400 cursor-not-allowed'
                  : 'bg-blue-600 hover:bg-blue-700 text-white'
              }`}
            >
              {guardando ? '⏳ Guardando...' : '💾 Guardar Cambios'}
            </button>

            <button
              type="button"
              onClick={() => router.push('/admin/dashboard')}
              disabled={guardando}
              className="px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium transition-colors"
            >
              Cancelar
            </button>
          </div>
        </form>
      </main>
    </div>
  )
}
</file>

<file path="src/app/admin/vehiculos/nuevo/page.jsx">
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'

export default function NuevoVehiculoPage() {
  const router = useRouter()
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState('')
  const [formData, setFormData] = useState({
    marca: '',
    modelo: '',
    anio: new Date().getFullYear(),
    precio: '',
    kilometraje: 0,
    combustible: 'NAFTA',
    transmision: 'MANUAL',
    color: '',
    puertas: 4,
    motor: '',
    descripcion: '',
    destacado: false
  })

  const handleChange = (e) => {
    const { name, value, type, checked } = e.target
    setFormData(prev => ({
      ...prev,
      [name]: type === 'checkbox' ? checked : value
    }))
  }

  const handleSubmit = async (e) => {
    e.preventDefault()
    setLoading(true)
    setError('')

    try {
      const token = localStorage.getItem('token')
      
      const res = await fetch('/api/vehiculos', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
          ...formData,
          anio: parseInt(formData.anio),
          precio: parseFloat(formData.precio),
          kilometraje: parseInt(formData.kilometraje),
          puertas: parseInt(formData.puertas)
        })
      })

      const data = await res.json()

      if (data.success) {
        alert('✅ Vehículo creado exitosamente')
        router.push('/admin/dashboard')
      } else {
        setError(data.error || 'Error al crear vehículo')
      }
    } catch (err) {
      setError('Error de conexión: ' + err.message)
    } finally {
      setLoading(false)
    }
  }

  return (
    <div className="min-h-screen bg-gray-100">
      {/* Header */}
      <header className="bg-white shadow">
        <div className="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
          <h1 className="text-2xl font-bold">➕ Agregar Vehículo</h1>
          <button
            onClick={() => router.push('/admin/dashboard')}
            className="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700"
          >
            ← Volver
          </button>
        </div>
      </header>

      <main className="max-w-4xl mx-auto px-4 py-8">
        <div className="bg-white rounded-lg shadow p-6">
          {error && (
            <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
              {error}
            </div>
          )}

          <form onSubmit={handleSubmit} className="space-y-6">
            {/* Información Básica */}
            <div>
              <h3 className="text-lg font-semibold mb-4">Información Básica</h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Marca *
                  </label>
                  <input
                    type="text"
                    name="marca"
                    value={formData.marca}
                    onChange={handleChange}
                    required
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Toyota"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Modelo *
                  </label>
                  <input
                    type="text"
                    name="modelo"
                    value={formData.modelo}
                    onChange={handleChange}
                    required
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Corolla"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Año *
                  </label>
                  <input
                    type="number"
                    name="anio"
                    value={formData.anio}
                    onChange={handleChange}
                    required
                    min="1900"
                    max={new Date().getFullYear() + 1}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Precio (USD) *
                  </label>
                  <input
                    type="number"
                    name="precio"
                    value={formData.precio}
                    onChange={handleChange}
                    required
                    min="0"
                    step="100"
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="25000"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Kilometraje *
                  </label>
                  <input
                    type="number"
                    name="kilometraje"
                    value={formData.kilometraje}
                    onChange={handleChange}
                    required
                    min="0"
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="15000"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Color *
                  </label>
                  <input
                    type="text"
                    name="color"
                    value={formData.color}
                    onChange={handleChange}
                    required
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Blanco"
                  />
                </div>
              </div>
            </div>

            {/* Especificaciones */}
            <div>
              <h3 className="text-lg font-semibold mb-4">Especificaciones</h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Combustible *
                  </label>
                  <select
                    name="combustible"
                    value={formData.combustible}
                    onChange={handleChange}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  >
                    <option value="NAFTA">Nafta</option>
                    <option value="DIESEL">Diesel</option>
                    <option value="ELECTRICO">Eléctrico</option>
                    <option value="HIBRIDO">Híbrido</option>
                    <option value="GNC">GNC</option>
                  </select>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Transmisión *
                  </label>
                  <select
                    name="transmision"
                    value={formData.transmision}
                    onChange={handleChange}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  >
                    <option value="MANUAL">Manual</option>
                    <option value="AUTOMATICA">Automática</option>
                    <option value="SECUENCIAL">Secuencial</option>
                  </select>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Puertas *
                  </label>
                  <input
                    type="number"
                    name="puertas"
                    value={formData.puertas}
                    onChange={handleChange}
                    required
                    min="2"
                    max="5"
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Motor (opcional)
                  </label>
                  <input
                    type="text"
                    name="motor"
                    value={formData.motor}
                    onChange={handleChange}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="2.0 16v"
                  />
                </div>
              </div>
            </div>

            {/* Descripción */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Descripción
              </label>
              <textarea
                name="descripcion"
                value={formData.descripcion}
                onChange={handleChange}
                rows="4"
                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Descripción detallada del vehículo..."
              />
            </div>

            {/* Destacado */}
            <div className="flex items-center">
              <input
                type="checkbox"
                name="destacado"
                checked={formData.destacado}
                onChange={handleChange}
                className="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
              />
              <label className="ml-2 block text-sm text-gray-900">
                Destacar este vehículo en la página principal
              </label>
            </div>

            {/* Botones */}
            <div className="flex gap-4">
              <button
                type="submit"
                disabled={loading}
                className="flex-1 bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition font-semibold"
              >
                {loading ? 'Guardando...' : '✅ Guardar Vehículo'}
              </button>
              <button
                type="button"
                onClick={() => router.push('/admin/dashboard')}
                className="px-6 py-3 border border-gray-300 rounded-md hover:bg-gray-50"
              >
                Cancelar
              </button>
            </div>
          </form>
        </div>
      </main>
    </div>
  )
}
</file>

<file path="src/app/admin/vehiculos/page.jsx">
'use client'

import { useEffect, useState } from 'react'
import { useRouter } from 'next/navigation'

/**
 * Página con lista COMPLETA de vehículos
 * 
 * Features:
 * - Tabla profesional con todos los vehículos
 * - Búsqueda en tiempo real
 * - Filtros por estado
 * - Ordenamiento por columnas
 * - Acciones rápidas (editar, imágenes, eliminar)
 * - Paginación (opcional)
 */
export default function ListaVehiculosPage() {
  const router = useRouter()
  
  const [vehiculos, setVehiculos] = useState([])
  const [vehiculosFiltrados, setVehiculosFiltrados] = useState([])
  const [loading, setLoading] = useState(true)
  const [busqueda, setBusqueda] = useState('')
  const [filtroEstado, setFiltroEstado] = useState('TODOS')
  const [ordenarPor, setOrdenarPor] = useState('recientes') // recientes, precio_asc, precio_desc, km_asc, km_desc

  useEffect(() => {
    cargarVehiculos()
  }, [])

  useEffect(() => {
    aplicarFiltros()
  }, [vehiculos, busqueda, filtroEstado, ordenarPor])

  const cargarVehiculos = async () => {
    try {
      const token = localStorage.getItem('token')
      if (!token) {
        router.push('/admin/login')
        return
      }

      const res = await fetch('/api/vehiculos')
      const data = await res.json()

      if (data.success) {
        setVehiculos(data.vehiculos || [])
      }
    } catch (error) {
      console.error('Error cargando vehículos:', error)
      alert('❌ Error al cargar vehículos')
    } finally {
      setLoading(false)
    }
  }

  const aplicarFiltros = () => {
    let resultado = [...vehiculos]

    // Filtro por búsqueda
    if (busqueda.trim()) {
      const termino = busqueda.toLowerCase()
      resultado = resultado.filter(v =>
        v.marca.toLowerCase().includes(termino) ||
        v.modelo.toLowerCase().includes(termino) ||
        v.color.toLowerCase().includes(termino) ||
        v.anio.toString().includes(termino)
      )
    }

    // Filtro por estado
    if (filtroEstado !== 'TODOS') {
      resultado = resultado.filter(v => v.estado === filtroEstado)
    }

    // Ordenamiento
    switch (ordenarPor) {
      case 'precio_asc':
        resultado.sort((a, b) => parseFloat(a.precio) - parseFloat(b.precio))
        break
      case 'precio_desc':
        resultado.sort((a, b) => parseFloat(b.precio) - parseFloat(a.precio))
        break
      case 'km_asc':
        resultado.sort((a, b) => a.kilometraje - b.kilometraje)
        break
      case 'km_desc':
        resultado.sort((a, b) => b.kilometraje - a.kilometraje)
        break
      case 'recientes':
      default:
        resultado.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
        break
    }

    setVehiculosFiltrados(resultado)
  }

  const handleEliminar = async (id, marca, modelo) => {
    if (!confirm(`¿Seguro que querés eliminar ${marca} ${modelo}?`)) {
      return
    }

    try {
      const token = localStorage.getItem('token')
      const res = await fetch(`/api/vehiculos/${id}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
      })

      const data = await res.json()

      if (data.success) {
        alert('✅ Vehículo eliminado')
        cargarVehiculos()
      } else {
        alert('❌ Error: ' + data.error)
      }
    } catch (error) {
      alert('❌ Error al eliminar: ' + error.message)
    }
  }

  const getEstadoBadge = (estado) => {
    const badges = {
      DISPONIBLE: 'bg-green-100 text-green-800',
      RESERVADO: 'bg-yellow-100 text-yellow-800',
      VENDIDO: 'bg-gray-100 text-gray-800'
    }
    return badges[estado] || 'bg-gray-100 text-gray-800'
  }

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-100">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
          <p className="mt-4 text-gray-600">Cargando vehículos...</p>
        </div>
      </div>
    )
  }

  return (
    <div className="min-h-screen bg-gray-100">
      {/* Header */}
      <header className="bg-white shadow-sm">
        <div className="max-w-7xl mx-auto px-4 py-4">
          <div className="flex items-center justify-between">
            <div>
              <button
                onClick={() => router.push('/admin/dashboard')}
                className="text-blue-600 hover:text-blue-800 mb-2 flex items-center gap-2"
              >
                <span>←</span> Volver al Dashboard
              </button>
              <h1 className="text-2xl font-bold text-gray-900">
                🚗 Todos los Vehículos
              </h1>
            </div>

            <button
              onClick={() => router.push('/admin/vehiculos/nuevo')}
              className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors"
            >
              ➕ Nuevo Vehículo
            </button>
          </div>
        </div>
      </header>

      <main className="max-w-7xl mx-auto px-4 py-8">
        {/* Estadísticas Rápidas */}
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
          <div className="bg-white p-4 rounded-lg shadow-sm">
            <p className="text-sm text-gray-600">Total</p>
            <p className="text-2xl font-bold text-blue-600">{vehiculos.length}</p>
          </div>
          <div className="bg-white p-4 rounded-lg shadow-sm">
            <p className="text-sm text-gray-600">Disponibles</p>
            <p className="text-2xl font-bold text-green-600">
              {vehiculos.filter(v => v.estado === 'DISPONIBLE').length}
            </p>
          </div>
          <div className="bg-white p-4 rounded-lg shadow-sm">
            <p className="text-sm text-gray-600">Reservados</p>
            <p className="text-2xl font-bold text-yellow-600">
              {vehiculos.filter(v => v.estado === 'RESERVADO').length}
            </p>
          </div>
          <div className="bg-white p-4 rounded-lg shadow-sm">
            <p className="text-sm text-gray-600">Vendidos</p>
            <p className="text-2xl font-bold text-gray-600">
              {vehiculos.filter(v => v.estado === 'VENDIDO').length}
            </p>
          </div>
        </div>

        {/* Filtros y Búsqueda */}
        <div className="bg-white rounded-lg shadow-sm p-4 mb-6">
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
            {/* Búsqueda */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                🔍 Buscar
              </label>
              <input
                type="text"
                value={busqueda}
                onChange={(e) => setBusqueda(e.target.value)}
                placeholder="Marca, modelo, color, año..."
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </div>

            {/* Filtro por Estado */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                🏷️ Estado
              </label>
              <select
                value={filtroEstado}
                onChange={(e) => setFiltroEstado(e.target.value)}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              >
                <option value="TODOS">Todos</option>
                <option value="DISPONIBLE">Disponibles</option>
                <option value="RESERVADO">Reservados</option>
                <option value="VENDIDO">Vendidos</option>
              </select>
            </div>

            {/* Ordenar Por */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                📊 Ordenar por
              </label>
              <select
                value={ordenarPor}
                onChange={(e) => setOrdenarPor(e.target.value)}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              >
                <option value="recientes">Más recientes</option>
                <option value="precio_asc">Precio: menor a mayor</option>
                <option value="precio_desc">Precio: mayor a menor</option>
                <option value="km_asc">Km: menor a mayor</option>
                <option value="km_desc">Km: mayor a menor</option>
              </select>
            </div>
          </div>

          <div className="mt-3 text-sm text-gray-600">
            Mostrando {vehiculosFiltrados.length} de {vehiculos.length} vehículos
          </div>
        </div>

        {/* Tabla de Vehículos */}
        <div className="bg-white rounded-lg shadow-sm overflow-hidden">
          {vehiculosFiltrados.length === 0 ? (
            <div className="text-center py-12">
              <div className="text-6xl mb-4">🔍</div>
              <p className="text-gray-500 text-lg">No se encontraron vehículos</p>
              <p className="text-gray-400 text-sm mt-2">
                Intentá con otros filtros o términos de búsqueda
              </p>
            </div>
          ) : (
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead className="bg-gray-50 border-b">
                  <tr>
                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                      Vehículo
                    </th>
                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                      Año
                    </th>
                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                      Precio
                    </th>
                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                      Km
                    </th>
                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                      Estado
                    </th>
                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                      Imágenes
                    </th>
                    <th className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">
                      Acciones
                    </th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-gray-200">
                  {vehiculosFiltrados.map((vehiculo) => (
                    <tr key={vehiculo.id} className="hover:bg-gray-50">
                      {/* Vehículo con imagen */}
                      <td className="px-4 py-4">
                        <div className="flex items-center gap-3">
                          {vehiculo.imagenes?.[0] ? (
                            <img
                              src={vehiculo.imagenes[0].url}
                              alt={vehiculo.marca}
                              className="w-16 h-16 object-cover rounded"
                            />
                          ) : (
                            <div className="w-16 h-16 bg-gray-200 rounded flex items-center justify-center text-gray-400 text-xs">
                              Sin foto
                            </div>
                          )}
                          <div>
                            <p className="font-semibold text-gray-900">
                              {vehiculo.marca} {vehiculo.modelo}
                            </p>
                            <p className="text-sm text-gray-500">
                              {vehiculo.color} • {vehiculo.combustible}
                            </p>
                          </div>
                        </div>
                      </td>

                      {/* Año */}
                      <td className="px-4 py-4 text-gray-700">
                        {vehiculo.anio}
                      </td>

                      {/* Precio */}
                      <td className="px-4 py-4">
                        <span className="font-semibold text-gray-900">
                          ${parseFloat(vehiculo.precio).toLocaleString()}
                        </span>
                      </td>

                      {/* Kilometraje */}
                      <td className="px-4 py-4 text-gray-700">
                        {vehiculo.kilometraje.toLocaleString()} km
                      </td>

                      {/* Estado */}
                      <td className="px-4 py-4">
                        <span className={`px-2 py-1 rounded-full text-xs font-medium ${getEstadoBadge(vehiculo.estado)}`}>
                          {vehiculo.estado}
                        </span>
                      </td>

                      {/* Cantidad de imágenes */}
                      <td className="px-4 py-4 text-center">
                        <span className="inline-flex items-center justify-center w-8 h-8 rounded-full bg-blue-100 text-blue-800 text-sm font-bold">
                          {vehiculo.imagenes?.length || 0}
                        </span>
                      </td>

                      {/* Acciones */}
                      <td className="px-4 py-4">
                        <div className="flex items-center justify-end gap-2">
                          <button
                            onClick={() => router.push(`/admin/vehiculos/${vehiculo.id}/imagenes`)}
                            className="p-2 text-purple-600 hover:bg-purple-50 rounded transition-colors"
                            title="Gestionar imágenes"
                          >
                            📸
                          </button>
                          <button
                            onClick={() => router.push(`/admin/vehiculos/${vehiculo.id}/editar`)}
                            className="p-2 text-blue-600 hover:bg-blue-50 rounded transition-colors"
                            title="Editar"
                          >
                            ✏️
                          </button>
                          <button
                            onClick={() => handleEliminar(vehiculo.id, vehiculo.marca, vehiculo.modelo)}
                            className="p-2 text-red-600 hover:bg-red-50 rounded transition-colors"
                            title="Eliminar"
                          >
                            🗑️
                          </button>
                        </div>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </div>
      </main>
    </div>
  )
}
</file>

<file path="src/app/api/auth/logout/route.js">
// src/app/api/auth/logout/route.js

export async function POST(request) {
  try {
    // En una aplicación con tokens JWT, el logout es principalmente del lado del cliente
    // El cliente debe eliminar el token guardado (localStorage, cookie, etc.)
    
    // Aquí podríamos agregar lógica adicional como:
    // - Registrar el logout en logs
    // - Invalidar el token en una blacklist (si se implementa)
    // - Actualizar última actividad del usuario

    console.log('🚪 Usuario cerró sesión')

    return Response.json({
      success: true,
      message: 'Sesión cerrada exitosamente'
    })

  } catch (error) {
    console.error('❌ Error en logout:', error)

    return Response.json(
      { 
        success: false, 
        error: 'Error al cerrar sesión' 
      },
      { status: 500 }
    )
  }
}
</file>

<file path="src/app/api/auth/a">

</file>

<file path="src/app/api/consultas/[id]/route.js">
// src/app/api/consultas/[id]/route.js

import prisma from '../../../../lib/prisma.js'

const estadosValidos = ["PENDIENTE", "CONTACTADO", "CERRADO"]

function extraerIdDeUrl(request) {
  const pathname = request.nextUrl.pathname
  return pathname.split("/").pop()
}

/* ========================================
   GET - Obtener una consulta por ID
======================================== */
export async function GET(request) {
  try {
    const id = extraerIdDeUrl(request)

    const consulta = await prisma.consulta.findUnique({
      where: { id },
      include: {
        vehiculo: true
      }
    })

    if (!consulta) {
      return Response.json(
        { success: false, error: "Consulta no encontrada" },
        { status: 404 }
      )
    }

    return Response.json({
      success: true,
      consulta: consulta
    })

  } catch (error) {
    console.error("❌ Error en GET consulta por ID:", error)

    return Response.json(
      { success: false, error: error.message },
      { status: 500 }
    )
  }
}

/* ========================================
   PUT - Actualizar estado de consulta
======================================== */
export async function PUT(request) {
  try {
    const id = extraerIdDeUrl(request)
    const datos = await request.json()

    // Verificar que la consulta existe
    const consultaExistente = await prisma.consulta.findUnique({
      where: { id }
    })

    if (!consultaExistente) {
      return Response.json(
        { success: false, error: "Consulta no encontrada" },
        { status: 404 }
      )
    }

    // Validar estado si se proporciona
    if (datos.estado && !estadosValidos.includes(datos.estado)) {
      return Response.json(
        { 
          success: false, 
          error: `Estado inválido. Opciones: ${estadosValidos.join(', ')}` 
        },
        { status: 400 }
      )
    }

    // Actualizar consulta
    const consultaActualizada = await prisma.consulta.update({
      where: { id },
      data: {
        estado: datos.estado || consultaExistente.estado
      },
      include: {
        vehiculo: {
          select: {
            id: true,
            marca: true,
            modelo: true
          }
        }
      }
    })

    console.log(`✅ Consulta ${id} actualizada a estado: ${consultaActualizada.estado}`)

    return Response.json({
      success: true,
      consulta: consultaActualizada,
      mensaje: "Consulta actualizada exitosamente"
    })

  } catch (error) {
    console.error("❌ Error en PUT consulta:", error)

    return Response.json(
      { success: false, error: error.message },
      { status: 500 }
    )
  }
}

/* ========================================
   DELETE - Eliminar consulta
======================================== */
export async function DELETE(request) {
  try {
    const id = extraerIdDeUrl(request)

    // Verificar que existe
    const consultaExistente = await prisma.consulta.findUnique({
      where: { id }
    })

    if (!consultaExistente) {
      return Response.json(
        { success: false, error: "Consulta no encontrada" },
        { status: 404 }
      )
    }

    // Eliminar
    await prisma.consulta.delete({
      where: { id }
    })

    console.log(`🗑️  Consulta ${id} eliminada`)

    return Response.json({
      success: true,
      mensaje: "Consulta eliminada exitosamente"
    })

  } catch (error) {
    console.error("❌ Error en DELETE consulta:", error)

    return Response.json(
      { success: false, error: error.message },
      { status: 500 }
    )
  }
}
</file>

<file path="src/app/api/test/route.js">
// src/app/api/test/route.js

export async function GET(request) {
  return Response.json({ 
    message: 'API funcionando correctamente! 🚀',
    timestamp: new Date().toISOString(),
    status: 'OK'
  })
}
</file>

<file path="src/app/api/upload/route.js">
// src/app/api/upload/route.js

import { uploadImage } from '../../../lib/cloudinary.js'

export async function POST(request) {
  try {
    const { images } = await request.json()

    // Validar que se enviaron imágenes
    if (!images || !Array.isArray(images) || images.length === 0) {
      return Response.json(
        { success: false, error: 'No se proporcionaron imágenes' },
        { status: 400 }
      )
    }

    // Validar cantidad máxima (10 imágenes por request)
    if (images.length > 10) {
      return Response.json(
        { success: false, error: 'Máximo 10 imágenes por vez' },
        { status: 400 }
      )
    }

    // Subir todas las imágenes
    const uploadPromises = images.map(async (imageData) => {
      // Validar que es base64
      if (!imageData.startsWith('data:image/')) {
        throw new Error('Formato de imagen inválido')
      }

      return await uploadImage(imageData, 'automotora/vehiculos')
    })

    const uploadedImages = await Promise.all(uploadPromises)

    console.log(`✅ ${uploadedImages.length} imágenes subidas exitosamente`)

    return Response.json({
      success: true,
      images: uploadedImages,
      count: uploadedImages.length
    }, { status: 201 })

  } catch (error) {
    console.error('❌ Error en upload:', error)

    return Response.json(
      { 
        success: false, 
        error: error.message || 'Error al subir imágenes' 
      },
      { status: 500 }
    )
  }
}
</file>

<file path="src/app/api/vehiculos/[id]/imagenes/route.js">
// src/app/api/vehiculos/[id]/imagenes/route.js

import { NextResponse } from 'next/server'
import prisma from '@/lib/prisma'
import { verifyToken, extractTokenFromHeader } from '@/lib/auth'

export async function POST(request) {
  try {
    // Verificar autenticación
    const authHeader = request.headers.get('Authorization')
    const token = extractTokenFromHeader(authHeader)

    if (!token) {
      return NextResponse.json(
        { success: false, error: 'No autorizado' },
        { status: 401 }
      )
    }

    try {
      verifyToken(token)
    } catch (error) {
      return NextResponse.json(
        { success: false, error: 'Token inválido' },
        { status: 401 }
      )
    }

    // Extraer ID de diferentes formas
    const url = new URL(request.url)
    const pathParts = url.pathname.split('/')
    const id = pathParts[pathParts.length - 2] // El ID está antes de /imagenes
    
    console.log('🔍 URL completa:', request.url)
    console.log('🔍 Path:', url.pathname)
    console.log('🔍 Parts:', pathParts)
    console.log('📍 ID extraído:', id)

    const body = await request.json()
    const { imagenes } = body

    console.log('📦 Body recibido:', body)
    console.log('🖼️ Imágenes:', imagenes)

    if (!imagenes || !Array.isArray(imagenes)) {
      return NextResponse.json(
        { success: false, error: 'Datos inválidos' },
        { status: 400 }
      )
    }

    if (!id || id === 'imagenes') {
      return NextResponse.json(
        { success: false, error: 'ID de vehículo inválido' },
        { status: 400 }
      )
    }

    // Verificar que el vehículo existe
    const vehiculo = await prisma.vehiculo.findUnique({
      where: { id }
    })

    if (!vehiculo) {
      return NextResponse.json(
        { success: false, error: 'Vehículo no encontrado' },
        { status: 404 }
      )
    }

    console.log('✅ Vehículo encontrado:', vehiculo.marca, vehiculo.modelo)

    // Crear las imágenes una por una con logs
    const imagenesCreadas = []
    for (const img of imagenes) {
      console.log('➕ Creando imagen:', img)
      const imagenCreada = await prisma.imagen.create({
        data: {
          url: img.url,
          orden: img.orden,
          vehiculoId: id
        }
      })
      imagenesCreadas.push(imagenCreada)
      console.log('✅ Imagen creada:', imagenCreada.id)
    }

    console.log(`✅ ${imagenesCreadas.length} imágenes agregadas al vehículo ${id}`)

    return NextResponse.json({
      success: true,
      imagenes: imagenesCreadas,
      count: imagenesCreadas.length
    })

  } catch (error) {
    console.error('❌ Error completo:', error)
    return NextResponse.json(
      { success: false, error: error.message },
      { status: 500 }
    )
  }
}
</file>

<file path="src/app/catalogo/page.jsx">

</file>

<file path="src/app/globals.css">
@import "tailwindcss";

:root {
  --background: #ffffff;
  --foreground: #171717;
}

@theme inline {
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --font-sans: var(--font-geist-sans);
  --font-mono: var(--font-geist-mono);
}

@media (prefers-color-scheme: dark) {
  :root {
    --background: #0a0a0a;
    --foreground: #ededed;
  }
}

body {
  background: var(--background);
  color: var(--foreground);
  font-family: Arial, Helvetica, sans-serif;
}
</file>

<file path="src/app/layout.js">
import { Geist, Geist_Mono } from "next/font/google";
import "./globals.css";

const geistSans = Geist({
  variable: "--font-geist-sans",
  subsets: ["latin"],
});

const geistMono = Geist_Mono({
  variable: "--font-geist-mono",
  subsets: ["latin"],
});

export const metadata = {
  title: "Create Next App",
  description: "Generated by create next app",
};

export default function RootLayout({ children }) {
  return (
    <html lang="en">
      <body
        className={`${geistSans.variable} ${geistMono.variable} antialiased`}
      >
        {children}
      </body>
    </html>
  );
}
</file>

<file path="src/lib/auth.js">
// src/lib/auth.js

import bcrypt from 'bcrypt'
import jwt from 'jsonwebtoken'

/* ========================================
   CONFIGURACIÓN
======================================== */

// En producción, esto debe estar en .env
const JWT_SECRET = process.env.JWT_SECRET || 'tu-secreto-super-seguro-cambialo-en-produccion'
const SALT_ROUNDS = 10

/* ========================================
   FUNCIONES DE HASHING
======================================== */

/**
 * Hashear una contraseña
 */
export async function hashPassword(password) {
  try {
    const hash = await bcrypt.hash(password, SALT_ROUNDS)
    return hash
  } catch (error) {
    console.error('❌ Error al hashear contraseña:', error)
    throw new Error('Error al procesar la contraseña')
  }
}

/**
 * Comparar contraseña con hash
 */
export async function comparePassword(password, hash) {
  try {
    const match = await bcrypt.compare(password, hash)
    return match
  } catch (error) {
    console.error('❌ Error al comparar contraseña:', error)
    throw new Error('Error al verificar la contraseña')
  }
}

/* ========================================
   FUNCIONES DE JWT
======================================== */

/**
 * Generar token JWT
 */
export function generateToken(payload) {
  try {
    const token = jwt.sign(
      payload,
      JWT_SECRET,
      { 
        expiresIn: '7d' // Token válido por 7 días
      }
    )
    return token
  } catch (error) {
    console.error('❌ Error al generar token:', error)
    throw new Error('Error al generar token de autenticación')
  }
}

/**
 * Verificar token JWT
 */
export function verifyToken(token) {
  try {
    const decoded = jwt.verify(token, JWT_SECRET)
    return decoded
  } catch (error) {
    if (error.name === 'TokenExpiredError') {
      throw new Error('Token expirado')
    }
    if (error.name === 'JsonWebTokenError') {
      throw new Error('Token inválido')
    }
    throw new Error('Error al verificar token')
  }
}

/**
 * Extraer token del header Authorization
 */
export function extractTokenFromHeader(authHeader) {
  if (!authHeader || !authHeader.startsWith('Bearer ')) {
    return null
  }
  
  return authHeader.substring(7) // Remueve "Bearer "
}
</file>

<file path="src/lib/cloudinary.js">
// src/lib/cloudinary.js

import { v2 as cloudinary } from 'cloudinary'

// Configurar Cloudinary
cloudinary.config({
  cloud_name: process.env.CLOUDINARY_CLOUD_NAME,
  api_key: process.env.CLOUDINARY_API_KEY,
  api_secret: process.env.CLOUDINARY_API_SECRET
})

/**
 * Subir imagen a Cloudinary
 */
export async function uploadImage(base64Image, folder = 'automotora') {
  try {
    const result = await cloudinary.uploader.upload(base64Image, {
      folder: folder,
      resource_type: 'auto',
      transformation: [
        { width: 1200, height: 900, crop: 'limit' },
        { quality: 'auto:good' }
      ]
    })

    return {
      url: result.secure_url,
      publicId: result.public_id,
      width: result.width,
      height: result.height
    }
  } catch (error) {
    console.error('❌ Error subiendo imagen:', error)
    throw new Error('Error al subir la imagen')
  }
}

/**
 * Eliminar imagen de Cloudinary
 */
export async function deleteImage(publicId) {
  try {
    const result = await cloudinary.uploader.destroy(publicId)
    return result
  } catch (error) {
    console.error('❌ Error eliminando imagen:', error)
    throw new Error('Error al eliminar la imagen')
  }
}

export default cloudinary
</file>

<file path="src/lib/prisma.js">
// src/lib/prisma.js

import { PrismaClient } from '@prisma/client'

const prisma = global.prisma || new PrismaClient()

if (process.env.NODE_ENV !== 'production') {
  global.prisma = prisma
}

export default prisma
</file>

<file path="src/proxy.js">
// src/middleware.js

import { NextResponse } from 'next/server'
import { verifyToken, extractTokenFromHeader } from './lib/auth.js'

/* ========================================
   RUTAS PROTEGIDAS
======================================== */

// Rutas que requieren autenticación
const RUTAS_PROTEGIDAS = [
  '/api/vehiculos', // POST, PUT, DELETE (GET es público)
  '/api/consultas', // Todas las operaciones (admin)
]

// Métodos que requieren autenticación por ruta
const METODOS_PROTEGIDOS = {
  '/api/vehiculos': ['POST', 'PUT', 'DELETE'],
  '/api/consultas': ['GET', 'PUT', 'DELETE'], // POST es público (clientes)
}

/* ========================================
   MIDDLEWARE
======================================== */

export default function proxy(request) {
  const { pathname } = request.nextUrl
  const method = request.method

  // Verificar si la ruta necesita protección
  const rutaProtegida = RUTAS_PROTEGIDAS.find(ruta => pathname.startsWith(ruta))
  
  if (!rutaProtegida) {
    // Ruta no protegida, continuar
    return NextResponse.next()
  }

  // Verificar si el método específico necesita autenticación
  const metodosProtegidos = METODOS_PROTEGIDOS[rutaProtegida]
  if (metodosProtegidos && !metodosProtegidos.includes(method)) {
    // Método no protegido en esta ruta, continuar
    return NextResponse.next()
  }

  // Extraer token del header Authorization
  const authHeader = request.headers.get('Authorization')
  const token = extractTokenFromHeader(authHeader)

  if (!token) {
    return NextResponse.json(
      { 
        success: false, 
        error: 'No autorizado. Token requerido.' 
      },
      { status: 401 }
    )
  }

  // Verificar token
  try {
    const decoded = verifyToken(token)
    
    // Token válido, agregar info del usuario al request
    const requestHeaders = new Headers(request.headers)
    requestHeaders.set('X-User-Id', decoded.userId)
    requestHeaders.set('X-User-Email', decoded.email)
    requestHeaders.set('X-User-Rol', decoded.rol)

    console.log(`✅ Usuario autenticado: ${decoded.email} (${decoded.rol})`)

    return NextResponse.next({
      request: {
        headers: requestHeaders,
      },
    })

  } catch (error) {
    console.error('❌ Error al verificar token:', error.message)
    
    return NextResponse.json(
      { 
        success: false, 
        error: error.message || 'Token inválido' 
      },
      { status: 401 }
    )
  }
}

/* ========================================
   CONFIGURACIÓN
======================================== */

export const config = {
  matcher: [
    '/api/vehiculos/:path*',
    '/api/consultas/:path*',
  ]
}
</file>

<file path="eslint.config.mjs">
import { defineConfig, globalIgnores } from "eslint/config";
import nextVitals from "eslint-config-next/core-web-vitals";

const eslintConfig = defineConfig([
  ...nextVitals,
  // Override default ignores of eslint-config-next.
  globalIgnores([
    // Default ignores of eslint-config-next:
    ".next/**",
    "out/**",
    "build/**",
    "next-env.d.ts",
  ]),
]);

export default eslintConfig;
</file>

<file path="jsconfig.json">
{
  "compilerOptions": {
    "paths": {
      "@/*": ["./src/*"]
    }
  }
}
</file>

<file path="next.config.mjs">
/** @type {import('next').NextConfig} */
const nextConfig = {
  /* config options here */
  reactCompiler: true,
};

export default nextConfig;
</file>

<file path="postcss.config.mjs">
const config = {
  plugins: {
    "@tailwindcss/postcss": {},
  },
};

export default config;
</file>

<file path="README.md">
This is a [Next.js](https://nextjs.org) project bootstrapped with [`create-next-app`](https://github.com/vercel/next.js/tree/canary/packages/create-next-app).

## Getting Started

First, run the development server:

```bash
npm run dev
# or
yarn dev
# or
pnpm dev
# or
bun dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

You can start editing the page by modifying `app/page.js`. The page auto-updates as you edit the file.

This project uses [`next/font`](https://nextjs.org/docs/app/building-your-application/optimizing/fonts) to automatically optimize and load [Geist](https://vercel.com/font), a new font family for Vercel.

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!

## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/app/building-your-application/deploying) for more details.
</file>

<file path="prisma/schema.prisma">
// schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Usuario {
  id        String   @id @default(cuid())
  email     String   @unique
  nombre    String
  password  String
  rol       Rol      @default(VENDEDOR)
  activo    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum Rol {
  ADMIN
  VENDEDOR
}

model Vehiculo {
  id              String         @id @default(cuid())
  marca           String
  modelo          String
  anio            Int
  precio          Decimal        @db.Decimal(10, 2)
  kilometraje     Int
  combustible     TipoCombustible
  transmision     TipoTransmision
  color           String
  puertas         Int
  motor           String?
  descripcion     String?        @db.Text
  estado          EstadoVehiculo @default(DISPONIBLE)
  destacado       Boolean        @default(false)
  imagenes        Imagen[]
  caracteristicas Caracteristica[]
  consultas       Consulta[]
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
}

enum TipoCombustible {
  NAFTA
  DIESEL
  ELECTRICO
  HIBRIDO
  GNC
}

enum TipoTransmision {
  MANUAL
  AUTOMATICA
  SECUENCIAL
}

enum EstadoVehiculo {
  DISPONIBLE
  RESERVADO
  VENDIDO
}

model Imagen {
  id         String   @id @default(cuid())
  url        String
  vehiculoId String
  vehiculo   Vehiculo @relation(fields: [vehiculoId], references: [id], onDelete: Cascade)
  orden      Int      @default(0)
  createdAt  DateTime @default(now())
}

model Caracteristica {
  id         String   @id @default(cuid())
  nombre     String   // "ABS", "Airbags", "Aire acondicionado", etc.
  vehiculoId String
  vehiculo   Vehiculo @relation(fields: [vehiculoId], references: [id], onDelete: Cascade)
}

model Consulta {
  id         String        @id @default(cuid())
  nombre     String
  email      String
  telefono   String
  mensaje    String        @db.Text
  vehiculoId String?
  vehiculo   Vehiculo?     @relation(fields: [vehiculoId], references: [id])
  estado     EstadoConsulta @default(PENDIENTE)
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
}

enum EstadoConsulta {
  PENDIENTE
  CONTACTADO
  CERRADO
}
</file>

<file path="src/app/admin/vehiculos/[id]/imagenes/page.jsx">
'use client'

import { useState, useEffect } from 'react'
import { useRouter, useParams } from 'next/navigation'

export default function ImagenesVehiculoPage() {
  const router = useRouter()
  const params = useParams()
  const [vehiculo, setVehiculo] = useState(null)
  const [loading, setLoading] = useState(true)
  const [uploading, setUploading] = useState(false)
  const [selectedFiles, setSelectedFiles] = useState([])
  const [previews, setPreviews] = useState([])
  const [error, setError] = useState('')

  useEffect(() => {
    cargarVehiculo()
  }, [])

  const cargarVehiculo = async () => {
    try {
      const res = await fetch(`/api/vehiculos/${params.id}`)
      const data = await res.json()

      if (data.success) {
        setVehiculo(data.vehiculo)
      } else {
        setError('No se pudo cargar el vehículo')
      }
    } catch (err) {
      setError('Error de conexión')
    } finally {
      setLoading(false)
    }
  }

  const handleFileSelect = (e) => {
    const files = Array.from(e.target.files)
    
    if (files.length > 10) {
      alert('Máximo 10 imágenes por vez')
      return
    }

    setSelectedFiles(files)

    // Crear previews
    const newPreviews = files.map(file => URL.createObjectURL(file))
    setPreviews(newPreviews)
  }

  const convertToBase64 = (file) => {
    return new Promise((resolve, reject) => {
      const reader = new FileReader()
      reader.readAsDataURL(file)
      reader.onload = () => resolve(reader.result)
      reader.onerror = (error) => reject(error)
    })
  }

  const handleUpload = async () => {
    if (selectedFiles.length === 0) {
      alert('Seleccioná al menos una imagen')
      return
    }

    setUploading(true)
    setError('')

    try {
      // Convertir todas las imágenes a base64
      const base64Images = await Promise.all(
        selectedFiles.map(file => convertToBase64(file))
      )

      // Subir a Cloudinary
      const token = localStorage.getItem('token')
      const resUpload = await fetch('/api/upload', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ images: base64Images })
      })

      const dataUpload = await resUpload.json()

      if (!dataUpload.success) {
        throw new Error(dataUpload.error || 'Error al subir imágenes')
      }

      // Asociar imágenes al vehículo
      const resAsociar = await fetch(`/api/vehiculos/${params.id}/imagenes`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
          imagenes: dataUpload.images.map((img, index) => ({
            url: img.url,
            orden: (vehiculo?.imagenes?.length || 0) + index
          }))
        })
      })

      const dataAsociar = await resAsociar.json()

      if (dataAsociar.success) {
        alert(`✅ ${dataUpload.images.length} imágenes agregadas exitosamente`)
        setSelectedFiles([])
        setPreviews([])
        cargarVehiculo()
      } else {
        throw new Error(dataAsociar.error || 'Error al asociar imágenes')
      }
    } catch (err) {
      setError('Error: ' + err.message)
      alert('❌ ' + err.message)
    } finally {
      setUploading(false)
    }
  }

  const handleEliminarImagen = async (imagenId) => {
    if (!confirm('¿Eliminar esta imagen?')) return

    try {
      const token = localStorage.getItem('token')
      const res = await fetch(`/api/vehiculos/${params.id}/imagenes/${imagenId}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
      })

      const data = await res.json()

      if (data.success) {
        alert('✅ Imagen eliminada')
        cargarVehiculo()
      } else {
        alert('❌ Error: ' + data.error)
      }
    } catch (err) {
      alert('❌ Error al eliminar')
    }
  }

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-xl">Cargando...</div>
      </div>
    )
  }

  return (
    <div className="min-h-screen bg-gray-100">
      <header className="bg-white shadow">
        <div className="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
          <div>
            <h1 className="text-2xl font-bold">📸 Imágenes del Vehículo</h1>
            {vehiculo && (
              <p className="text-gray-600 text-sm mt-1">
                {vehiculo.marca} {vehiculo.modelo} {vehiculo.anio}
              </p>
            )}
          </div>
          <button
            onClick={() => router.push('/admin/dashboard')}
            className="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700"
          >
            ← Volver
          </button>
        </div>
      </header>

      <main className="max-w-7xl mx-auto px-4 py-8">
        {/* Imágenes actuales */}
        <div className="bg-white rounded-lg shadow p-6 mb-6">
          <h2 className="text-xl font-bold mb-4">
            Imágenes Actuales ({vehiculo?.imagenes?.length || 0})
          </h2>
          
          {vehiculo?.imagenes?.length === 0 ? (
            <p className="text-gray-500">No hay imágenes todavía</p>
          ) : (
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
              {vehiculo.imagenes.map((imagen, index) => (
                <div key={imagen.id} className="relative group">
                  <img
                    src={imagen.url}
                    alt={`Imagen ${index + 1}`}
                    className="w-full h-48 object-cover rounded"
                  />
                  <div className="absolute top-2 right-2">
                    <button
                      onClick={() => handleEliminarImagen(imagen.id)}
                      className="bg-red-600 text-white px-2 py-1 rounded text-sm hover:bg-red-700 opacity-0 group-hover:opacity-100 transition"
                    >
                      🗑️
                    </button>
                  </div>
                  <div className="absolute bottom-2 left-2 bg-black bg-opacity-50 text-white px-2 py-1 rounded text-xs">
                    Orden: {imagen.orden}
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>

        {/* Subir nuevas imágenes */}
        <div className="bg-white rounded-lg shadow p-6">
          <h2 className="text-xl font-bold mb-4">Agregar Nuevas Imágenes</h2>

          {error && (
            <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
              {error}
            </div>
          )}

          <div className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Seleccionar imágenes (máximo 10)
              </label>
              <input
                type="file"
                accept="image/*"
                multiple
                onChange={handleFileSelect}
                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
              <p className="text-xs text-gray-500 mt-1">
                Formatos: JPG, PNG, WEBP • Tamaño máximo: 5MB por imagen
              </p>
            </div>

            {/* Previews */}
            {previews.length > 0 && (
              <div>
                <h3 className="font-semibold mb-2">Vista previa ({previews.length})</h3>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                  {previews.map((preview, index) => (
                    <img
                      key={index}
                      src={preview}
                      alt={`Preview ${index + 1}`}
                      className="w-full h-48 object-cover rounded border-2 border-blue-500"
                    />
                  ))}
                </div>
              </div>
            )}

            <button
              onClick={handleUpload}
              disabled={uploading || selectedFiles.length === 0}
              className="w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition font-semibold"
            >
              {uploading ? 'Subiendo...' : `📤 Subir ${selectedFiles.length} imagen(es)`}
            </button>
          </div>
        </div>
      </main>
    </div>
  )
}
</file>

<file path="src/app/api/auth/login/route.js">
// src/app/api/auth/login/route.js

import prisma from '../../../../lib/prisma.js'
import { comparePassword, generateToken } from '../../../../lib/auth.js'

/* ========================================
   POST - Login de usuario
======================================== */
export async function POST(request) {
  try {
    const { email, password } = await request.json()

    // Validar que se proporcionaron email y contraseña
    if (!email || !password) {
      return Response.json(
        { 
          success: false, 
          error: 'Email y contraseña son requeridos' 
        },
        { status: 400 }
      )
    }

    // Buscar usuario por email
    const usuario = await prisma.usuario.findUnique({
      where: { email: email.toLowerCase().trim() }
    })

    // Si no existe el usuario
    if (!usuario) {
      return Response.json(
        { 
          success: false, 
          error: 'Credenciales inválidas' 
        },
        { status: 401 }
      )
    }

    // Verificar que el usuario está activo
    if (!usuario.activo) {
      return Response.json(
        { 
          success: false, 
          error: 'Usuario desactivado. Contacte al administrador.' 
        },
        { status: 403 }
      )
    }

    // Comparar contraseña
    const passwordValida = await comparePassword(password, usuario.password)

    if (!passwordValida) {
      return Response.json(
        { 
          success: false, 
          error: 'Credenciales inválidas' 
        },
        { status: 401 }
      )
    }

    // Generar token JWT
    const token = generateToken({
      userId: usuario.id,
      email: usuario.email,
      rol: usuario.rol
    })

    // Datos del usuario (sin contraseña)
    const usuarioSinPassword = {
      id: usuario.id,
      email: usuario.email,
      nombre: usuario.nombre,
      rol: usuario.rol,
      activo: usuario.activo
    }

    console.log(`✅ Login exitoso: ${usuario.email}`)

    // Respuesta exitosa
    return Response.json({
      success: true,
      message: 'Login exitoso',
      token: token,
      usuario: usuarioSinPassword
    })

  } catch (error) {
    console.error('❌ Error en login:', error)

    return Response.json(
      { 
        success: false, 
        error: 'Error en el servidor' 
      },
      { status: 500 }
    )
  }
}
</file>

<file path="src/app/api/consultas/route.js">
// src/app/api/consultas/route.js

import prisma from '../../../lib/prisma.js'

/* ========================================
   FUNCIONES AUXILIARES
======================================== */

const estadosValidos = ["PENDIENTE", "CONTACTADO", "CERRADO"]

function validarConsulta(datos) {
  const { nombre, email, telefono, mensaje } = datos
  const errores = []

  if (!nombre?.trim()) {
    errores.push("El nombre es obligatorio")
  }

  if (!email?.trim()) {
    errores.push("El email es obligatorio")
  } else {
    // Validación básica de email
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/
    if (!emailRegex.test(email)) {
      errores.push("El email no es válido")
    }
  }

  if (!telefono?.trim()) {
    errores.push("El teléfono es obligatorio")
  }

  if (!mensaje?.trim()) {
    errores.push("El mensaje es obligatorio")
  } else if (mensaje.trim().length < 10) {
    errores.push("El mensaje debe tener al menos 10 caracteres")
  }

  return errores.length > 0 ? errores : null
}

/* ========================================
   GET - Obtener todas las consultas
======================================== */
export async function GET(request) {
  try {
    const { searchParams } = new URL(request.url)
    const estado = searchParams.get('estado')
    const vehiculoId = searchParams.get('vehiculoId')

    // Construir filtros
    const where = {}
    
    if (estado && estadosValidos.includes(estado)) {
      where.estado = estado
    }
    
    if (vehiculoId) {
      where.vehiculoId = vehiculoId
    }

    const consultas = await prisma.consulta.findMany({
      where,
      include: {
        vehiculo: {
          select: {
            id: true,
            marca: true,
            modelo: true,
            anio: true,
            precio: true
          }
        }
      },
      orderBy: {
        createdAt: 'desc' // Más recientes primero
      }
    })

    return Response.json({
      success: true,
      count: consultas.length,
      consultas: consultas
    })

  } catch (error) {
    console.error("❌ Error en GET consultas:", error)

    return Response.json(
      { success: false, error: error.message },
      { status: 500 }
    )
  }
}

/* ========================================
   POST - Crear nueva consulta
======================================== */
export async function POST(request) {
  try {
    const datos = await request.json()

    // Validar datos
    const erroresValidacion = validarConsulta(datos)
    if (erroresValidacion) {
      return Response.json(
        { success: false, errors: erroresValidacion },
        { status: 400 }
      )
    }

    // Si se proporciona vehiculoId, verificar que existe
    if (datos.vehiculoId) {
      const vehiculoExiste = await prisma.vehiculo.findUnique({
        where: { id: datos.vehiculoId }
      })

      if (!vehiculoExiste) {
        return Response.json(
          { success: false, error: "El vehículo especificado no existe" },
          { status: 404 }
        )
      }
    }

    // Crear consulta
    const nuevaConsulta = await prisma.consulta.create({
      data: {
        nombre: datos.nombre.trim(),
        email: datos.email.trim().toLowerCase(),
        telefono: datos.telefono.trim(),
        mensaje: datos.mensaje.trim(),
        vehiculoId: datos.vehiculoId || null,
        estado: 'PENDIENTE'
      },
      include: {
        vehiculo: {
          select: {
            id: true,
            marca: true,
            modelo: true,
            anio: true
          }
        }
      }
    })

    console.log(`✅ Nueva consulta recibida de ${nuevaConsulta.nombre}`)

    return Response.json(
      {
        success: true,
        consulta: nuevaConsulta,
        mensaje: "Consulta enviada exitosamente. Nos pondremos en contacto pronto."
      },
      { status: 201 }
    )

  } catch (error) {
    console.error("❌ Error en POST consulta:", error)

    return Response.json(
      { success: false, error: error.message },
      { status: 500 }
    )
  }
}
</file>

<file path="src/app/page.js">
'use client'

import { useRouter } from 'next/navigation'

export default function Home() {
  const router = useRouter()

  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-500 to-purple-600">
      <div className="text-center text-white">
        <h1 className="text-6xl font-bold mb-4">🚗</h1>
        <h2 className="text-4xl font-bold mb-6">Sistema Automotora</h2>
        <p className="text-xl mb-8">Gestión completa de vehículos y consultas</p>
        
        <div className="space-x-4">
          <button
            onClick={() => router.push('/admin/login')}
            className="bg-white text-blue-600 px-8 py-3 rounded-lg font-semibold hover:bg-gray-100 transition"
          >
            Acceso Administradores
          </button>
          <button
            onClick={() => router.push('/catalogo')}
            className="bg-transparent border-2 border-white text-white px-8 py-3 rounded-lg font-semibold hover:bg-white hover:text-blue-600 transition"
          >
            Ver Catálogo
          </button>
        </div>

        <div className="mt-12 text-sm opacity-75">
          <p>Backend: Next.js + PostgreSQL + Prisma</p>
          <p>Upload: Cloudinary | Auth: JWT</p>
        </div>
      </div>
    </div>
  )
}
</file>

<file path=".gitignore">
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.*
.yarn/*
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/versions

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*

# env files (can opt-in for committing if needed)
.env*

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts

/src/generated/prisma
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": false,
    "noEmit": true,
    "incremental": true,
    "module": "esnext",
    "esModuleInterop": true,
    "moduleResolution": "node",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",

    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"]
    },

    "plugins": [
      {
        "name": "next"
      }
    ]
  },
  "include": [
    "next-env.d.ts",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts",
    "**/*.mts",
    "**/*.ts",
    "**/*.tsx"
  ],
  "exclude": ["node_modules"]
}
</file>

<file path="src/app/api/vehiculos/[id]/imagenes/[imagenId]/route.js">
// src/app/api/vehiculos/[id]/imagenes/[imagenId]/route.js

import { NextResponse } from 'next/server'
import prisma from '@/lib/prisma'
import { deleteImage } from '@/lib/cloudinary'
import { verifyToken, extractTokenFromHeader } from '@/lib/auth'

/**
 * DELETE /api/vehiculos/[id]/imagenes/[imagenId]
 * Eliminar una imagen específica de un vehículo
 * 
 * Requiere: Autenticación (ADMIN o VENDEDOR)
 * 
 * Proceso:
 * 1. Verificar autenticación
 * 2. Validar que la imagen existe
 * 3. Validar que pertenece al vehículo correcto
 * 4. Eliminar de Cloudinary
 * 5. Eliminar de la base de datos
 */
export async function DELETE(request, { params }) {
  try {
    // 1. Verificar autenticación
    const authHeader = request.headers.get('Authorization')
    const token = extractTokenFromHeader(authHeader)

    if (!token) {
      return NextResponse.json(
        { success: false, error: 'No autorizado' },
        { status: 401 }
      )
    }

    try {
      verifyToken(token)
    } catch (error) {
      return NextResponse.json(
        { success: false, error: 'Token inválido' },
        { status: 401 }
      )
    }

    // 2. Obtener parámetros
    // 2. Obtener parámetros
  const { id: vehiculoId, imagenId } = await params

  console.log('PARAMS:', { vehiculoId, imagenId })

  if (!vehiculoId || !imagenId) {
    return NextResponse.json(
      { success: false, error: 'Parámetros inválidos' },
      { status: 400 }
    )
}


    // 3. Verificar que el vehículo existe
    const vehiculo = await prisma.vehiculo.findUnique({
      where: { id: vehiculoId },
      include: { imagenes: true }
    })

    if (!vehiculo) {
      return NextResponse.json(
        { success: false, error: 'Vehículo no encontrado' },
        { status: 404 }
      )
    }

    // 4. Buscar la imagen
    const imagen = await prisma.imagen.findUnique({
      where: { id: imagenId }
    })

    if (!imagen) {
      return NextResponse.json(
        { success: false, error: 'Imagen no encontrada' },
        { status: 404 }
      )
    }

    // 5. Verificar que la imagen pertenece al vehículo correcto
    if (imagen.vehiculoId !== vehiculoId) {
      return NextResponse.json(
        { 
          success: false, 
          error: 'La imagen no pertenece a este vehículo' 
        },
        { status: 400 }
      )
    }

    // 6. Prevenir eliminar la última imagen (opcional - puedes comentar esto)
    if (vehiculo.imagenes.length === 1) {
      return NextResponse.json(
        { 
          success: false, 
          error: 'No podés eliminar la última imagen del vehículo' 
        },
        { status: 400 }
      )
    }

    // 7. Extraer el publicId de Cloudinary de la URL
    // URL formato: https://res.cloudinary.com/xxx/image/upload/v123/automotora/abc123.jpg
    let publicId = null
    try {
      const urlParts = imagen.url.split('/')
      const uploadIndex = urlParts.findIndex(part => part === 'upload')
      
      if (uploadIndex !== -1) {
        // Obtener todo después de /upload/vXXX/
        const pathAfterUpload = urlParts.slice(uploadIndex + 2).join('/')
        // Remover extensión
        publicId = pathAfterUpload.substring(0, pathAfterUpload.lastIndexOf('.'))
      }
    } catch (parseError) {
      console.warn('⚠️ No se pudo parsear URL de Cloudinary:', parseError)
    }

    // 8. Intentar eliminar de Cloudinary
    if (publicId) {
      try {
        await deleteImage(publicId)
        console.log('✅ Imagen eliminada de Cloudinary:', publicId)
      } catch (cloudinaryError) {
        console.error('⚠️ Error al eliminar de Cloudinary:', cloudinaryError)
        // Continuar aunque falle Cloudinary (la imagen en BD se elimina igual)
      }
    }

    // 9. Eliminar de la base de datos
    await prisma.imagen.delete({
      where: { id: imagenId }
    })

    console.log(`✅ Imagen ${imagenId} eliminada del vehículo ${vehiculoId}`)

    return NextResponse.json({
      success: true,
      message: 'Imagen eliminada exitosamente',
      imagenesRestantes: vehiculo.imagenes.length - 1
    })

  } catch (error) {
    console.error('❌ Error al eliminar imagen:', error)
    return NextResponse.json(
      { 
        success: false, 
        error: 'Error interno del servidor',
        details: process.env.NODE_ENV === 'development' ? error.message : undefined
      },
      { status: 500 }
    )
  }
}
</file>

<file path="src/app/api/vehiculos/[id]/route.js">
// src/app/api/vehiculos/[id]/route.js

import prisma from '@/lib/prisma'

/* ========================================
   FUNCIONES AUXILIARES
======================================== */

const combustiblesValidos = ["NAFTA", "DIESEL", "ELECTRICO", "HIBRIDO", "GNC"]
const transmisionesValidas = ["MANUAL", "AUTOMATICA", "SECUENCIAL"]
const estadosValidos = ["DISPONIBLE", "RESERVADO", "VENDIDO"]

function formatearVehiculo(vehiculo) {
  return {
    ...vehiculo,
    precio: Number(vehiculo.precio)
  }
}

function validarDatosActualizacion(datos) {
  const errores = []

  if (datos.marca !== undefined && !datos.marca?.trim()) {
    errores.push("La marca no puede estar vacía")
  }

  if (datos.modelo !== undefined && !datos.modelo?.trim()) {
    errores.push("El modelo no puede estar vacío")
  }

  if (datos.anio !== undefined) {
    const anio = Number(datos.anio)
    if (anio < 1900 || anio > new Date().getFullYear() + 1) {
      errores.push("Año inválido")
    }
  }

  if (datos.precio !== undefined) {
    const precio = Number(datos.precio)
    if (precio <= 0) {
      errores.push("El precio debe ser mayor a 0")
    }
  }

  if (datos.kilometraje !== undefined) {
    const km = Number(datos.kilometraje)
    if (km < 0) {
      errores.push("El kilometraje no puede ser negativo")
    }
  }

  if (datos.puertas !== undefined) {
    const puertas = Number(datos.puertas)
    if (puertas <= 0) {
      errores.push("La cantidad de puertas debe ser mayor a 0")
    }
  }

  if (datos.combustible && !combustiblesValidos.includes(datos.combustible)) {
    errores.push(`Combustible inválido. Opciones: ${combustiblesValidos.join(', ')}`)
  }

  if (datos.transmision && !transmisionesValidas.includes(datos.transmision)) {
    errores.push(`Transmisión inválida. Opciones: ${transmisionesValidas.join(', ')}`)
  }

  if (datos.estado && !estadosValidos.includes(datos.estado)) {
    errores.push(`Estado inválido. Opciones: ${estadosValidos.join(', ')}`)
  }

  return errores.length > 0 ? errores : null
}

function extraerIdDeUrl(request) {
  const pathname = request.nextUrl.pathname
  return pathname.split("/").pop()
}

/* ========================================
   GET - Obtener un vehículo por ID
======================================== */
export async function GET(request) {
  try {
    const id = extraerIdDeUrl(request)

    if (!id) {
      return Response.json(
        { success: false, error: "ID no proporcionado" },
        { status: 400 }
      )
    }

    const vehiculo = await prisma.vehiculo.findUnique({
      where: { id },
      include: {
        imagenes: {
          orderBy: { orden: "asc" }
        },
        caracteristicas: true,
        consultas: true
      }
    })

    if (!vehiculo) {
      return Response.json(
        { success: false, error: "Vehículo no encontrado" },
        { status: 404 }
      )
    }

    return Response.json({
      success: true,
      vehiculo: formatearVehiculo(vehiculo)
    })

  } catch (error) {
    console.error("❌ Error en GET por ID:", error)

    return Response.json(
      { success: false, error: error.message },
      { status: 500 }
    )
  }
}

/* ========================================
   PUT - Actualizar un vehículo
======================================== */
export async function PUT(request) {
  try {
    const id = extraerIdDeUrl(request)

    if (!id) {
      return Response.json(
        { success: false, error: "ID no proporcionado" },
        { status: 400 }
      )
    }

    const datos = await request.json()

    // Validar que el vehículo existe
    const vehiculoExistente = await prisma.vehiculo.findUnique({
      where: { id }
    })

    if (!vehiculoExistente) {
      return Response.json(
        { success: false, error: "Vehículo no encontrado" },
        { status: 404 }
      )
    }

    // Validar datos
    const erroresValidacion = validarDatosActualizacion(datos)
    if (erroresValidacion) {
      return Response.json(
        { success: false, errors: erroresValidacion },
        { status: 400 }
      )
    }

    // Preparar datos para actualizar
    const datosActualizacion = {}

    // Campos de texto
    if (datos.marca !== undefined) datosActualizacion.marca = datos.marca.trim()
    if (datos.modelo !== undefined) datosActualizacion.modelo = datos.modelo.trim()
    if (datos.color !== undefined) datosActualizacion.color = datos.color.trim()
    if (datos.motor !== undefined) datosActualizacion.motor = datos.motor?.trim() || null
    if (datos.descripcion !== undefined) datosActualizacion.descripcion = datos.descripcion?.trim() || null

    // Campos numéricos
    if (datos.anio !== undefined) datosActualizacion.anio = Number(datos.anio)
    if (datos.precio !== undefined) datosActualizacion.precio = Number(datos.precio)
    if (datos.kilometraje !== undefined) datosActualizacion.kilometraje = Number(datos.kilometraje)
    if (datos.puertas !== undefined) datosActualizacion.puertas = Number(datos.puertas)

    // Enums
    if (datos.combustible !== undefined) datosActualizacion.combustible = datos.combustible
    if (datos.transmision !== undefined) datosActualizacion.transmision = datos.transmision
    if (datos.estado !== undefined) datosActualizacion.estado = datos.estado

    // Booleanos
    if (datos.destacado !== undefined) datosActualizacion.destacado = Boolean(datos.destacado)

    // Actualizar vehículo
    const vehiculoActualizado = await prisma.vehiculo.update({
      where: { id },
      data: datosActualizacion,
      include: {
        imagenes: {
          orderBy: { orden: "asc" }
        },
        caracteristicas: true
      }
    })

    console.log(`✅ Vehículo ${id} actualizado exitosamente`)

    return Response.json({
      success: true,
      vehiculo: formatearVehiculo(vehiculoActualizado),
      mensaje: "Vehículo actualizado exitosamente"
    })

  } catch (error) {
    console.error("❌ Error en PUT:", error)

    return Response.json(
      { success: false, error: error.message },
      { status: 500 }
    )
  }
}

/* ========================================
   DELETE - Eliminar un vehículo
======================================== */
export async function DELETE(request) {
  try {
    const id = extraerIdDeUrl(request)

    if (!id) {
      return Response.json(
        { success: false, error: "ID no proporcionado" },
        { status: 400 }
      )
    }

    // Verificar que el vehículo existe
    const vehiculoExistente = await prisma.vehiculo.findUnique({
      where: { id },
      include: {
        imagenes: true,
        caracteristicas: true,
        consultas: true
      }
    })

    if (!vehiculoExistente) {
      return Response.json(
        { success: false, error: "Vehículo no encontrado" },
        { status: 404 }
      )
    }

    // Eliminar vehículo (las imágenes y características se eliminan automáticamente por CASCADE)
    await prisma.vehiculo.delete({
      where: { id }
    })

    console.log(`🗑️  Vehículo ${id} eliminado exitosamente`)

    return Response.json({
      success: true,
      mensaje: "Vehículo eliminado exitosamente",
      vehiculoEliminado: {
        id: vehiculoExistente.id,
        marca: vehiculoExistente.marca,
        modelo: vehiculoExistente.modelo
      }
    })

  } catch (error) {
    console.error("❌ Error en DELETE:", error)

    // Error específico si hay consultas relacionadas
    if (error.code === 'P2003') {
      return Response.json(
        { 
          success: false, 
          error: "No se puede eliminar el vehículo porque tiene consultas asociadas" 
        },
        { status: 409 }
      )
    }

    return Response.json(
      { success: false, error: error.message },
      { status: 500 }
    )
  }
}
</file>

<file path="src/app/api/vehiculos/route.js">
// src/app/api/vehiculos/route.js

import prisma from '../../../lib/prisma.js'

/* ========================================
   FUNCIONES AUXILIARES
======================================== */

// Validar enums contra el schema
const combustiblesValidos = ["NAFTA", "DIESEL", "ELECTRICO", "HIBRIDO", "GNC"]
const transmisionesValidas = ["MANUAL", "AUTOMATICA", "SECUENCIAL"]

function validarVehiculo(data) {
  const {
    marca,
    modelo,
    anio,
    precio,
    kilometraje,
    combustible,
    transmision,
    color,
    puertas
  } = data

  if (!marca?.trim()) return "La marca es obligatoria"
  if (!modelo?.trim()) return "El modelo es obligatorio"
  if (!color?.trim()) return "El color es obligatorio"

  if (!anio || anio < 1900 || anio > new Date().getFullYear() + 1)
    return "Año inválido"

  if (!precio || precio <= 0)
    return "Precio inválido"

  if (kilometraje < 0)
    return "Kilometraje inválido"

  if (!puertas || puertas <= 0)
    return "Cantidad de puertas inválida"

  if (!combustiblesValidos.includes(combustible))
    return "Tipo de combustible inválido"

  if (!transmisionesValidas.includes(transmision))
    return "Tipo de transmisión inválida"

  return null
}

// Transformar Decimal a Number
function formatearVehiculo(vehiculo) {
  return {
    ...vehiculo,
    precio: Number(vehiculo.precio)
  }
}

/* ========================================
   GET - Obtener todos los vehículos
======================================== */
export async function GET() {
  try {
    const vehiculos = await prisma.vehiculo.findMany({
      include: {
        imagenes: {
          orderBy: { orden: "asc" }
        },
        caracteristicas: true
      },
      orderBy: {
        createdAt: "desc"
      }
    })

    return Response.json({
      success: true,
      count: vehiculos.length,
      vehiculos: vehiculos.map(formatearVehiculo)
    })

  } catch (error) {
    console.error("Error en GET:", error)

    return Response.json(
      { success: false, error: error.message },
      { status: 500 }
    )
  }
}

/* ========================================
   POST - Crear nuevo vehículo
======================================== */
export async function POST(request) {
  try {
    const datos = await request.json()

    // Normalizar números
    datos.anio = Number(datos.anio)
    datos.precio = Number(datos.precio)
    datos.kilometraje = Number(datos.kilometraje)
    datos.puertas = Number(datos.puertas)

    // Validación profesional
    const errorValidacion = validarVehiculo(datos)
    if (errorValidacion) {
      return Response.json(
        { success: false, error: errorValidacion },
        { status: 400 }
      )
    }

    const nuevoVehiculo = await prisma.vehiculo.create({
      data: {
        marca: datos.marca.trim(),
        modelo: datos.modelo.trim(),
        anio: datos.anio,
        precio: datos.precio,
        kilometraje: datos.kilometraje,
        combustible: datos.combustible,
        transmision: datos.transmision,
        color: datos.color.trim(),
        puertas: datos.puertas,
        motor: datos.motor || null,
        descripcion: datos.descripcion || null,
        destacado: datos.destacado ?? false,

        imagenes: datos.imagenes?.length
          ? {
              create: datos.imagenes.map((img, index) => ({
                url: img.url,
                orden: index
              }))
            }
          : undefined,

        caracteristicas: datos.caracteristicas?.length
          ? {
              create: datos.caracteristicas.map((c) => ({
                nombre: c.nombre
              }))
            }
          : undefined
      },
      include: {
        imagenes: true,
        caracteristicas: true
      }
    })

    return Response.json(
      {
        success: true,
        vehiculo: formatearVehiculo(nuevoVehiculo)
      },
      { status: 201 }
    )

  } catch (error) {
    console.error("Error en POST:", error)

    return Response.json(
      { success: false, error: error.message },
      { status: 500 }
    )
  }
}
</file>

<file path="package.json">
{
  "name": "my-app",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint"
  },
  "dependencies": {
    "@prisma/client": "^6.19.2",
    "bcrypt": "^6.0.0",
    "cloudinary": "^2.9.0",
    "jsonwebtoken": "^9.0.3",
    "next": "16.1.6",
    "prisma": "^6.19.2",
    "react": "19.2.3",
    "react-dom": "19.2.3"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4",
    "@types/node": "25.2.0",
    "@types/react": "19.2.10",
    "babel-plugin-react-compiler": "1.0.0",
    "eslint": "^9",
    "eslint-config-next": "16.1.6",
    "tailwindcss": "^4"
  }
}
</file>

</files>
